<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#fdfcfa" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">
    <title>SLEEPY | 睡眠整体ダッシュボード</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind Config - Premium Color Palette -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // SLEEPY Theme - Deep Navy & Cream (ロゴ配色ベース)
                        primary: {
                            50: '#fdf8f0',
                            100: '#f9eed9',
                            200: '#f2dbb4',
                            300: '#e8c48a',
                            400: '#dba95e',
                            500: '#c99445',  // Warm Gold (月のイメージ)
                            600: '#b07e34',
                            700: '#8f6529',
                            800: '#745122',
                            900: '#5e421e',
                        },
                        accent: {
                            50: '#f0f2f7',
                            100: '#dde2ee',
                            200: '#bcc5db',
                            300: '#92a1c2',
                            400: '#6b7fa8',
                            500: '#4d6290',
                            600: '#3b4f78',
                            700: '#2e3f62',  // Deep Navy (ロゴ背景)
                            800: '#1e2d4d',
                            900: '#162038',
                        },
                        surface: {
                            50: '#fdfcfa',
                            100: '#faf6f0',
                            200: '#f3ede3',
                            300: '#e8dfd2',
                            400: '#d4c8b6',
                            500: '#b8aa98',
                            600: '#9a8c7d',
                            700: '#7d7065',
                            800: '#635950',
                            900: '#504840',
                        },
                        // Harmonious accent colors
                        sage: {
                            400: '#8ba88e',
                            500: '#739977',  // Sage Green
                            600: '#5d7d60',
                        },
                        rose: {
                            400: '#e0b0a8',
                            500: '#d49890',  // Soft Pink (ひつじの頬)
                            600: '#c08078',
                        },
                        warmgold: {
                            400: '#e8c88a',
                            500: '#dba95e',  // Moon Gold
                            600: '#c99445',
                        },
                        // Brand colors - sleepy
                        sleepy: {
                            50: '#fdfcfa',
                            100: '#faf6f0',
                            200: '#f3ede3',
                            300: '#e8dfd2',
                            400: '#dba95e',
                            500: '#b8aa98',
                            600: '#4d6290',
                            700: '#3b4f78',
                            800: '#2e3f62',
                            900: '#1e2d4d',
                        }
                    },
                    fontFamily: {
                        display: ['"Zen Maru Gothic"', '"Hiragino Maru Gothic ProN"', 'sans-serif'],
                        sans: ['"Inter"', '-apple-system', 'BlinkMacSystemFont', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
                        'soft-lg': '0 10px 40px -10px rgba(0, 0, 0, 0.1), 0 2px 10px -2px rgba(0, 0, 0, 0.04)',
                        'glow': '0 0 20px rgba(219, 169, 94, 0.15)',
                        'glow-accent': '0 0 20px rgba(46, 63, 98, 0.2)',
                    }
                }
            }
        }
    </script>

    <!-- Placeholder Comments -->
    <!-- Update:
         1. Overview Chart now shows Unit Price (Line) and New/Existing Customers (Stacked Bar).
         2. Added 'Incentive' KPI card that appears only when a specific staff is selected.
    -->

    <style>
        /* ===== Premium Base Styles ===== */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background:
                radial-gradient(ellipse at 15% 0%, rgba(184, 149, 106, 0.06) 0%, transparent 45%),
                radial-gradient(ellipse at 85% 100%, rgba(176, 143, 138, 0.05) 0%, transparent 45%),
                radial-gradient(ellipse at 50% 50%, rgba(71, 86, 107, 0.02) 0%, transparent 60%),
                linear-gradient(180deg, #fdfcfa 0%, #faf6f0 40%, #f3ede3 100%);
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23b8956a' fill-opacity='0.02'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
            opacity: 0.4;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            height: 300px;
            max-height: 400px;
            padding: 8px;
            background: linear-gradient(145deg, rgba(255,255,255,0.5) 0%, rgba(250,249,247,0.3) 100%);
            border-radius: 16px;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            background: linear-gradient(145deg, rgba(255,255,255,0.7) 0%, rgba(250,249,247,0.5) 100%);
        }

        @media (min-width: 768px) {
            .chart-container { height: 350px; }
        }

        .dark .chart-container {
            background: linear-gradient(145deg, rgba(38, 42, 46, 0.3) 0%, rgba(30, 32, 36, 0.2) 100%);
        }

        .dark .chart-container:hover {
            background: linear-gradient(145deg, rgba(38, 42, 46, 0.5) 0%, rgba(30, 32, 36, 0.3) 100%);
        }

        /* Premium Scrollbar */
        .custom-scroll::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #d4af37, #e8c872);
            border-radius: 10px;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e9ecef; }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #d4af37, #e8c872);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover { background: #b8941d; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Splash Screen Animations */
        @keyframes splashLogoIn {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes splashTextIn {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes splashPulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        @keyframes progressBar {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        @keyframes splashFadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; visibility: hidden; }
        }

        .splash-logo {
            animation: splashLogoIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .splash-text {
            opacity: 0;
            animation: splashTextIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.3s forwards;
        }

        .splash-subtext {
            opacity: 0;
            animation: splashTextIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.5s forwards;
        }

        .splash-progress {
            animation: progressBar 2s ease-in-out forwards;
        }

        .splash-fade-out {
            animation: splashFadeOut 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .animate-fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .animate-slide-up { animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards; }

        /* Premium Form Elements */
        select:disabled {
            background-color: #f5f3f0;
            color: #a39b8b;
            cursor: not-allowed;
            border-color: #e8e6e1;
            opacity: 0.7;
        }

        select, input {
            transition: all 0.2s ease;
        }

        select:focus, input:focus {
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.15);
        }

        /* Edit Table Styles */
        .edit-input {
            width: 100%;
            min-width: 60px;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            text-align: right;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: white;
        }

        .edit-input-date {
            min-width: 68px;
            text-align: center;
        }

        .edit-input-amount {
            min-width: 80px;
        }

        .edit-input:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .edit-readonly {
            background-color: #f8f9fa;
            color: #6c757d;
            border: none;
        }

        .changed-row {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.08), rgba(212, 175, 55, 0.03)) !important;
        }

        /* Device Mode Styles */
        body.mobile-mode { font-size: 16px; }
        body.mobile-mode .kpi-grid { grid-template-columns: 1fr !important; }
        body.mobile-mode .chart-container { max-width: 100% !important; height: 250px !important; }
        body.mobile-mode h1 { font-size: 1.5rem !important; }
        body.mobile-mode h2 { font-size: 1.25rem !important; }
        body.mobile-mode h3 { font-size: 1.1rem !important; }
        body.mobile-mode .tab-btn { font-size: 0.8rem !important; padding: 0.5rem 0.25rem !important; }
        body.mobile-mode table { font-size: 0.75rem !important; }
        body.mobile-mode input, body.mobile-mode select, body.mobile-mode button { font-size: 14px !important; }

        /* Mobile Accordion Styles */
        body.mobile-mode .mobile-accordion-header {
            cursor: pointer;
            background: linear-gradient(135deg, #1a1f2e, #2d3748);
            color: white;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(26, 31, 46, 0.3);
        }

        body.mobile-mode .mobile-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        body.mobile-mode .mobile-accordion-content.open {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }

        body.pc-mode { font-size: 14px; }
        body.pc-mode .kpi-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important; }
        body.pc-mode .chart-container { max-width: 600px !important; }

        /* Premium Cards - Elegant & Harmonious */
        .premium-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.98) 0%, rgba(250,249,247,0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow:
                0 4px 32px -8px rgba(0, 0, 0, 0.06),
                0 8px 24px -12px rgba(0, 0, 0, 0.03),
                inset 0 1px 0 rgba(255,255,255,0.9);
            border: 1px solid rgba(237, 234, 229, 0.6);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .premium-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(184, 149, 106, 0.4), transparent);
        }

        .premium-card:hover {
            box-shadow:
                0 20px 60px -15px rgba(0, 0, 0, 0.1),
                0 8px 32px -8px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255,255,255,1);
            transform: translateY(-4px);
        }

        /* Gradient Backgrounds - Harmonious Colors */
        .gradient-primary {
            background: linear-gradient(135deg, #c99445 0%, #dba95e 50%, #e8c88a 100%);
            background-size: 200% 200%;
            animation: gradientShift 5s ease infinite;
            box-shadow: 0 4px 15px rgba(184, 149, 106, 0.35);
        }

        .gradient-accent {
            background: linear-gradient(135deg, #2e3f62 0%, #3b4f78 50%, #4d6290 100%);
            background-size: 200% 200%;
            animation: gradientShift 5s ease infinite;
            box-shadow: 0 4px 15px rgba(71, 86, 107, 0.35);
        }

        .gradient-surface {
            background: linear-gradient(135deg, #fdfcfa 0%, #ffffff 50%, #f3ede3 100%);
            background-size: 200% 200%;
            animation: gradientShift 5s ease infinite;
        }

        .gradient-sage {
            background: linear-gradient(135deg, #5d7d60 0%, #739977 50%, #8ba88e 100%);
            background-size: 200% 200%;
            animation: gradientShift 5s ease infinite;
            box-shadow: 0 4px 15px rgba(115, 153, 119, 0.35);
        }

        .gradient-rose {
            background: linear-gradient(135deg, #c08078 0%, #d49890 50%, #e0b0a8 100%);
            background-size: 200% 200%;
            animation: gradientShift 5s ease infinite;
            box-shadow: 0 4px 15px rgba(176, 143, 138, 0.35);
        }

        .gradient-warmgold {
            background: linear-gradient(135deg, #dba95e 0%, #e8c88a 50%, #f2dbb4 100%);
            background-size: 200% 200%;
            animation: gradientShift 5s ease infinite;
            box-shadow: 0 4px 15px rgba(201, 169, 110, 0.35);
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Icon Container Glow Effects */
        .kpi-card .rounded-lg {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .kpi-card:hover .gradient-primary {
            box-shadow: 0 6px 20px rgba(184, 149, 106, 0.45);
        }

        .kpi-card:hover .gradient-accent {
            box-shadow: 0 6px 20px rgba(71, 86, 107, 0.45);
        }

        .kpi-card:hover .gradient-sage {
            box-shadow: 0 6px 20px rgba(115, 153, 119, 0.45);
        }

        .kpi-card:hover .gradient-rose {
            box-shadow: 0 6px 20px rgba(176, 143, 138, 0.45);
        }

        .kpi-card:hover .gradient-warmgold {
            box-shadow: 0 6px 20px rgba(201, 169, 110, 0.45);
        }

        /* KPI Card Accents */
        .kpi-accent-1 { border-left: 4px solid #d4af37; }
        .kpi-accent-2 { border-left: 4px solid #1a1f2e; }
        .kpi-accent-3 { border-left: 4px solid #2d3748; }
        .kpi-accent-4 { border-left: 4px solid #e8c872; }
        .kpi-accent-5 { border-left: 4px solid #d97706; }

        /* Tab Styles - Elegant & Harmonious */
        .tab-btn {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px 12px 0 0;
            background: transparent;
            overflow: hidden;
        }

        .tab-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(184, 149, 106, 0.08) 0%, rgba(201, 168, 126, 0.04) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tab-btn:hover::before {
            opacity: 1;
        }

        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #c99445, #dba95e, #e8c88a);
            border-radius: 3px 3px 0 0;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-btn:hover::after {
            width: 60%;
        }

        .tab-btn.active {
            background: linear-gradient(180deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.04);
        }

        .tab-btn.active::after {
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #c99445, #dba95e, #e8c88a, #dba95e, #c99445);
            background-size: 200% 100%;
            animation: tabGradient 4s ease infinite;
        }

        @keyframes tabGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .tab-btn i {
            transition: all 0.3s ease;
        }

        .tab-btn:hover i {
            transform: scale(1.15);
        }

        .tab-btn.active i {
            color: #c99445;
        }

        /* Premium Buttons - Elegant & Harmonious */
        .btn-primary {
            background: linear-gradient(135deg, #c99445 0%, #dba95e 50%, #b07e34 100%);
            background-size: 200% 200%;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                0 4px 20px rgba(184, 149, 106, 0.35),
                inset 0 1px 0 rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            transition: left 0.5s ease;
        }

        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow:
                0 8px 30px rgba(184, 149, 106, 0.45),
                0 0 20px rgba(184, 149, 106, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.3);
            background-position: 100% 100%;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:active {
            transform: translateY(-1px) scale(0.98);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2e3f62 0%, #3b4f78 50%, #1e2d4d 100%);
            background-size: 200% 200%;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                0 4px 20px rgba(71, 86, 107, 0.35),
                inset 0 1px 0 rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        .btn-secondary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            transition: left 0.5s ease;
        }

        .btn-secondary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow:
                0 8px 30px rgba(71, 86, 107, 0.45),
                0 0 20px rgba(86, 104, 130, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.15);
            background-position: 100% 100%;
        }

        .btn-secondary:hover::before {
            left: 100%;
        }

        .btn-secondary:active {
            transform: translateY(-1px) scale(0.98);
        }

        /* Warm Gold Button Style */
        .btn-gold {
            background: linear-gradient(135deg, #dba95e 0%, #e8c88a 50%, #c99445 100%);
            background-size: 200% 200%;
            color: #2e3f62;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                0 4px 20px rgba(201, 169, 110, 0.35),
                inset 0 1px 0 rgba(255,255,255,0.4);
            position: relative;
            overflow: hidden;
        }

        .btn-gold:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow:
                0 8px 30px rgba(201, 169, 110, 0.5),
                0 0 25px rgba(201, 169, 110, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.5);
        }

        /* Sage Button Style */
        .btn-sage {
            background: linear-gradient(135deg, #5d7d60 0%, #739977 50%, #8ba88e 100%);
            background-size: 200% 200%;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                0 4px 20px rgba(115, 153, 119, 0.35),
                inset 0 1px 0 rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }

        .btn-sage:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow:
                0 8px 30px rgba(115, 153, 119, 0.45),
                0 0 20px rgba(115, 153, 119, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }

        /* Glass Effect */
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* ===== Dark Mode Styles ===== */
        html.dark {
            color-scheme: dark;
        }

        .dark body {
            background:
                radial-gradient(ellipse at 15% 0%, rgba(184, 149, 106, 0.06) 0%, transparent 45%),
                radial-gradient(ellipse at 85% 100%, rgba(176, 143, 138, 0.04) 0%, transparent 45%),
                radial-gradient(ellipse at 50% 50%, rgba(71, 86, 107, 0.03) 0%, transparent 60%),
                linear-gradient(180deg, #1e1f23 0%, #18191c 50%, #121315 100%) !important;
            color: #f3ede3 !important;
        }

        .dark body::before {
            background:
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23b8956a' fill-opacity='0.015'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.25;
        }

        /* Background Colors - New Palette */
        .dark .bg-surface-50,
        .dark .bg-white {
            background-color: #1e2024 !important;
        }

        .dark .bg-surface-100 {
            background-color: #262a2e !important;
        }

        .dark .bg-surface-200 {
            background-color: #2e3236 !important;
        }

        /* Text Colors - New Palette */
        .dark .text-accent-900,
        .dark .text-accent-800 {
            color: #f0ebe5 !important;
        }

        .dark .text-surface-500,
        .dark .text-surface-600 {
            color: #9fb3c8 !important;
        }

        .dark .text-primary-500 {
            color: #db9179 !important;
        }

        .dark .text-gray-500 {
            color: #9ca3af !important;
        }

        .dark .text-gray-600 {
            color: #bbb !important;
        }

        /* Border Colors - New Palette */
        .dark .border-surface-200,
        .dark .border-surface-300 {
            border-color: #3a3e42 !important;
        }

        /* Premium Cards in Dark Mode - Elegant */
        .dark .premium-card {
            background: linear-gradient(145deg, rgba(30, 31, 35, 0.98) 0%, rgba(36, 37, 41, 0.95) 100%) !important;
            border: 1px solid rgba(55, 56, 60, 0.4) !important;
            box-shadow:
                0 4px 32px -8px rgba(0, 0, 0, 0.25),
                0 8px 24px -12px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255,255,255,0.04);
        }

        .dark .premium-card::before {
            background: linear-gradient(90deg, transparent, rgba(184, 149, 106, 0.15), transparent);
        }

        .dark .premium-card:hover {
            box-shadow:
                0 20px 60px -15px rgba(0, 0, 0, 0.35),
                0 8px 32px -8px rgba(0, 0, 0, 0.25),
                0 0 20px rgba(184, 149, 106, 0.04),
                inset 0 1px 0 rgba(255,255,255,0.06);
        }

        /* KPI Cards in Dark Mode - Elegant */
        .dark .kpi-card {
            background: linear-gradient(145deg, rgba(30, 31, 35, 0.95) 0%, rgba(36, 37, 41, 0.9) 100%) !important;
            border: 1px solid rgba(55, 56, 60, 0.5) !important;
            box-shadow:
                0 4px 24px -4px rgba(0, 0, 0, 0.3),
                0 8px 32px -8px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.04);
        }

        .dark .kpi-card:hover {
            box-shadow:
                0 20px 40px -12px rgba(0, 0, 0, 0.4),
                0 8px 24px -8px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.06);
        }

        .dark .kpi-card.accent-primary:hover {
            box-shadow:
                0 20px 40px -12px rgba(184, 149, 106, 0.15),
                0 0 25px rgba(184, 149, 106, 0.08),
                inset 0 1px 0 rgba(255,255,255,0.06);
        }

        .dark .kpi-card.accent-navy:hover {
            box-shadow:
                0 20px 40px -12px rgba(86, 104, 130, 0.15),
                0 0 25px rgba(86, 104, 130, 0.08),
                inset 0 1px 0 rgba(255,255,255,0.06);
        }

        .dark .kpi-card.accent-success:hover {
            box-shadow:
                0 20px 40px -12px rgba(115, 153, 119, 0.15),
                0 0 25px rgba(115, 153, 119, 0.08),
                inset 0 1px 0 rgba(255,255,255,0.06);
        }

        .dark .kpi-card.accent-purple:hover {
            box-shadow:
                0 20px 40px -12px rgba(176, 143, 138, 0.15),
                0 0 25px rgba(176, 143, 138, 0.08),
                inset 0 1px 0 rgba(255,255,255,0.06);
        }

        .dark .kpi-card.accent-gold:hover {
            box-shadow:
                0 20px 40px -12px rgba(201, 169, 110, 0.15),
                0 0 25px rgba(201, 169, 110, 0.08),
                inset 0 1px 0 rgba(255,255,255,0.06);
        }

        .dark .kpi-card h2 {
            background: linear-gradient(135deg, #f3ede3 0%, #dba95e 50%, #f3ede3 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Cards & Shadows */
        .dark .shadow-sm {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5) !important;
        }

        .dark .shadow-soft {
            box-shadow: 0 2px 15px -3px rgba(0, 0, 0, 0.5), 0 10px 20px -2px rgba(0, 0, 0, 0.3) !important;
        }

        .dark .shadow-soft-lg {
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.6), 0 2px 10px -2px rgba(0, 0, 0, 0.4) !important;
        }

        /* Header - Dark Mode Elegant */
        .dark header,
        .dark .header-premium {
            background: linear-gradient(135deg, rgba(24, 25, 28, 0.98) 0%, rgba(30, 31, 35, 0.98) 100%) !important;
            border-bottom: 1px solid rgba(184, 149, 106, 0.08) !important;
            box-shadow:
                0 4px 30px rgba(0, 0, 0, 0.15),
                inset 0 -1px 0 rgba(184, 149, 106, 0.06);
        }

        .dark .header-premium::after {
            background: linear-gradient(90deg, transparent, rgba(184, 149, 106, 0.15), transparent);
        }

        /* Form Elements */
        .dark select,
        .dark input,
        .dark textarea {
            background-color: #262a2e !important;
            border-color: #3a3e42 !important;
            color: #e8e6e1 !important;
        }

        .dark select:focus,
        .dark input:focus,
        .dark textarea:focus {
            border-color: #c97458 !important;
            box-shadow: 0 0 0 3px rgba(201, 116, 88, 0.2) !important;
        }

        .dark select:disabled {
            background-color: #1a1c20 !important;
            color: #666 !important;
        }

        /* Tabs - Dark Mode Elegant */
        .dark .tab-btn {
            color: #b5c0cf !important;
        }

        .dark .tab-btn::before {
            background: linear-gradient(135deg, rgba(184, 149, 106, 0.08) 0%, rgba(201, 168, 126, 0.04) 100%);
        }

        .dark .tab-btn.active,
        .dark .tab-btn:hover {
            color: #f3ede3 !important;
        }

        .dark .tab-btn.active {
            background: linear-gradient(180deg, rgba(36, 37, 41, 0.9) 0%, rgba(30, 31, 35, 0.7) 100%);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        }

        .dark .tab-btn::after {
            background: linear-gradient(90deg, #c99445, #dba95e, #e8c88a) !important;
        }

        .dark .tab-btn.active::after {
            background: linear-gradient(90deg, #c99445, #dba95e, #e8c88a, #dba95e, #c99445) !important;
        }

        .dark .tab-btn.active i {
            color: #dba95e;
        }

        /* Edit Table */
        .dark .edit-input {
            background-color: #262a2e !important;
            border-color: #3a3e42 !important;
            color: #e8e6e1 !important;
        }

        .dark .edit-readonly {
            background-color: #1a1c20 !important;
            color: #888 !important;
        }

        .dark .changed-row {
            background: linear-gradient(90deg, rgba(201, 116, 88, 0.15), rgba(201, 116, 88, 0.05)) !important;
        }

        /* Alert Colors */
        .dark .bg-blue-50 {
            background-color: #1e2a3a !important;
        }

        .dark .border-blue-400 {
            border-color: #3a5580 !important;
        }

        .dark .text-blue-800 {
            color: #7db3ff !important;
        }

        .dark .text-blue-600 {
            color: #8ac4ff !important;
        }

        .dark .bg-green-50 {
            background-color: #264232 !important;
        }

        .dark .border-green-400 {
            border-color: #3a8058 !important;
        }

        .dark .text-green-700 {
            color: #7de4b8 !important;
        }

        .dark .bg-yellow-50 {
            background-color: #423c26 !important;
        }

        .dark .border-yellow-400 {
            border-color: #80753a !important;
        }

        .dark .text-yellow-700 {
            color: #ffc85d !important;
        }

        .dark .bg-red-50 {
            background-color: #422630 !important;
        }

        .dark .border-red-400 {
            border-color: #803a50 !important;
        }

        .dark .text-red-700 {
            color: #ff9fb3 !important;
        }

        /* Chart.js Dark Mode Support */
        .dark .chart-container canvas {
            filter: brightness(0.95);
        }

        /* Mobile Accordion in Dark Mode */
        .dark body.mobile-mode .mobile-accordion-header {
            background: linear-gradient(135deg, #334e68, #243b53) !important;
        }

        /* Scrollbar in Dark Mode */
        .dark::-webkit-scrollbar-track,
        .dark .custom-scroll::-webkit-scrollbar-track {
            background: #1e2024 !important;
        }

        .dark::-webkit-scrollbar-thumb,
        .dark .custom-scroll::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #c97458, #994a35) !important;
        }

        /* Hover States */
        .dark .hover\:bg-surface-100:hover {
            background-color: #2e3236 !important;
        }

        /* Staff Dashboard Cards in Dark Mode */
        .dark .border-2.border-primary-500 {
            border-color: #c97458 !important;
        }

        .dark .border-2.border-accent-700 {
            border-color: #486581 !important;
        }

        /* Transition for smooth dark mode toggle */
        body, header, .premium-card, .kpi-card, select, input, textarea {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* Safe Area Support for iOS */
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }

        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Touch Feedback */
        .touch-feedback:active {
            transform: scale(0.97);
            transition: transform 0.1s ease-in-out;
        }

        /* Accessibility: Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Period Buttons */
        .period-btn {
            transition: all 0.2s ease;
            border-radius: 8px;
        }

        .period-btn:hover {
            transform: translateY(-1px);
        }

        .period-btn.active {
            background: linear-gradient(135deg, #c97458 0%, #b85d42 100%) !important;
            color: white !important;
            box-shadow: 0 2px 8px rgba(201, 116, 88, 0.3);
        }

        .dark .period-btn {
            color: #9fb3c8 !important;
        }

        .dark .period-btn.active {
            background: linear-gradient(135deg, #c97458 0%, #b85d42 100%) !important;
            color: white !important;
        }

        .dark .period-btn:hover:not(.active) {
            background-color: #2e3236 !important;
        }

        /* Calendar Styles */
        #calendar-grid > div {
            transition: all 0.2s ease;
        }

        .dark #calendar-grid .bg-gray-50 {
            background-color: #2a2622 !important;
            border-color: #4a4540 !important;
        }

        .dark #calendar-grid .bg-blue-50 {
            background-color: #263548 !important;
            border-color: #3a5580 !important;
        }

        .dark #calendar-grid .bg-green-50 {
            background-color: #264232 !important;
            border-color: #3a8058 !important;
        }

        .dark #calendar-grid .bg-yellow-50 {
            background-color: #423c26 !important;
            border-color: #80753a !important;
        }

        .dark #calendar-grid .bg-orange-50 {
            background-color: #422f26 !important;
            border-color: #805a3a !important;
        }

        .dark #calendar-grid .bg-red-50 {
            background-color: #422630 !important;
            border-color: #803a50 !important;
        }

        /* KPI Card Hover Effect */
        #kpi-grid > div {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        #kpi-grid > div:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .dark #kpi-grid > div:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Smooth Tab Transitions */
        .tab-content {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Card Hover Effects */
        .bg-white.rounded {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .bg-white.rounded:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .dark .bg-white.rounded:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        /* Button Active State */
        button:active:not(:disabled) {
            transform: scale(0.98);
        }

        /* Focus Visible for Accessibility */
        button:focus-visible,
        select:focus-visible,
        input:focus-visible {
            outline: 2px solid #c97458;
            outline-offset: 2px;
        }

        .dark button:focus-visible,
        .dark select:focus-visible,
        .dark input:focus-visible {
            outline-color: #db9179;
        }

        /* KPI Card Styles - Enhanced with Glass Morphism */
        .kpi-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(250,249,247,0.9) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow:
                0 4px 24px -4px rgba(0, 0, 0, 0.08),
                0 8px 32px -8px rgba(0, 0, 0, 0.04),
                inset 0 1px 0 rgba(255,255,255,0.8);
            border: 1px solid rgba(255, 255, 255, 0.6);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            transition: height 0.3s ease;
        }

        .kpi-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            transition: left 0.5s ease;
        }

        .kpi-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow:
                0 20px 40px -12px rgba(0, 0, 0, 0.15),
                0 8px 24px -8px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255,255,255,0.9);
        }

        .kpi-card:hover::before {
            height: 6px;
        }

        .kpi-card:hover::after {
            left: 100%;
        }

        /* Champagne Gold - 総売上 */
        .kpi-card.accent-primary {
            background: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(250,248,245,0.9) 100%);
        }
        .kpi-card.accent-primary::before {
            background: linear-gradient(90deg, #c99445, #dba95e, #e8c88a);
        }
        .kpi-card.accent-primary:hover {
            box-shadow:
                0 20px 40px -12px rgba(184, 149, 106, 0.25),
                0 8px 24px -8px rgba(184, 149, 106, 0.15),
                inset 0 1px 0 rgba(255,255,255,0.9);
        }

        /* Slate Blue - 総来店数 */
        .kpi-card.accent-navy {
            background: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(245,246,248,0.9) 100%);
        }
        .kpi-card.accent-navy::before {
            background: linear-gradient(90deg, #2e3f62, #3b4f78, #4d6290);
        }
        .kpi-card.accent-navy:hover {
            box-shadow:
                0 20px 40px -12px rgba(71, 86, 107, 0.25),
                0 8px 24px -8px rgba(71, 86, 107, 0.15),
                inset 0 1px 0 rgba(255,255,255,0.9);
        }

        /* Warm Gold - 総次回予約率 */
        .kpi-card.accent-gold {
            background: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(252,249,243,0.9) 100%);
        }
        .kpi-card.accent-gold::before {
            background: linear-gradient(90deg, #dba95e, #e8c88a, #f2dbb4);
        }
        .kpi-card.accent-gold:hover {
            box-shadow:
                0 20px 40px -12px rgba(201, 169, 110, 0.25),
                0 8px 24px -8px rgba(201, 169, 110, 0.15),
                inset 0 1px 0 rgba(255,255,255,0.9);
        }

        /* Sage Green - 平均客単価 */
        .kpi-card.accent-success {
            background: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(247,250,247,0.9) 100%);
        }
        .kpi-card.accent-success::before {
            background: linear-gradient(90deg, #5d7d60, #739977, #8ba88e);
        }
        .kpi-card.accent-success:hover {
            box-shadow:
                0 20px 40px -12px rgba(115, 153, 119, 0.25),
                0 8px 24px -8px rgba(115, 153, 119, 0.15),
                inset 0 1px 0 rgba(255,255,255,0.9);
        }

        /* Dusty Rose - 新規次回予約率 */
        .kpi-card.accent-purple {
            background: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(250,247,247,0.9) 100%);
        }
        .kpi-card.accent-purple::before {
            background: linear-gradient(90deg, #c08078, #d49890, #e0b0a8);
        }
        .kpi-card.accent-purple:hover {
            box-shadow:
                0 20px 40px -12px rgba(176, 143, 138, 0.25),
                0 8px 24px -8px rgba(176, 143, 138, 0.15),
                inset 0 1px 0 rgba(255,255,255,0.9);
        }

        /* KPI Value Animation - Elegant */
        .kpi-card h2 {
            background: linear-gradient(135deg, #2e3f62 0%, #4d6290 50%, #2e3f62 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: textShine 4s ease-in-out infinite;
        }

        @keyframes textShine {
            0%, 100% { background-position: 0% center; }
            50% { background-position: 100% center; }
        }

        /* KPI Icon Container Animation */
        .kpi-card .rounded-lg {
            transition: all 0.3s ease;
        }

        .kpi-card:hover .rounded-lg {
            transform: scale(1.1) rotate(5deg);
        }

        /* Header Styles - Elegant & Harmonious */
        .header-premium {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.96) 0%, rgba(250, 249, 247, 0.96) 100%);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(184, 149, 106, 0.12) !important;
            box-shadow:
                0 4px 30px rgba(0, 0, 0, 0.025),
                0 1px 3px rgba(0, 0, 0, 0.015),
                inset 0 -1px 0 rgba(184, 149, 106, 0.08);
        }

        .header-premium::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(184, 149, 106, 0.25), transparent);
        }

        /* Logo Styles */
        .logo-text {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        .logo-subtitle {
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.15em;
        }

        /* Premium Select - Enhanced */
        .select-premium {
            background: linear-gradient(145deg, rgba(255,255,255,0.98) 0%, rgba(250,249,247,0.95) 100%);
            border: 1px solid rgba(232, 230, 225, 0.8);
            border-radius: 12px;
            padding: 10px 36px 10px 14px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.04),
                inset 0 1px 0 rgba(255,255,255,0.8);
        }

        .select-premium:hover {
            border-color: rgba(212, 175, 55, 0.4);
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 rgba(255,255,255,0.9);
        }

        .select-premium:focus {
            border-color: #c97458;
            box-shadow:
                0 0 0 3px rgba(201, 116, 88, 0.15),
                0 4px 12px rgba(201, 116, 88, 0.1);
        }

        .dark .select-premium {
            background: linear-gradient(145deg, rgba(38, 42, 46, 0.95) 0%, rgba(30, 32, 36, 0.9) 100%) !important;
            border-color: rgba(58, 62, 66, 0.6) !important;
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.05);
        }

        .dark .select-premium:hover {
            border-color: rgba(212, 175, 55, 0.3) !important;
        }

        .dark .select-premium:focus {
            border-color: #c97458 !important;
            box-shadow:
                0 0 0 3px rgba(201, 116, 88, 0.2),
                0 4px 12px rgba(201, 116, 88, 0.1);
        }

        /* Tab Container */
        .tab-container {
            border-bottom: 1px solid #e8e6e1;
        }

        .dark .tab-container {
            border-bottom-color: #3a3e42;
        }

        /* Responsive Header Improvements */
        @media (max-width: 640px) {
            .period-btn {
                padding: 6px 8px !important;
                font-size: 0.7rem !important;
            }
        }
    </style>
</head>
<body class="bg-surface-50 text-accent-900 font-sans antialiased">

    <!-- Password Dialog -->
    <div id="password-dialog" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[200] flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="lock" class="w-8 h-8 text-primary-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-accent-900" id="password-dialog-title">パスワード認証</h2>
                <p class="text-sm text-surface-600 mt-2" id="password-dialog-message">このページへのアクセスにはパスワードが必要です</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="password-dialog-input" class="block text-sm font-medium text-accent-800 mb-2">パスワード</label>
                    <input type="password" id="password-dialog-input"
                           class="w-full px-4 py-3 border border-surface-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                           placeholder="パスワードを入力してください"
                           onkeypress="if(event.key === 'Enter') handlePasswordSubmit()">
                </div>
                <div id="password-error" class="hidden text-red-600 text-sm font-medium"></div>
                <button onclick="handlePasswordSubmit()"
                        class="w-full bg-primary-500 text-white py-3 rounded-lg hover:bg-primary-600 transition font-bold flex items-center justify-center gap-2">
                    <i data-lucide="log-in" class="w-5 h-5"></i>
                    ログイン
                </button>
            </div>
        </div>
    </div>

    <!-- Splash Screen / Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gradient-to-br from-surface-50 via-white to-primary-50 dark:from-accent-900 dark:via-accent-800 dark:to-accent-900 z-[100] flex items-center justify-center">
        <div class="text-center px-8">
            <!-- Logo -->
            <div class="splash-logo mb-6">
                <img src="assets/C055456988.jpg" alt="SLEEPY" class="h-[220px] w-auto mx-auto drop-shadow-lg"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <!-- Fallback if logo doesn't load -->
                <div class="hidden w-32 h-32 mx-auto gradient-primary text-white rounded-2xl items-center justify-center text-5xl font-display tracking-widest shadow-xl">
                    S
                </div>
            </div>

            <!-- Brand Name -->
            <h1 class="splash-text text-2xl font-display font-bold text-accent-800 dark:text-white tracking-wide mb-1">
                SLEEPY
            </h1>
            <p class="splash-subtext text-xs text-surface-500 dark:text-surface-400 font-medium uppercase tracking-widest mb-8">
                睡眠整体ダッシュボード
            </p>

            <!-- Progress Bar -->
            <div class="w-48 mx-auto">
                <div class="h-1 bg-surface-200 dark:bg-accent-700 rounded-full overflow-hidden">
                    <div id="splash-progress-bar" class="h-full bg-gradient-to-r from-primary-400 to-primary-600 rounded-full splash-progress"></div>
                </div>
                <p class="text-xs text-surface-400 dark:text-surface-500 mt-3" id="loading-text">読み込み中...</p>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="min-h-screen flex flex-col">

        <!-- Header Section -->
        <header class="header-premium shadow-soft border-b border-surface-200 sticky top-0 z-50 safe-top">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col md:flex-row justify-between items-center gap-4">

                <!-- Logo -->
                <div class="flex items-center gap-3">
                    <img src="assets/C055456988.jpg" alt="SLEEPY Logo" class="h-12 w-auto object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-10 h-10 gradient-primary text-white rounded-xl items-center justify-center text-xl font-display tracking-widest hidden shadow-glow">S</div>
                    <div>
                        <h1 class="logo-text text-xl text-accent-900 flex items-center gap-3">
                            SLEEPY
                            <span id="staff-mode-badge" class="hidden text-xs bg-primary-500 text-white px-3 py-1 rounded-full font-sans normal-case tracking-normal shadow-sm">専用モード</span>
                        </h1>
                        <p class="logo-subtitle text-[10px] text-surface-500 font-medium uppercase">睡眠整体ダッシュボード</p>
                    </div>
                </div>

                <!-- Filters -->
                <div class="flex flex-wrap items-center gap-3">
                    <!-- Refresh Button -->
                    <button id="refresh-data-btn" onclick="refreshData()" class="btn-sage py-2 px-4 flex items-center gap-2" title="最新データを取得">
                        <i data-lucide="refresh-cw" class="w-4 h-4" id="refresh-icon"></i>
                        <span class="hidden sm:inline text-sm">更新</span>
                    </button>

                    <!-- Dark Mode Toggle -->
                    <button id="dark-mode-toggle" onclick="toggleDarkMode()" class="btn-secondary py-2 px-4 flex items-center gap-2" title="ダークモード切り替え">
                        <i data-lucide="moon" class="w-4 h-4" id="dark-mode-icon-lucide"></i>
                        <span id="dark-mode-label" class="hidden sm:inline text-sm">ダーク</span>
                    </button>

                    <!-- Device Mode Toggle -->
                    <button id="device-toggle" onclick="toggleDeviceMode()" class="btn-primary py-2 px-4 flex items-center gap-2">
                        <i data-lucide="smartphone" class="w-4 h-4" id="device-icon-lucide"></i>
                        <span id="device-label" class="text-sm">スマホ</span>
                    </button>

                    <!-- Store Selector -->
                    <div class="relative">
                        <select id="store-selector" onchange="handleStoreChange()" class="select-premium appearance-none text-accent-800 text-sm cursor-pointer min-w-[140px]">
                            <option value="all">全店舗</option>
                            <option value="ebisu">恵比寿駅前店</option>
                            <option value="kadomori">大阪KADOMORI店</option>
                            <option value="fukushima">福島店</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-surface-500">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                    </div>

                    <!-- Staff Selector -->
                    <div class="relative">
                        <select id="staff-selector" onchange="updateDashboard()" class="select-premium appearance-none text-accent-800 text-sm cursor-pointer min-w-[140px] disabled:opacity-50">
                            <option value="all">店舗合計</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-surface-500">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                    </div>

                    <!-- Period Quick Select -->
                    <div class="flex items-center gap-1 bg-surface-100 rounded-xl p-1.5 border border-surface-200">
                        <button onclick="setPeriodFilter('month')" id="period-month" class="period-btn px-3 py-1.5 text-xs font-medium active">今月</button>
                        <button onclick="setPeriodFilter('3months')" id="period-3months" class="period-btn px-3 py-1.5 text-xs font-medium text-surface-600 hover:bg-surface-200">3ヶ月</button>
                        <button onclick="setPeriodFilter('6months')" id="period-6months" class="period-btn px-3 py-1.5 text-xs font-medium text-surface-600 hover:bg-surface-200">6ヶ月</button>
                        <button onclick="setPeriodFilter('year')" id="period-year" class="period-btn px-3 py-1.5 text-xs font-medium text-surface-600 hover:bg-surface-200">1年</button>
                    </div>

                    <!-- Date Selector (Year/Month) -->
                    <div class="relative">
                        <select id="date-selector" onchange="handleDateChange()" class="select-premium appearance-none text-accent-800 text-sm cursor-pointer min-w-[140px]">
                            <!-- JS Populated (2024-2030) -->
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-surface-500">
                            <i data-lucide="calendar" class="w-4 h-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Staff Login Modal -->
        <div id="staff-login-modal" class="fixed inset-0 z-50 hidden">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
            <!-- Modal Content -->
            <div class="absolute inset-0 flex items-center justify-center p-4">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full p-8 relative animate-fade-in">
                    <!-- Logo / Header -->
                    <div class="text-center mb-8">
                        <div class="w-20 h-20 mx-auto mb-4 rounded-full gradient-primary flex items-center justify-center">
                            <i data-lucide="lock" class="w-10 h-10 text-white"></i>
                        </div>
                        <h2 class="text-2xl font-display font-bold text-accent-800 dark:text-white">スタッフログイン</h2>
                        <p id="staff-login-name" class="text-surface-600 dark:text-gray-400 mt-2"></p>
                    </div>

                    <!-- Login Form -->
                    <form id="staff-login-form" onsubmit="handleStaffLogin(event)" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-accent-700 dark:text-gray-300 mb-2">パスワード</label>
                            <input type="password" id="staff-login-password"
                                   class="w-full px-4 py-3 border-2 border-surface-300 dark:border-gray-600 rounded-xl focus:outline-none focus:border-primary-500 dark:bg-gray-700 dark:text-white text-lg"
                                   placeholder="パスワードを入力" required autofocus>
                            <p id="staff-login-error" class="text-red-500 text-sm mt-2 hidden">パスワードが正しくありません</p>
                        </div>
                        <button type="submit" class="w-full btn-primary py-4 text-lg rounded-xl">
                            ログイン
                        </button>
                    </form>

                    <!-- Help Text -->
                    <p class="text-center text-xs text-surface-500 dark:text-gray-500 mt-6">
                        パスワードを忘れた場合は管理者にお問い合わせください
                    </p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main id="main-content" class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full safe-bottom">

            <!-- KPI Cards Row - スマホでは2列でコンパクトに表示 -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2 md:gap-5 mb-6 md:mb-10" id="kpi-grid">
                <!-- Sales -->
                <div class="kpi-card accent-primary p-3 md:p-6">
                    <div class="flex items-center gap-1.5 md:gap-2 mb-1.5 md:mb-3">
                        <div class="w-6 h-6 md:w-8 md:h-8 rounded-lg gradient-primary flex items-center justify-center">
                            <i data-lucide="trending-up" class="w-3 h-3 md:w-4 md:h-4 text-white"></i>
                        </div>
                        <p class="text-[10px] md:text-xs font-semibold text-surface-500 uppercase tracking-wider">総売上</p>
                    </div>
                    <h2 class="text-lg md:text-3xl font-display font-bold text-accent-900" id="kpi-sales">¥0</h2>
                    <div class="mt-1.5 md:mt-3 text-[10px] md:text-sm text-surface-600 flex items-center gap-1">
                        <i data-lucide="target" class="w-2.5 h-2.5 md:w-3 md:h-3 hidden md:inline"></i>
                        目標比: <span id="kpi-goal-ratio" class="font-semibold text-primary-500">0%</span>
                    </div>
                </div>

                <!-- Customers -->
                <div class="kpi-card accent-navy p-3 md:p-6">
                    <div class="flex items-center gap-1.5 md:gap-2 mb-1.5 md:mb-3">
                        <div class="w-6 h-6 md:w-8 md:h-8 rounded-lg gradient-accent flex items-center justify-center">
                            <i data-lucide="users" class="w-3 h-3 md:w-4 md:h-4 text-white"></i>
                        </div>
                        <p class="text-[10px] md:text-xs font-semibold text-surface-500 uppercase tracking-wider">総来店数</p>
                    </div>
                    <h2 class="text-lg md:text-3xl font-display font-bold text-accent-900" id="kpi-customers">0<span class="text-sm md:text-lg font-sans font-normal ml-0.5 md:ml-1 text-surface-500">名</span></h2>
                    <div class="mt-1.5 md:mt-3 text-[10px] md:text-sm text-surface-600">
                        新規: <span id="kpi-new" class="font-semibold text-primary-500">0</span>
                        <span class="mx-0.5 md:mx-1 text-surface-400">/</span>
                        既存: <span id="kpi-existing" class="font-semibold text-accent-600">0</span>
                    </div>
                </div>

                <!-- Unit Price -->
                <div class="kpi-card accent-success p-3 md:p-6">
                    <div class="flex items-center gap-1.5 md:gap-2 mb-1.5 md:mb-3">
                        <div class="w-6 h-6 md:w-8 md:h-8 rounded-lg gradient-sage flex items-center justify-center">
                            <i data-lucide="wallet" class="w-3 h-3 md:w-4 md:h-4 text-white"></i>
                        </div>
                        <p class="text-[10px] md:text-xs font-semibold text-surface-500 uppercase tracking-wider">平均客単価</p>
                    </div>
                    <h2 class="text-lg md:text-3xl font-display font-bold text-accent-900" id="kpi-unit-price">¥0</h2>
                    <div class="mt-1.5 md:mt-3 text-[10px] md:text-sm text-surface-600 hidden md:flex items-center gap-1">
                        <i data-lucide="shopping-bag" class="w-3 h-3"></i>
                        物販込み平均
                    </div>
                </div>

                <!-- New Customer Reservation Rate -->
                <div class="kpi-card accent-purple p-3 md:p-6">
                    <div class="flex items-center gap-1.5 md:gap-2 mb-1.5 md:mb-3">
                        <div class="w-6 h-6 md:w-8 md:h-8 rounded-lg gradient-rose flex items-center justify-center">
                            <i data-lucide="user-check" class="w-3 h-3 md:w-4 md:h-4 text-white"></i>
                        </div>
                        <p class="text-[10px] md:text-xs font-semibold text-surface-500 uppercase tracking-wider">新規次回予約率</p>
                    </div>
                    <h2 class="text-lg md:text-3xl font-display font-bold text-accent-900" id="kpi-new-reservation-rate">0%</h2>
                    <p class="text-[10px] md:text-sm text-surface-600 mt-1.5 md:mt-3 hidden md:block">(HPB+Mini新規予約数)÷HPB新規数</p>
                </div>

                <!-- Total Reservation Rate -->
                <div class="kpi-card accent-gold p-3 md:p-6 col-span-2 md:col-span-1">
                    <div class="flex items-center gap-1.5 md:gap-2 mb-1.5 md:mb-3">
                        <div class="w-6 h-6 md:w-8 md:h-8 rounded-lg gradient-warmgold flex items-center justify-center">
                            <i data-lucide="calendar-check" class="w-3 h-3 md:w-4 md:h-4 text-white"></i>
                        </div>
                        <p class="text-[10px] md:text-xs font-semibold text-surface-500 uppercase tracking-wider">総次回予約率</p>
                    </div>
                    <h2 class="text-lg md:text-3xl font-display font-bold text-accent-900" id="kpi-total-reservation-rate">0%</h2>
                    <p class="text-[10px] md:text-sm text-surface-600 mt-1.5 md:mt-3 hidden md:block">全次回予約数÷全来店数</p>
                </div>

            </div>

            <!-- Tabs -->
            <div class="mb-8 tab-container">
                <nav id="main-tabs" class="flex space-x-1 overflow-x-auto custom-scroll pb-px">
                    <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn active py-2 px-3 md:py-3 md:px-4 font-medium text-sm text-accent-800 flex items-center justify-center gap-2" title="サマリー">
                        <i data-lucide="layout-dashboard" class="w-6 h-6 md:w-4 md:h-4"></i>
                        <span class="hidden md:inline">サマリー</span>
                    </button>
                    <!-- Staff Dashboard Tab (shown only when staff is selected) -->
                    <button onclick="switchTab('staff-dashboard')" id="tab-staff-dashboard" class="tab-btn py-2 px-3 md:py-3 md:px-4 font-medium text-sm text-surface-500 hidden flex items-center justify-center gap-2" title="マイダッシュボード">
                        <i data-lucide="user" class="w-6 h-6 md:w-4 md:h-4"></i>
                        <span class="hidden md:inline">マイダッシュボード</span>
                    </button>
                    <!-- Counseling Results Tab (shown only when staff is selected) -->
                    <button onclick="switchTab('counseling-results')" id="tab-counseling-results" class="tab-btn py-2 px-3 md:py-3 md:px-4 font-medium text-sm text-surface-500 hidden flex items-center justify-center gap-2" title="カウンセリング回答">
                        <i data-lucide="clipboard-list" class="w-6 h-6 md:w-4 md:h-4"></i>
                        <span class="hidden md:inline">カウンセリング回答</span>
                    </button>
                    <button onclick="switchTab('customers')" id="tab-customers" class="tab-btn py-2 px-3 md:py-3 md:px-4 font-medium text-sm text-surface-500 flex items-center justify-center gap-2" title="顧客・媒体分析">
                        <i data-lucide="pie-chart" class="w-6 h-6 md:w-4 md:h-4"></i>
                        <span class="hidden md:inline">顧客・媒体分析</span>
                    </button>
                    <button onclick="switchTab('sales')" id="tab-sales" class="tab-btn py-2 px-3 md:py-3 md:px-4 font-medium text-sm text-surface-500 flex items-center justify-center gap-2" title="売上詳細">
                        <i data-lucide="receipt" class="w-6 h-6 md:w-4 md:h-4"></i>
                        <span class="hidden md:inline">売上詳細</span>
                    </button>
                    <button onclick="switchTab('kpi')" id="tab-kpi" class="tab-btn py-2 px-3 md:py-3 md:px-4 font-medium text-sm text-surface-500 flex items-center justify-center gap-2" title="KPI・日報">
                        <i data-lucide="bar-chart-3" class="w-6 h-6 md:w-4 md:h-4"></i>
                        <span class="hidden md:inline">KPI・日報</span>
                    </button>
                    <!-- Marketing/CRM Tab -->
                    <button onclick="switchTab('marketing')" id="tab-marketing" class="tab-btn py-2 px-3 md:py-3 md:px-4 font-medium text-sm text-surface-500 flex items-center justify-center gap-2" title="マーケティング">
                        <i data-lucide="megaphone" class="w-6 h-6 md:w-4 md:h-4"></i>
                        <span class="hidden md:inline">マーケティング</span>
                    </button>
                    <!-- Calendar View Tab -->
                    <button onclick="switchTab('calendar')" id="tab-calendar" class="tab-btn py-2 px-3 md:py-3 md:px-4 font-medium text-sm text-surface-500 flex items-center justify-center gap-2" title="カレンダー">
                        <i data-lucide="calendar" class="w-6 h-6 md:w-4 md:h-4"></i>
                        <span class="hidden md:inline">カレンダー</span>
                    </button>
                    <!-- Membership & Ticket Tab -->
                    <button onclick="switchTab('membership')" id="tab-membership" class="tab-btn py-2 px-3 md:py-3 md:px-4 font-medium text-sm text-surface-500 flex items-center justify-center gap-2" title="会員・回数券">
                        <i data-lucide="credit-card" class="w-6 h-6 md:w-4 md:h-4"></i>
                        <span class="hidden md:inline">会員・回数券</span>
                    </button>
                    <!-- Goal Setting Tab -->
                    <button onclick="switchTab('goal')" id="tab-goal" class="tab-btn py-2 px-3 md:py-3 md:px-4 font-medium text-sm text-surface-500 flex items-center justify-center gap-2" title="売上目標設定">
                        <i data-lucide="target" class="w-6 h-6 md:w-4 md:h-4"></i>
                        <span class="hidden md:inline">売上目標設定</span>
                    </button>
                    <!-- Edit Tab -->
                    <button onclick="switchTab('edit')" id="tab-edit" class="tab-btn py-2 px-3 md:py-3 md:px-4 font-medium text-sm text-surface-500 flex items-center justify-center gap-2" title="データ編集">
                        <i data-lucide="edit-3" class="w-6 h-6 md:w-4 md:h-4"></i>
                        <span class="hidden md:inline">データ編集</span>
                    </button>
                    <!-- Settings Tab -->
                    <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn py-2 px-3 md:py-3 md:px-4 font-medium text-sm text-surface-500 flex items-center justify-center gap-2" title="設定">
                        <i data-lucide="settings" class="w-6 h-6 md:w-4 md:h-4"></i>
                        <span class="hidden md:inline">設定</span>
                    </button>
                </nav>
            </div>

            <!-- TAB: OVERVIEW -->
            <section id="content-overview" class="tab-content block space-y-8 animate-fade-in">
                <div class="bg-white rounded p-6 shadow-sm border border-sleepy-100">
                    <h3 class="text-lg font-serif font-bold text-sleepy-800 mb-6">客単価・来店内訳推移</h3>
                    <p class="text-xs text-sleepy-500 mb-4">棒グラフ: 新規/既存の内訳 (右軸) | 折れ線: 平均客単価 (左軸)</p>
                    <div class="chart-container"><canvas id="overviewChart"></canvas></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded p-6 shadow-sm border border-sleepy-100">
                        <h3 class="text-lg font-serif font-bold text-sleepy-800 mb-4">新規・既存の割合</h3>
                        <div class="flex items-center gap-6">
                            <div class="chart-container h-64 flex-1"><canvas id="customerRatioChart"></canvas></div>
                            <div class="flex-1 space-y-4">
                                <div class="bg-sleepy-50 p-3 rounded">
                                    <div class="flex justify-between text-sm"><span class="text-sleepy-500">新規</span><span class="font-bold" id="ratio-new-count">0</span></div>
                                    <div class="w-full bg-white h-1.5 mt-1"><div class="bg-sleepy-400 h-1.5" id="bar-new-rate" style="width:0%"></div></div>
                                </div>
                                <div class="bg-sleepy-50 p-3 rounded">
                                    <div class="flex justify-between text-sm"><span class="text-sleepy-500">既存</span><span class="font-bold" id="ratio-exist-count">0</span></div>
                                    <div class="w-full bg-white h-1.5 mt-1"><div class="bg-sleepy-800 h-1.5" id="bar-exist-rate" style="width:0%"></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded p-6 shadow-sm border border-sleepy-100">
                        <h3 class="text-lg font-serif font-bold text-sleepy-800 mb-4">新規媒体シェア</h3>
                        <div class="chart-container h-64"><canvas id="channelShareChart"></canvas></div>
                        <div class="mt-4 flex justify-center gap-4 text-xs text-sleepy-500">
                             <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-sleepy-400"></span>HPB: <span id="hpb-count" class="font-bold ml-1">0</span>名</div>
                             <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-sleepy-300"></span>minimo/Nailie: <span id="mininai-count" class="font-bold ml-1">0</span>名</div>
                        </div>
                    </div>
                </div>

                <!-- Staff Performance Summary Section -->
                <div class="premium-card p-6" id="staff-summary-section">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg gradient-accent flex items-center justify-center">
                                <i data-lucide="users" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-display font-bold text-accent-900">スタッフ別パフォーマンス</h3>
                                <p class="text-xs text-surface-500">売上・来店数・新規獲得の一覧</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleStaffSummaryView('cards')" id="staff-view-cards" class="px-3 py-1.5 text-xs font-medium rounded-lg bg-primary-500 text-white transition">
                                カード
                            </button>
                            <button onclick="toggleStaffSummaryView('table')" id="staff-view-table" class="px-3 py-1.5 text-xs font-medium rounded-lg text-surface-600 hover:bg-surface-100 transition">
                                テーブル
                            </button>
                        </div>
                    </div>

                    <!-- Staff Cards View -->
                    <div id="staff-cards-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Staff cards will be dynamically generated -->
                        <div class="text-center text-surface-500 py-8 col-span-full">
                            <i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin"></i>
                            <p class="text-sm">データを読み込み中...</p>
                        </div>
                    </div>

                    <!-- Staff Table View -->
                    <div id="staff-table-view" class="hidden overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-surface-200 bg-surface-50">
                                    <th class="text-left py-3 px-4 font-semibold text-accent-800">順位</th>
                                    <th class="text-left py-3 px-4 font-semibold text-accent-800">スタッフ</th>
                                    <th class="text-right py-3 px-4 font-semibold text-accent-800">売上</th>
                                    <th class="text-right py-3 px-4 font-semibold text-accent-800">来店数</th>
                                    <th class="text-right py-3 px-4 font-semibold text-accent-800">新規</th>
                                    <th class="text-right py-3 px-4 font-semibold text-accent-800">単価</th>
                                    <th class="text-right py-3 px-4 font-semibold text-accent-800">次回予約率</th>
                                    <th class="text-center py-3 px-4 font-semibold text-accent-800">推移</th>
                                </tr>
                            </thead>
                            <tbody id="staff-table-body">
                                <!-- Table rows will be dynamically generated -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Staff Ranking Mini Charts -->
                    <div class="mt-6 pt-6 border-t border-surface-200">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Sales Ranking -->
                            <div class="bg-surface-50 rounded-xl p-4">
                                <h4 class="text-sm font-semibold text-accent-800 mb-3 flex items-center gap-2">
                                    <i data-lucide="trophy" class="w-4 h-4 text-amber-500"></i>
                                    売上ランキング
                                </h4>
                                <div id="sales-ranking-list" class="space-y-2">
                                    <!-- Ranking items will be dynamically generated -->
                                </div>
                            </div>

                            <!-- New Customers Ranking -->
                            <div class="bg-surface-50 rounded-xl p-4">
                                <h4 class="text-sm font-semibold text-accent-800 mb-3 flex items-center gap-2">
                                    <i data-lucide="user-plus" class="w-4 h-4 text-emerald-500"></i>
                                    新規獲得ランキング
                                </h4>
                                <div id="new-customers-ranking-list" class="space-y-2">
                                    <!-- Ranking items will be dynamically generated -->
                                </div>
                            </div>

                            <!-- Unit Price Ranking -->
                            <div class="bg-surface-50 rounded-xl p-4">
                                <h4 class="text-sm font-semibold text-accent-800 mb-3 flex items-center gap-2">
                                    <i data-lucide="wallet" class="w-4 h-4 text-[#c99445]"></i>
                                    客単価ランキング
                                </h4>
                                <div id="unit-price-ranking-list" class="space-y-2">
                                    <!-- Ranking items will be dynamically generated -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Blog & SNS Update Progress -->
                <div class="premium-card p-6" id="blog-progress-section">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-500 to-pink-500 flex items-center justify-center">
                            <i data-lucide="file-edit" class="w-5 h-5 text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-display font-bold text-accent-900">ブログ・SNS更新進捗</h3>
                            <p class="text-xs text-surface-500">今月の目標: ブログ10件/月</p>
                        </div>
                    </div>
                    <div id="blog-progress-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Progress bars will be dynamically generated -->
                    </div>
                </div>

                <!-- Admin Only: Staff Incentive Summary -->
                <div id="staff-incentive-section" class="premium-card p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#c99445] to-[#dba95e] flex items-center justify-center">
                            <i data-lucide="coins" class="w-5 h-5 text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-display font-bold text-accent-900">スタッフ別インセンティブ一覧</h3>
                            <p class="text-xs text-surface-500">全スタッフの推定インセンティブ（管理者専用）</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b-2 border-[#c99445] bg-[#fdf8f0]">
                                    <th class="text-left py-3 px-4 font-semibold text-accent-800">店舗</th>
                                    <th class="text-left py-3 px-4 font-semibold text-accent-800">スタッフ</th>
                                    <th class="text-right py-3 px-4 font-semibold text-accent-800">基本給</th>
                                    <th class="text-right py-3 px-4 font-semibold text-accent-800">施術売上</th>
                                    <th class="text-right py-3 px-4 font-semibold text-accent-800">施術インセンティブ</th>
                                    <th class="text-right py-3 px-4 font-semibold text-accent-800">物販売上</th>
                                    <th class="text-right py-3 px-4 font-semibold text-accent-800">物販インセンティブ</th>
                                    <th class="text-right py-3 px-4 font-semibold text-[#c99445] text-base">推定報酬合計</th>
                                </tr>
                            </thead>
                            <tbody id="staff-incentive-table-body" class="divide-y divide-surface-100">
                                <!-- Rows will be dynamically generated -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-[#fdf8f0] border-t-2 border-[#c99445]">
                                    <td class="py-3 px-4 font-bold text-accent-800" colspan="2">合計</td>
                                    <td class="py-3 px-4 text-right font-bold text-accent-800" id="incentive-total-base">¥0</td>
                                    <td class="py-3 px-4 text-right font-bold text-accent-800" id="incentive-total-service-sales">¥0</td>
                                    <td class="py-3 px-4 text-right font-bold text-accent-800" id="incentive-total-service">¥0</td>
                                    <td class="py-3 px-4 text-right font-bold text-accent-800" id="incentive-total-retail-sales">¥0</td>
                                    <td class="py-3 px-4 text-right font-bold text-accent-800" id="incentive-total-retail">¥0</td>
                                    <td class="py-3 px-4 text-right font-bold text-[#c99445] text-lg" id="incentive-grand-total">¥0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="mt-4 p-4 bg-surface-50 rounded-lg">
                        <p class="text-xs text-surface-500">
                            <span class="font-semibold">計算式:</span> 推定報酬 = 基本給 + 施術売上×5% + 物販インセンティブ（10万未満:5%, 10万以上:10%）
                        </p>
                    </div>
                </div>

                <!-- AI Advice Section -->
                <div id="ai-advice-section" class="bg-gradient-to-br from-sleepy-50 to-white rounded-lg shadow-sm border border-sleepy-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-sleepy-700 to-sleepy-800 text-white px-6 py-4 flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold flex items-center gap-2">
                                <span>💡</span> AI業務改善アドバイス
                            </h3>
                            <p class="text-xs text-sleepy-100 mt-1">目標達成のための具体的なアドバイスを取得</p>
                        </div>
                        <button onclick="getAIAdvice()" id="btn-ai-advice" class="bg-white text-sleepy-800 px-4 py-2 rounded hover:bg-sleepy-50 transition font-bold text-sm">
                            アドバイスを取得
                        </button>
                    </div>
                    <div class="p-6" id="ai-advice-content">
                        <div class="text-center text-sleepy-500 py-8">
                            <p class="text-sm">「アドバイスを取得」ボタンをクリックすると、AIが目標達成のための具体的なアドバイスを提供します。</p>
                            <p class="text-xs mt-2">※事前に設定タブでGemini APIキーを登録してください</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- TAB: STAFF DASHBOARD -->
            <section id="content-staff-dashboard" class="tab-content hidden space-y-4 md:space-y-8 animate-fade-in">
                <!-- Comparison Grid: Personal vs Store -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-8">
                    <!-- Personal Metrics -->
                    <div class="bg-white rounded-lg shadow-lg border-2 border-sleepy-400 overflow-hidden">
                        <div class="bg-sleepy-400 text-white px-4 md:px-6 py-2 md:py-4">
                            <h3 class="text-base md:text-lg font-serif font-bold flex items-center gap-2">
                                <span>👤</span> あなたの実績
                            </h3>
                        </div>
                        <div class="p-3 md:p-6 space-y-3 md:space-y-4">
                            <!-- Sales -->
                            <div class="bg-sleepy-50 p-3 md:p-4 rounded">
                                <p class="text-[10px] md:text-xs font-bold text-sleepy-400 uppercase tracking-wider mb-1">総売上</p>
                                <h3 class="text-2xl md:text-3xl font-serif font-bold text-sleepy-800" id="staff-personal-sales">¥0</h3>
                                <div class="mt-1 md:mt-2 text-[10px] md:text-xs text-sleepy-600">
                                    目標: <span id="staff-personal-goal" class="font-bold">¥1,100,000</span>
                                    <span class="ml-1 md:ml-2">達成率: <span id="staff-personal-goal-rate" class="font-bold text-sleepy-800">0%</span></span>
                                </div>
                            </div>

                            <!-- Customers -->
                            <div class="border-t border-sleepy-200 pt-3 md:pt-4 space-y-2 md:space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs md:text-sm text-sleepy-600">総来店数</span>
                                    <span class="text-lg md:text-xl font-bold text-sleepy-800" id="staff-personal-customers">0名</span>
                                </div>
                                <div class="flex justify-between items-center text-xs md:text-sm">
                                    <span class="text-sleepy-600">新規</span>
                                    <div>
                                        <span id="staff-personal-new" class="font-bold text-sleepy-800">0</span>
                                        <span class="text-sleepy-400"> / </span>
                                        <span id="staff-personal-new-goal" class="font-bold text-sleepy-600">30</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-xs md:text-sm">
                                    <span class="text-sleepy-600">既存</span>
                                    <div>
                                        <span id="staff-personal-existing" class="font-bold text-sleepy-800">0</span>
                                        <span class="text-sleepy-400"> / </span>
                                        <span id="staff-personal-existing-goal" class="font-bold text-sleepy-600">90</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-xs md:text-sm">
                                    <span class="text-sleepy-600">客単価</span>
                                    <div>
                                        <span id="staff-personal-unit-price" class="font-bold text-sleepy-800">¥0</span>
                                        <span class="text-sleepy-400"> / </span>
                                        <span id="staff-personal-unit-price-goal" class="font-bold text-sleepy-600">¥9,000</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Reservation Rates -->
                            <div class="border-t border-sleepy-200 pt-3 md:pt-4 space-y-2 md:space-y-3">
                                <div class="flex justify-between items-center text-xs md:text-sm">
                                    <span class="text-sleepy-600">新規次回予約率</span>
                                    <div>
                                        <span id="staff-personal-new-res-rate" class="font-bold text-sleepy-800">0%</span>
                                        <span class="text-sleepy-400"> / </span>
                                        <span id="staff-personal-new-res-rate-goal" class="font-bold text-sleepy-600">50%</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-xs md:text-sm">
                                    <span class="text-sleepy-600">次回予約率</span>
                                    <div>
                                        <span id="staff-personal-res-rate" class="font-bold text-sleepy-800">0%</span>
                                        <span class="text-sleepy-400"> / </span>
                                        <span id="staff-personal-res-rate-goal" class="font-bold text-sleepy-600">70%</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-xs md:text-sm">
                                    <span class="text-sleepy-600">★5口コミ</span>
                                    <div>
                                        <span id="staff-personal-reviews" class="font-bold text-sleepy-800">0</span>
                                        <span class="text-sleepy-400"> / </span>
                                        <span id="staff-personal-reviews-goal" class="font-bold text-sleepy-600">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Store Total Metrics -->
                    <div class="bg-white rounded-lg shadow-lg border-2 border-sleepy-800 overflow-hidden">
                        <div class="bg-sleepy-800 text-white px-4 md:px-6 py-2 md:py-4">
                            <h3 class="text-base md:text-lg font-serif font-bold flex items-center gap-2">
                                <span>🏢</span> 店舗全体の実績
                            </h3>
                        </div>
                        <div class="p-3 md:p-6 space-y-3 md:space-y-4">
                            <!-- Sales -->
                            <div class="bg-sleepy-50 p-3 md:p-4 rounded">
                                <p class="text-[10px] md:text-xs font-bold text-sleepy-400 uppercase tracking-wider mb-1">総売上</p>
                                <h3 class="text-2xl md:text-3xl font-serif font-bold text-sleepy-800" id="staff-store-sales">¥0</h3>
                                <div class="mt-1 md:mt-2 text-[10px] md:text-xs text-sleepy-600">
                                    目標: <span id="staff-store-goal" class="font-bold">¥3,000,000</span>
                                    <span class="ml-1 md:ml-2">達成率: <span id="staff-store-goal-rate" class="font-bold text-sleepy-800">0%</span></span>
                                </div>
                            </div>

                            <!-- Customers -->
                            <div class="border-t border-sleepy-200 pt-3 md:pt-4 space-y-2 md:space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs md:text-sm text-sleepy-600">総来店数</span>
                                    <span class="text-lg md:text-xl font-bold text-sleepy-800" id="staff-store-customers">0名</span>
                                </div>
                                <div class="flex justify-between items-center text-xs md:text-sm">
                                    <span class="text-sleepy-600">新規</span>
                                    <div>
                                        <span id="staff-store-new" class="font-bold text-sleepy-800">0</span>
                                        <span class="text-sleepy-400"> / </span>
                                        <span id="staff-store-new-goal" class="font-bold text-sleepy-600">100</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-xs md:text-sm">
                                    <span class="text-sleepy-600">既存</span>
                                    <div>
                                        <span id="staff-store-existing" class="font-bold text-sleepy-800">0</span>
                                        <span class="text-sleepy-400"> / </span>
                                        <span id="staff-store-existing-goal" class="font-bold text-sleepy-600">300</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-xs md:text-sm">
                                    <span class="text-sleepy-600">客単価</span>
                                    <div>
                                        <span id="staff-store-unit-price" class="font-bold text-sleepy-800">¥0</span>
                                        <span class="text-sleepy-400"> / </span>
                                        <span id="staff-store-unit-price-goal" class="font-bold text-sleepy-600">¥9,000</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Reservation Rates -->
                            <div class="border-t border-sleepy-200 pt-3 md:pt-4 space-y-2 md:space-y-3">
                                <div class="flex justify-between items-center text-xs md:text-sm">
                                    <span class="text-sleepy-600">新規次回予約率</span>
                                    <div>
                                        <span id="staff-store-new-res-rate" class="font-bold text-sleepy-800">0%</span>
                                        <span class="text-sleepy-400"> / </span>
                                        <span id="staff-store-new-res-rate-goal" class="font-bold text-sleepy-600">50%</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-xs md:text-sm">
                                    <span class="text-sleepy-600">次回予約率</span>
                                    <div>
                                        <span id="staff-store-res-rate" class="font-bold text-sleepy-800">0%</span>
                                        <span class="text-sleepy-400"> / </span>
                                        <span id="staff-store-res-rate-goal" class="font-bold text-sleepy-600">70%</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-xs md:text-sm">
                                    <span class="text-sleepy-600">★5口コミ</span>
                                    <div>
                                        <span id="staff-store-reviews" class="font-bold text-sleepy-800">0</span>
                                        <span class="text-sleepy-400"> / </span>
                                        <span id="staff-store-reviews-goal" class="font-bold text-sleepy-600">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Incentive Details -->
                <div class="bg-white rounded-lg shadow-sm border border-sleepy-200 p-3 md:p-6">
                    <h3 class="text-base md:text-lg font-serif font-bold text-sleepy-800 mb-3 md:mb-6 flex items-center gap-2">
                        <span>💰</span> インセンティブ詳細
                    </h3>
                    <div class="space-y-3 md:space-y-4">
                        <div class="bg-gradient-to-br from-sleepy-800 to-sleepy-900 text-white p-3 md:p-4 rounded-lg">
                            <p class="text-[10px] md:text-xs font-bold text-sleepy-200 uppercase mb-1">今月の推定インセンティブ</p>
                            <div class="text-2xl md:text-3xl font-serif font-bold" id="staff-incentive-total">¥0</div>
                        </div>

                        <div class="space-y-2 md:space-y-3 text-xs md:text-sm">
                            <div class="flex justify-between items-center border-b border-sleepy-100 pb-2">
                                <span class="text-sleepy-600">基本給</span>
                                <span class="font-bold text-sleepy-800" id="staff-incentive-base">¥0</span>
                            </div>
                            <div class="flex justify-between items-center border-b border-sleepy-100 pb-2">
                                <span class="text-sleepy-600">施術売上 (5%)</span>
                                <div class="text-right">
                                    <div class="text-sleepy-500 text-[10px] md:text-xs" id="staff-incentive-service-sales">施術売上: ¥0</div>
                                    <span class="font-bold text-sleepy-800" id="staff-incentive-service">¥0</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center border-b border-sleepy-100 pb-2">
                                <span class="text-sleepy-600">物販インセンティブ</span>
                                <div class="text-right">
                                    <div class="text-sleepy-500 text-[10px] md:text-xs" id="staff-incentive-retail-sales">物販売上: ¥0</div>
                                    <div class="text-sleepy-500 text-[10px] md:text-xs" id="staff-incentive-retail-rate">(5%適用)</div>
                                    <span class="font-bold text-sleepy-800" id="staff-incentive-retail">¥0</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-2 md:p-3 rounded border-l-4 border-blue-400">
                            <p class="text-[10px] md:text-xs font-bold text-blue-800 mb-1">📊 計算式</p>
                            <p class="text-[10px] md:text-xs text-blue-600">
                                基本給 + 施術売上×5% + 物販インセンティブ<br>
                                <span class="text-blue-500">※物販10万円以上は10%計算</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Achievement Progress Bars -->
                <div class="bg-white rounded-lg shadow-sm border border-sleepy-200 p-3 md:p-6">
                    <h3 class="text-base md:text-lg font-serif font-bold text-sleepy-800 mb-3 md:mb-6">目標達成の進捗</h3>
                    <div class="space-y-4 md:space-y-6">
                        <!-- Sales Progress -->
                        <div>
                            <div class="flex justify-between text-xs md:text-sm mb-1 md:mb-2">
                                <span class="text-sleepy-600 font-medium">売上目標</span>
                                <span class="text-sleepy-800 font-bold"><span id="staff-progress-sales-percent">0%</span></span>
                            </div>
                            <div class="w-full bg-sleepy-100 h-3 md:h-4 rounded-full overflow-hidden">
                                <div class="bg-gradient-to-r from-sleepy-400 to-sleepy-800 h-3 md:h-4 transition-all duration-500" id="staff-progress-sales-bar" style="width:0%"></div>
                            </div>
                        </div>

                        <!-- New Customers Progress -->
                        <div>
                            <div class="flex justify-between text-xs md:text-sm mb-1 md:mb-2">
                                <span class="text-sleepy-600 font-medium">新規数目標</span>
                                <span class="text-sleepy-800 font-bold"><span id="staff-progress-new-percent">0%</span></span>
                            </div>
                            <div class="w-full bg-sleepy-100 h-3 md:h-4 rounded-full overflow-hidden">
                                <div class="bg-gradient-to-r from-sleepy-300 to-sleepy-600 h-3 md:h-4 transition-all duration-500" id="staff-progress-new-bar" style="width:0%"></div>
                            </div>
                        </div>

                        <!-- Existing Customers Progress -->
                        <div>
                            <div class="flex justify-between text-xs md:text-sm mb-1 md:mb-2">
                                <span class="text-sleepy-600 font-medium">既存数目標</span>
                                <span class="text-sleepy-800 font-bold"><span id="staff-progress-existing-percent">0%</span></span>
                            </div>
                            <div class="w-full bg-sleepy-100 h-3 md:h-4 rounded-full overflow-hidden">
                                <div class="bg-gradient-to-r from-sleepy-300 to-sleepy-600 h-3 md:h-4 transition-all duration-500" id="staff-progress-existing-bar" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </section>

            <!-- TAB: COUNSELING RESULTS -->
            <section id="content-counseling-results" class="tab-content hidden space-y-6 animate-fade-in">
                <!-- Header -->
                <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white p-6 rounded-lg shadow-lg">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center">
                                <i data-lucide="clipboard-list" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-serif font-bold">カウンセリング回答結果</h2>
                                <p class="text-sm text-emerald-100">Googleフォームからの顧客カウンセリング回答一覧</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            <select id="counseling-store-filter" onchange="renderCounselingResults()" class="px-3 py-2 text-sm border border-emerald-400 bg-emerald-500/50 text-white rounded focus:outline-none focus:ring-2 focus:ring-white/50">
                                <option value="all">全店</option>
                                <option value="ebisu">恵比寿駅前店</option>
                                <option value="kadomori">大阪KADOMORI店</option>
                                <option value="fukushima">福島店</option>
                            </select>
                            <select id="counseling-date-filter" onchange="renderCounselingResults()" class="px-3 py-2 text-sm border border-emerald-400 bg-emerald-500/50 text-white rounded focus:outline-none focus:ring-2 focus:ring-white/50">
                                <option value="all">全期間</option>
                                <option value="today">今日</option>
                                <option value="week">今週</option>
                                <option value="month" selected>今月</option>
                            </select>
                            <button onclick="refreshCounselingResults()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2 transition">
                                <i data-lucide="refresh-cw" class="w-4 h-4" id="counseling-refresh-icon"></i>
                                データ更新
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 検索・件数 -->
                <div class="bg-white rounded-lg shadow-sm border border-sleepy-100 p-4">
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <div class="relative flex-1 w-full">
                            <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-sleepy-400"></i>
                            <input type="text" id="counseling-result-search" onkeyup="renderCounselingResults()" placeholder="お客様名で検索..." class="w-full pl-9 pr-4 py-2.5 text-sm border border-sleepy-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                        <div class="text-sm text-sleepy-600 font-semibold" id="counseling-result-count">0件の回答</div>
                    </div>
                </div>

                <!-- 回答一覧 -->
                <div id="counseling-results-container" class="space-y-4">
                    <div class="text-center py-12 text-sleepy-400 bg-white rounded-lg border border-sleepy-100">
                        <i data-lucide="clipboard-list" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                        <p class="text-base">顧客データAPIを設定すると、カウンセリング回答が表示されます</p>
                        <p class="text-xs mt-2">設定タブ → 顧客データ連携設定</p>
                    </div>
                </div>
            </section>

            <!-- TAB: CUSTOMERS -->
            <section id="content-customers" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="bg-white rounded p-6 shadow-sm border border-sleepy-100">
                    <h3 class="text-lg font-serif font-bold text-sleepy-800 mb-4">媒体別 新規集客推移</h3>
                    <div class="chart-container"><canvas id="channelTrendChart"></canvas></div>
                </div>
            </section>

            <!-- TAB: SALES -->
            <section id="content-sales" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded p-6 shadow-sm border border-sleepy-100">
                        <h3 class="text-lg font-serif font-bold text-sleepy-800 mb-4">決済方法</h3>
                        <div class="chart-container"><canvas id="paymentChart"></canvas></div>
                    </div>
                    <div class="bg-white rounded p-6 shadow-sm border border-sleepy-100">
                        <h3 class="text-lg font-serif font-bold text-sleepy-800 mb-4">割引・損失分析</h3>
                        <div class="chart-container"><canvas id="lossChart"></canvas></div>
                        <p class="mt-4 text-right text-sm text-sleepy-500">損失合計: <span class="font-bold text-sleepy-800 text-lg" id="val-total-loss">¥0</span></p>
                    </div>
                </div>
            </section>

            <!-- TAB: MARKETING / CRM -->
            <section id="content-marketing" class="tab-content hidden space-y-8 animate-fade-in">
                <!-- Header -->
                <div class="premium-card p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl gradient-primary flex items-center justify-center">
                                <i data-lucide="target" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-display font-bold text-accent-900">マーケティング分析</h2>
                                <p class="text-sm text-surface-500">顧客データから集客・マーケティングを最適化</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- 店舗フィルター -->
                            <select id="marketing-store-filter" onchange="updateMarketingDashboard()" class="px-3 py-2 text-sm border border-surface-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white">
                                <option value="all">全店</option>
                                <option value="ebisu">恵比寿駅前店</option>
                                <option value="kadomori">大阪KADOMORI店</option>
                                <option value="fukushima">福島店</option>
                            </select>
                            <button onclick="refreshCustomerData()" id="refresh-customer-btn" class="btn-secondary py-2 px-4 flex items-center gap-2">
                                <i data-lucide="refresh-cw" class="w-4 h-4" id="refresh-customer-icon"></i>
                                <span class="text-sm">データ更新</span>
                            </button>
                            <div class="text-xs text-surface-500" id="customer-data-status">
                                データ未取得
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPI Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="marketing-kpi-grid">
                    <div class="kpi-card accent-primary p-5">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="users" class="w-4 h-4 text-primary-500"></i>
                            <span class="text-xs font-semibold text-surface-500 uppercase">総顧客数</span>
                        </div>
                        <p class="text-2xl font-display font-bold text-accent-900" id="mkt-total-customers">0</p>
                    </div>
                    <div class="kpi-card accent-navy p-5">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="calendar" class="w-4 h-4 text-accent-600"></i>
                            <span class="text-xs font-semibold text-surface-500 uppercase">今月新規</span>
                        </div>
                        <p class="text-2xl font-display font-bold text-accent-900" id="mkt-new-this-month">0</p>
                    </div>
                    <div class="kpi-card accent-success p-5">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="camera" class="w-4 h-4 text-emerald-500"></i>
                            <span class="text-xs font-semibold text-surface-500 uppercase">SNS許可率</span>
                        </div>
                        <p class="text-2xl font-display font-bold text-accent-900" id="mkt-sns-rate">0%</p>
                    </div>
                    <div class="kpi-card accent-gold p-5">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="star" class="w-4 h-4 text-amber-500"></i>
                            <span class="text-xs font-semibold text-surface-500 uppercase">平均年齢</span>
                        </div>
                        <p class="text-2xl font-display font-bold text-accent-900" id="mkt-avg-age">-</p>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Visit Reason Analysis -->
                    <div class="premium-card p-6">
                        <h3 class="text-lg font-display font-bold text-accent-900 mb-4 flex items-center gap-2">
                            <i data-lucide="map-pin" class="w-5 h-5 text-primary-500"></i>
                            来店理由分析
                        </h3>
                        <div class="chart-container h-64">
                            <canvas id="visitReasonChart"></canvas>
                        </div>
                        <div id="visit-reason-details" class="mt-4 space-y-2"></div>
                    </div>

                    <!-- Age Distribution -->
                    <div class="premium-card p-6">
                        <h3 class="text-lg font-display font-bold text-accent-900 mb-4 flex items-center gap-2">
                            <i data-lucide="cake" class="w-5 h-5 text-primary-500"></i>
                            年齢層分布
                        </h3>
                        <div class="chart-container h-64">
                            <canvas id="ageDistributionChart"></canvas>
                        </div>
                    </div>

                    <!-- Occupation Analysis -->
                    <div class="premium-card p-6">
                        <h3 class="text-lg font-display font-bold text-accent-900 mb-4 flex items-center gap-2">
                            <i data-lucide="briefcase" class="w-5 h-5 text-primary-500"></i>
                            職業分析
                        </h3>
                        <div class="chart-container h-64">
                            <canvas id="occupationChart"></canvas>
                        </div>
                    </div>

                    <!-- Geographic Analysis -->
                    <div class="premium-card p-6">
                        <h3 class="text-lg font-display font-bold text-accent-900 mb-4 flex items-center gap-2">
                            <i data-lucide="map" class="w-5 h-5 text-primary-500"></i>
                            地域分析
                        </h3>
                        <div id="geographic-analysis" class="space-y-3">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Menu Preferences -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Eyebrow Preferences -->
                    <div class="premium-card p-6">
                        <h3 class="text-lg font-display font-bold text-accent-900 mb-4 flex items-center gap-2">
                            <i data-lucide="eye" class="w-5 h-5 text-[#d49890]"></i>
                            眉毛メニュー希望分析
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-sm font-semibold text-surface-600 mb-2">お悩み TOP5</h4>
                                <div id="eyebrow-concerns-list" class="space-y-2"></div>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold text-surface-600 mb-2">希望の印象</h4>
                                <div id="eyebrow-impression-list" class="flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Menu Preferences -->
                    <div class="premium-card p-6">
                        <h3 class="text-lg font-display font-bold text-accent-900 mb-4 flex items-center gap-2">
                            <i data-lucide="sparkles" class="w-5 h-5 text-[#c99445]"></i>
                            メニュー希望分析
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-sm font-semibold text-surface-600 mb-2">デザインイメージ</h4>
                                <div id="eyelash-design-list" class="space-y-2"></div>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold text-surface-600 mb-2">目の見え方希望</h4>
                                <div id="eyelash-eyelook-list" class="flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer List -->
                <div class="premium-card p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                        <h3 class="text-lg font-display font-bold text-accent-900 flex items-center gap-2">
                            <i data-lucide="list" class="w-5 h-5 text-primary-500"></i>
                            顧客リスト
                        </h3>
                        <div class="flex items-center gap-2">
                            <input type="text" id="customer-search" placeholder="名前で検索..." class="select-premium text-sm py-2 px-3 w-48" onkeyup="filterCustomerList()">
                            <select id="customer-filter-sns" class="select-premium text-sm py-2 px-3" onchange="filterCustomerList()">
                                <option value="all">全て</option>
                                <option value="yes">SNS許可あり</option>
                                <option value="no">SNS許可なし</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-surface-200 bg-surface-50">
                                    <th class="text-left py-3 px-4 font-semibold text-accent-800">登録日</th>
                                    <th class="text-left py-3 px-4 font-semibold text-accent-800">名前</th>
                                    <th class="text-left py-3 px-4 font-semibold text-accent-800">年齢</th>
                                    <th class="text-left py-3 px-4 font-semibold text-accent-800">職業</th>
                                    <th class="text-left py-3 px-4 font-semibold text-accent-800">地域</th>
                                    <th class="text-center py-3 px-4 font-semibold text-accent-800">SNS</th>
                                    <th class="text-left py-3 px-4 font-semibold text-accent-800">来店理由</th>
                                </tr>
                            </thead>
                            <tbody id="customer-list-body">
                                <tr>
                                    <td colspan="7" class="text-center py-8 text-surface-500">
                                        設定タブでAPIを設定してください
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-between items-center text-sm text-surface-500">
                        <span id="customer-list-count">0件表示</span>
                        <div class="flex gap-2">
                            <button onclick="customerListPage(-1)" class="px-3 py-1 rounded border border-surface-200 hover:bg-surface-100">前へ</button>
                            <span id="customer-list-page">1</span>
                            <button onclick="customerListPage(1)" class="px-3 py-1 rounded border border-surface-200 hover:bg-surface-100">次へ</button>
                        </div>
                    </div>
                </div>

                <!-- カウンセリング回答 -->
                <div class="premium-card p-6">
                    <h3 class="text-lg font-display font-bold text-accent-900 mb-4 flex items-center gap-2">
                        <i data-lucide="clipboard-list" class="w-5 h-5 text-emerald-500"></i>
                        カウンセリング回答
                    </h3>
                    <div class="space-y-4">
                        <div class="flex flex-wrap gap-2">
                            <select id="admin-counseling-store-filter" onchange="renderAdminCounselingResults()" class="px-3 py-2 text-sm border border-surface-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white">
                                <option value="all">全店</option>
                                <option value="ebisu">恵比寿駅前店</option>
                                <option value="kadomori">大阪KADOMORI店</option>
                                <option value="fukushima">福島店</option>
                            </select>
                            <select id="admin-counseling-date-filter" onchange="renderAdminCounselingResults()" class="px-3 py-2 text-sm border border-surface-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white">
                                <option value="week">今週</option>
                                <option value="month" selected>今月</option>
                                <option value="all">全期間</option>
                            </select>
                            <input type="text" id="admin-counseling-search" placeholder="お客様名で検索" onkeyup="renderAdminCounselingResults()" class="flex-1 min-w-[200px] px-3 py-2 text-sm border border-surface-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                            <button onclick="refreshAdminCounselingResults()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition text-sm font-bold flex items-center gap-2">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                更新
                            </button>
                        </div>
                        <div class="text-sm text-surface-600">
                            件数: <span id="admin-counseling-count">0</span>件
                        </div>
                        <div id="admin-counseling-container" class="space-y-3 max-h-[600px] overflow-y-auto">
                            <div class="text-center py-8 text-surface-400">
                                <i data-lucide="clipboard-list" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                                <p class="text-sm">カウンセリング回答を読み込んでいます...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- TAB: CALENDAR VIEW -->
            <section id="content-calendar" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="bg-white rounded-lg shadow-sm border border-sleepy-200 p-6">
                    <!-- Calendar Header -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-serif font-bold text-sleepy-800">カレンダービュー</h2>
                            <p class="text-sm text-sleepy-500 mt-1">日別の売上を一目で確認</p>
                        </div>
                        <div class="flex flex-wrap items-center gap-3">
                            <!-- 店舗・スタッフセレクター -->
                            <select id="calendar-store-selector" onchange="handleCalendarStoreChange()" class="px-3 py-2 text-sm border border-sleepy-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-400">
                                <option value="all">全店舗</option>
                            </select>
                            <select id="calendar-staff-selector" onchange="renderCalendar()" class="px-3 py-2 text-sm border border-sleepy-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-400">
                                <option value="all">全スタッフ</option>
                            </select>
                            <!-- 月ナビゲーション -->
                            <div class="flex items-center gap-2 bg-sleepy-50 px-4 py-2 rounded-lg border border-sleepy-200">
                                <button onclick="changeCalendarMonth(-1)" class="p-2 hover:bg-sleepy-100 rounded transition-colors" title="前月">
                                    <span>◀</span>
                                </button>
                                <span id="calendar-month-display" class="text-lg font-bold text-sleepy-800 min-w-[120px] text-center">2025年1月</span>
                                <button onclick="changeCalendarMonth(1)" class="p-2 hover:bg-sleepy-100 rounded transition-colors" title="次月">
                                    <span>▶</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="overflow-x-auto">
                        <!-- Day Headers -->
                        <div class="grid grid-cols-7 gap-1 mb-2 min-w-[600px]">
                            <div class="text-center font-bold text-sm py-2 text-red-500">日</div>
                            <div class="text-center font-bold text-sm py-2 text-sleepy-800">月</div>
                            <div class="text-center font-bold text-sm py-2 text-sleepy-800">火</div>
                            <div class="text-center font-bold text-sm py-2 text-sleepy-800">水</div>
                            <div class="text-center font-bold text-sm py-2 text-sleepy-800">木</div>
                            <div class="text-center font-bold text-sm py-2 text-sleepy-800">金</div>
                            <div class="text-center font-bold text-sm py-2 text-blue-500">土</div>
                        </div>
                        <!-- Calendar Days -->
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 min-w-[600px]">
                            <!-- Generated by JavaScript -->
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="mt-6 pt-6 border-t border-sleepy-200">
                        <p class="text-xs text-sleepy-600 mb-2 font-semibold">売上レベル</p>
                        <div class="flex flex-wrap gap-3 text-xs">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-gray-100 border border-gray-200"></div>
                                <span class="text-sleepy-600">休業/データなし</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-blue-50 border border-blue-200"></div>
                                <span class="text-sleepy-600">~¥50,000</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-green-50 border border-green-200"></div>
                                <span class="text-sleepy-600">¥50,000~¥100,000</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-yellow-50 border border-yellow-200"></div>
                                <span class="text-sleepy-600">¥100,000~¥150,000</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-orange-50 border border-orange-200"></div>
                                <span class="text-sleepy-600">¥150,000~¥200,000</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-red-50 border border-red-200"></div>
                                <span class="text-sleepy-600">¥200,000~</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Selected Day Details -->
                <div id="calendar-day-details" class="hidden bg-white rounded-lg shadow-sm border border-sleepy-200 p-6">
                    <h3 class="text-lg font-serif font-bold text-sleepy-800 mb-4" id="calendar-day-title">0月0日の詳細</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4" id="calendar-day-stats">
                        <!-- Generated by JavaScript -->
                    </div>
                </div>

                <!-- Monthly Summary -->
                <div class="bg-white rounded-lg shadow-sm border border-sleepy-200 p-6">
                    <h3 class="text-lg font-serif font-bold text-sleepy-800 mb-4">月間サマリー</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-sleepy-50 rounded-lg p-4 border border-sleepy-200">
                            <p class="text-xs text-sleepy-500 mb-1">営業日数</p>
                            <p class="text-2xl font-bold text-sleepy-800" id="calendar-summary-days">0<span class="text-sm font-normal ml-1">日</span></p>
                        </div>
                        <div class="bg-sleepy-50 rounded-lg p-4 border border-sleepy-200">
                            <p class="text-xs text-sleepy-500 mb-1">月間総売上</p>
                            <p class="text-2xl font-bold text-sleepy-800" id="calendar-summary-sales">¥0</p>
                        </div>
                        <div class="bg-sleepy-50 rounded-lg p-4 border border-sleepy-200">
                            <p class="text-xs text-sleepy-500 mb-1">日平均売上</p>
                            <p class="text-2xl font-bold text-sleepy-800" id="calendar-summary-avg">¥0</p>
                        </div>
                        <div class="bg-sleepy-50 rounded-lg p-4 border border-sleepy-200">
                            <p class="text-xs text-sleepy-500 mb-1">最高売上日</p>
                            <p class="text-2xl font-bold text-sleepy-400" id="calendar-summary-max">¥0</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- TAB: KPI -->
            <section id="content-kpi" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white rounded p-6 border border-sleepy-200 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-sleepy-400"></div>
                        <h4 class="text-sm font-bold text-sleepy-800 mb-2">新規次回予約率(HPB)</h4>
                        <div class="text-4xl font-serif font-bold text-sleepy-400" id="kpi-rate-hpb-lg">0%</div>
                    </div>
                    <div class="bg-white rounded p-6 border border-sleepy-200 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-sleepy-800"></div>
                        <h4 class="text-sm font-bold text-sleepy-800 mb-2">既存次回予約率</h4>
                        <div class="text-4xl font-serif font-bold text-sleepy-800" id="kpi-rate-exist-lg">0%</div>
                    </div>
                    <div class="bg-white rounded p-6 border border-sleepy-200 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-sleepy-300"></div>
                        <h4 class="text-sm font-bold text-sleepy-800 mb-2">総次回予約率</h4>
                        <div class="text-4xl font-serif font-bold text-sleepy-300" id="kpi-rate-total-lg">0%</div>
                    </div>
                </div>
                <div class="bg-white rounded shadow-sm border border-sleepy-200 overflow-hidden mt-8">
                    <div class="px-6 py-4 bg-sleepy-50 border-b border-sleepy-200">
                        <h3 class="text-sm font-bold text-sleepy-800 uppercase">Daily Report (直近データ)</h3>
                    </div>
                    <div class="overflow-x-auto custom-scroll">
                        <table class="min-w-full divide-y divide-sleepy-200">
                            <thead class="bg-sleepy-100">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-sleepy-800 uppercase">店舗</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-sleepy-800 uppercase">スタッフ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-sleepy-800 uppercase">日付</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-sleepy-800 uppercase">売上</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-sleepy-800 uppercase">来店数</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-sleepy-800 uppercase">HPB予約率</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-sleepy-100" id="data-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- TAB: GOAL SETTING -->
            <section id="content-goal" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="bg-gradient-to-br from-sleepy-50 to-white rounded-lg shadow-lg border border-sleepy-200 overflow-hidden">
                    <div class="bg-sleepy-800 text-white px-6 py-4">
                        <h3 class="text-xl font-serif font-bold flex items-center gap-2">
                            <span class="text-2xl">🎯</span> 売上目標計算ツール
                        </h3>
                        <p class="text-xs text-sleepy-200 mt-1">月間目標金額と出勤日数を入力すると、過去の実績からデイリー目標を自動計算します</p>
                        <div class="mt-3 pt-3 border-t border-sleepy-700">
                            <p class="text-xs font-bold text-sleepy-200 mb-2">設定対象:</p>
                            <div class="flex flex-wrap items-center gap-3">
                                <!-- Month Selector for Goal Setting -->
                                <div class="relative">
                                    <select id="goal-month-selector" onchange="loadGoalInputs()" class="appearance-none bg-sleepy-900 border border-sleepy-700 text-white py-2 pl-4 pr-8 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400 font-medium text-sm cursor-pointer min-w-[140px]">
                                        <!-- Options will be populated by JavaScript -->
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white">▼</div>
                                </div>

                                <!-- Store Selector for Goal Setting -->
                                <div class="relative">
                                    <select id="goal-store-selector" onchange="handleGoalStoreChange()" class="appearance-none bg-sleepy-900 border border-sleepy-700 text-white py-2 pl-4 pr-8 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400 font-medium text-sm cursor-pointer min-w-[140px]">
                                        <option value="all">全店舗</option>
                                        <option value="ebisu">恵比寿駅前店</option>
                                        <option value="kadomori">大阪KADOMORI店</option>
                                        <option value="fukushima">福島店</option>
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white">▼</div>
                                </div>

                                <!-- Staff Selector for Goal Setting -->
                                <div class="relative">
                                    <select id="goal-staff-selector" onchange="loadGoalInputs()" class="appearance-none bg-sleepy-900 border border-sleepy-700 text-white py-2 pl-4 pr-8 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400 font-medium text-sm cursor-pointer min-w-[140px]">
                                        <option value="all">店舗合計</option>
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white">▼</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 md:p-8">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <!-- Input Form - Column 1: Days & Sales -->
                            <div id="goal-input-column-1" class="space-y-6">
                                <h4 class="text-sm font-bold text-sleepy-800 uppercase tracking-wider border-b border-sleepy-200 pb-2">出勤日数・売上</h4>

                                <!-- Monthly Target Amount -->
                                <div class="bg-gradient-to-br from-amber-50 to-orange-50 p-4 rounded border-2 border-amber-300">
                                    <label class="block text-sm font-bold text-amber-900 mb-2 flex items-center gap-2">
                                        <span>🎯</span> 月間目標金額 (円)
                                    </label>
                                    <input type="number" id="goal-monthly-target" value="1100000" min="0" step="10000"
                                           class="w-full px-4 py-3 border border-amber-300 rounded focus:outline-none focus:ring-2 focus:ring-amber-400 text-lg font-bold bg-white"
                                           onchange="calculateGoalFromMonthlyTarget()">
                                    <p class="text-xs text-amber-700 mt-1">達成したい月間売上目標を入力</p>
                                </div>

                                <!-- Weekday Days -->
                                <div class="bg-white p-4 rounded border border-sleepy-200">
                                    <label class="block text-sm font-bold text-sleepy-800 mb-2">平日出勤日数</label>
                                    <input type="number" id="goal-weekdays" value="20" min="0" max="31"
                                           class="w-full px-4 py-3 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400 text-lg font-medium"
                                           onchange="calculateGoalFromMonthlyTarget()">
                                    <p class="text-xs text-sleepy-500 mt-1">月間の平日出勤日数</p>
                                </div>

                                <!-- Weekend Days -->
                                <div class="bg-white p-4 rounded border border-sleepy-200">
                                    <label class="block text-sm font-bold text-sleepy-800 mb-2">休日出勤日数</label>
                                    <input type="number" id="goal-weekends" value="6" min="0" max="31"
                                           class="w-full px-4 py-3 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400 text-lg font-medium"
                                           onchange="calculateGoalFromMonthlyTarget()">
                                    <p class="text-xs text-sleepy-500 mt-1">月間の休日出勤日数</p>
                                </div>

                                <!-- Past Performance Info -->
                                <div class="bg-blue-50 p-4 rounded border border-blue-200">
                                    <div class="text-xs font-bold text-blue-800 mb-2 flex items-center gap-1">
                                        <span>📊</span> 過去の実績データ
                                    </div>
                                    <div class="space-y-1 text-xs text-blue-700">
                                        <div class="flex justify-between">
                                            <span>平日平均:</span>
                                            <span id="goal-past-weekday-avg" class="font-bold">計算中...</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>休日平均:</span>
                                            <span id="goal-past-weekend-avg" class="font-bold">計算中...</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>休日/平日比率:</span>
                                            <span id="goal-past-ratio" class="font-bold">計算中...</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Weekday Target (Auto-calculated) -->
                                <div class="bg-emerald-50 p-4 rounded border-2 border-emerald-300">
                                    <label class="block text-sm font-bold text-emerald-800 mb-2 flex items-center gap-2">
                                        <span>🔄</span> 平日の1日あたり目標売上 (円)
                                    </label>
                                    <div class="w-full px-4 py-3 border border-emerald-300 rounded bg-white text-lg font-bold text-emerald-700" id="goal-weekday-target-display">
                                        ¥40,000
                                    </div>
                                    <input type="hidden" id="goal-weekday-target" value="40000">
                                    <p class="text-xs text-emerald-600 mt-1">過去の実績から自動計算</p>
                                </div>

                                <!-- Weekend Target (Auto-calculated) -->
                                <div class="bg-purple-50 p-4 rounded border-2 border-purple-300">
                                    <label class="block text-sm font-bold text-purple-800 mb-2 flex items-center gap-2">
                                        <span>🔄</span> 休日の1日あたり目標売上 (円)
                                    </label>
                                    <div class="w-full px-4 py-3 border border-purple-300 rounded bg-white text-lg font-bold text-purple-700" id="goal-weekend-target-display">
                                        ¥50,000
                                    </div>
                                    <input type="hidden" id="goal-weekend-target" value="50000">
                                    <p class="text-xs text-purple-600 mt-1">過去の実績から自動計算</p>
                                </div>

                                <!-- Retail Sales Target -->
                                <div class="bg-white p-4 rounded border border-sleepy-200">
                                    <label class="block text-sm font-bold text-sleepy-800 mb-2">月間物販目標 (円)</label>
                                    <input type="number" id="goal-retail" value="50000" min="0" step="1000"
                                           class="w-full px-4 py-3 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-sleepy-500 mt-1">月間の物販売上目標</p>
                                </div>
                            </div>

                            <!-- Input Form - Column 2: Customer Targets -->
                            <div id="goal-input-column-2" class="space-y-6">
                                <h4 class="text-sm font-bold text-sleepy-800 uppercase tracking-wider border-b border-sleepy-200 pb-2">基本給・来店目標</h4>

                                <!-- Base Salary -->
                                <div class="bg-gradient-to-br from-green-50 to-white p-4 rounded border-2 border-green-300">
                                    <label class="block text-sm font-bold text-green-800 mb-2 flex items-center gap-2">
                                        <span>💰</span> 基本給 (円)
                                    </label>
                                    <input type="number" id="goal-base-salary" value="200000" min="0" step="1000"
                                           class="w-full px-4 py-3 border border-green-300 rounded focus:outline-none focus:ring-2 focus:ring-green-400 text-lg font-medium"
                                           onchange="saveBaseSalaryAndCalculate()">
                                    <p class="text-xs text-green-600 mt-1">インセンティブ計算に使用</p>
                                </div>

                                <!-- New Customers Target -->
                                <div class="bg-white p-4 rounded border border-sleepy-200">
                                    <label class="block text-sm font-bold text-sleepy-800 mb-2">月間新規数目標 (名)</label>
                                    <input type="number" id="goal-new-customers" value="30" min="0"
                                           class="w-full px-4 py-3 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-sleepy-500 mt-1">月間の新規顧客目標数</p>
                                </div>

                                <!-- Existing Customers Target -->
                                <div class="bg-white p-4 rounded border border-sleepy-200">
                                    <label class="block text-sm font-bold text-sleepy-800 mb-2">月間既存数目標 (名)</label>
                                    <input type="number" id="goal-existing-customers" value="90" min="0"
                                           class="w-full px-4 py-3 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-sleepy-500 mt-1">月間の既存顧客目標数</p>
                                </div>

                                <!-- Unit Price Target -->
                                <div class="bg-white p-4 rounded border border-sleepy-200">
                                    <label class="block text-sm font-bold text-sleepy-800 mb-2">目標客単価 (円)</label>
                                    <input type="number" id="goal-unit-price" value="9000" min="0" step="100"
                                           class="w-full px-4 py-3 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-sleepy-500 mt-1">目標とする平均客単価</p>
                                </div>

                                <!-- New Customer Next Reservation Rate Target -->
                                <div class="bg-white p-4 rounded border border-sleepy-200">
                                    <label class="block text-sm font-bold text-sleepy-800 mb-2">目標新規次回予約率 (%)</label>
                                    <input type="number" id="goal-new-reservation-rate" value="50" min="0" max="100"
                                           class="w-full px-4 py-3 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-sleepy-500 mt-1">新規顧客の次回予約率目標</p>
                                </div>

                                <!-- Overall Reservation Rate Target -->
                                <div class="bg-white p-4 rounded border border-sleepy-200">
                                    <label class="block text-sm font-bold text-sleepy-800 mb-2">目標次回予約率 (%)</label>
                                    <input type="number" id="goal-reservation-rate" value="70" min="0" max="100"
                                           class="w-full px-4 py-3 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-sleepy-500 mt-1">全体の次回予約率目標</p>
                                </div>

                                <!-- 5 Star Reviews Target -->
                                <div class="bg-white p-4 rounded border border-sleepy-200">
                                    <label class="block text-sm font-bold text-sleepy-800 mb-2">★5口コミ獲得目標 (件)</label>
                                    <input type="number" id="goal-reviews-5star" value="0" min="0"
                                           class="w-full px-4 py-3 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-sleepy-500 mt-1">月間の★5口コミ獲得目標</p>
                                </div>

                                <button onclick="calculateGoalFromMonthlyTarget()" class="w-full bg-amber-600 text-white py-3 rounded shadow hover:bg-amber-700 transition font-bold text-base flex items-center justify-center gap-2">
                                    <span>🔄</span> デイリー目標を自動計算
                                </button>

                                <button onclick="saveGoalsToSpreadsheet()" id="btn-save-goals" class="w-full bg-green-600 text-white py-3 rounded shadow hover:bg-green-700 transition font-bold text-base flex items-center justify-center gap-2">
                                    <span>☁</span> スプレッドシートに保存
                                </button>

                                <button onclick="loadGoalsFromSpreadsheet()" id="btn-load-goals" class="w-full bg-blue-600 text-white py-3 rounded shadow hover:bg-blue-700 transition font-bold text-base flex items-center justify-center gap-2">
                                    <span>⬇</span> スプレッドシートから読み込み
                                </button>
                            </div>

                            <!-- Store/All Summary Display (hidden by default, shown when viewing store or all) -->
                            <div id="goal-store-summary" class="lg:col-span-2 hidden">
                                <div class="bg-gradient-to-br from-sleepy-50 to-white p-6 rounded-lg border-2 border-sleepy-300">
                                    <h4 class="text-lg font-bold text-sleepy-800 mb-6 flex items-center gap-2">
                                        <span class="text-2xl">📊</span>
                                        <span id="goal-summary-title">店舗目標サマリー</span>
                                    </h4>
                                    <p class="text-sm text-sleepy-600 mb-6" id="goal-summary-description">
                                        この目標は所属スタッフの目標の合算値です。個別のスタッフを選択すると、個人目標を編集できます。
                                    </p>

                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                        <!-- Monthly Target -->
                                        <div class="bg-gradient-to-br from-amber-50 to-orange-50 p-4 rounded-lg border border-amber-200">
                                            <p class="text-xs font-bold text-amber-700 mb-1">月間目標金額</p>
                                            <p class="text-xl font-bold text-amber-900" id="summary-monthly-target">¥0</p>
                                        </div>

                                        <!-- Retail Target -->
                                        <div class="bg-white p-4 rounded-lg border border-sleepy-200">
                                            <p class="text-xs font-bold text-sleepy-500 mb-1">物販目標</p>
                                            <p class="text-xl font-bold text-sleepy-800" id="summary-retail">¥0</p>
                                        </div>

                                        <!-- New Customers -->
                                        <div class="bg-white p-4 rounded-lg border border-sleepy-200">
                                            <p class="text-xs font-bold text-sleepy-500 mb-1">新規数目標</p>
                                            <p class="text-xl font-bold text-sleepy-800" id="summary-new-customers">0名</p>
                                        </div>

                                        <!-- Existing Customers -->
                                        <div class="bg-white p-4 rounded-lg border border-sleepy-200">
                                            <p class="text-xs font-bold text-sleepy-500 mb-1">既存数目標</p>
                                            <p class="text-xl font-bold text-sleepy-800" id="summary-existing-customers">0名</p>
                                        </div>

                                        <!-- Unit Price (Average) -->
                                        <div class="bg-white p-4 rounded-lg border border-sleepy-200">
                                            <p class="text-xs font-bold text-sleepy-500 mb-1">目標客単価 (平均)</p>
                                            <p class="text-xl font-bold text-sleepy-800" id="summary-unit-price">¥0</p>
                                        </div>

                                        <!-- Reservation Rate (Average) -->
                                        <div class="bg-white p-4 rounded-lg border border-sleepy-200">
                                            <p class="text-xs font-bold text-sleepy-500 mb-1">目標予約率 (平均)</p>
                                            <p class="text-xl font-bold text-sleepy-800" id="summary-reservation-rate">0%</p>
                                        </div>
                                    </div>

                                    <!-- Staff breakdown -->
                                    <div class="mt-6 pt-6 border-t border-sleepy-200">
                                        <h5 class="text-sm font-bold text-sleepy-700 mb-4">スタッフ別内訳</h5>
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-sm">
                                                <thead>
                                                    <tr class="bg-sleepy-100 text-sleepy-700">
                                                        <th class="py-2 px-3 text-left font-bold">スタッフ</th>
                                                        <th class="py-2 px-3 text-right font-bold">月間目標</th>
                                                        <th class="py-2 px-3 text-right font-bold">物販</th>
                                                        <th class="py-2 px-3 text-right font-bold">新規</th>
                                                        <th class="py-2 px-3 text-right font-bold">既存</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="goal-staff-breakdown-body">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Results Display -->
                            <div class="space-y-6">
                                <h4 class="text-sm font-bold text-sleepy-800 uppercase tracking-wider border-b border-sleepy-200 pb-2">計算結果</h4>

                                <div class="bg-gradient-to-br from-sleepy-800 to-sleepy-900 text-white p-6 rounded-lg shadow-lg">
                                    <p class="text-xs font-bold text-sleepy-200 uppercase tracking-wider mb-2">月間売上目標</p>
                                    <div class="text-4xl font-serif font-bold" id="goal-total">¥1,100,000</div>
                                    <div class="mt-4 pt-4 border-t border-sleepy-700 space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-sleepy-300">平日売上:</span>
                                            <span class="font-bold" id="goal-weekday-total">¥800,000</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sleepy-300">休日売上:</span>
                                            <span class="font-bold" id="goal-weekend-total">¥300,000</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sleepy-300">物販目標:</span>
                                            <span class="font-bold" id="goal-retail-display">¥50,000</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white p-6 rounded border border-sleepy-200">
                                    <p class="text-xs font-bold text-sleepy-400 uppercase tracking-wider mb-4">売上達成状況</p>
                                    <div class="space-y-4">
                                        <div>
                                            <div class="flex justify-between text-sm mb-1">
                                                <span class="text-sleepy-600">現在の売上</span>
                                                <span class="font-bold text-sleepy-800" id="goal-current-sales">¥0</span>
                                            </div>
                                            <div class="w-full bg-sleepy-100 h-3 rounded-full overflow-hidden">
                                                <div class="bg-sleepy-400 h-3 transition-all duration-500" id="goal-progress-bar" style="width:0%"></div>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-sleepy-500">達成率</span>
                                            <span class="text-2xl font-serif font-bold text-sleepy-800" id="goal-percentage">0%</span>
                                        </div>
                                        <div class="flex justify-between items-center pt-4 border-t border-sleepy-200">
                                            <span class="text-xs text-sleepy-500">目標まで残り</span>
                                            <span class="text-lg font-bold text-sleepy-600" id="goal-remaining">¥1,100,000</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white p-6 rounded border border-sleepy-200">
                                    <p class="text-xs font-bold text-sleepy-400 uppercase tracking-wider mb-4">来店数・客単価・予約率</p>
                                    <div class="space-y-3 text-sm">
                                        <div class="flex justify-between items-center border-b border-sleepy-100 pb-2">
                                            <span class="text-sleepy-600">新規数</span>
                                            <div class="flex gap-2 items-center">
                                                <span class="text-sleepy-500" id="goal-new-current">0</span>
                                                <span class="text-sleepy-400">/</span>
                                                <span class="font-bold text-sleepy-800" id="goal-new-target">30名</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center border-b border-sleepy-100 pb-2">
                                            <span class="text-sleepy-600">既存数</span>
                                            <div class="flex gap-2 items-center">
                                                <span class="text-sleepy-500" id="goal-existing-current">0</span>
                                                <span class="text-sleepy-400">/</span>
                                                <span class="font-bold text-sleepy-800" id="goal-existing-target">90名</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center border-b border-sleepy-100 pb-2">
                                            <span class="text-sleepy-600">客単価</span>
                                            <div class="flex gap-2 items-center">
                                                <span class="text-sleepy-500" id="goal-unit-price-current">¥0</span>
                                                <span class="text-sleepy-400">/</span>
                                                <span class="font-bold text-sleepy-800" id="goal-unit-price-target">¥9,000</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center border-b border-sleepy-100 pb-2">
                                            <span class="text-sleepy-600">新規次回予約率</span>
                                            <div class="flex gap-2 items-center">
                                                <span class="text-sleepy-500" id="goal-new-res-rate-current">0%</span>
                                                <span class="text-sleepy-400">/</span>
                                                <span class="font-bold text-sleepy-800" id="goal-new-res-rate-target">50%</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sleepy-600">次回予約率</span>
                                            <div class="flex gap-2 items-center">
                                                <span class="text-sleepy-500" id="goal-res-rate-current">0%</span>
                                                <span class="text-sleepy-400">/</span>
                                                <span class="font-bold text-sleepy-800" id="goal-res-rate-target">70%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-sleepy-50 p-4 rounded border-l-4 border-sleepy-400">
                                    <p class="text-xs font-bold text-sleepy-800 mb-1">💡 ヒント</p>
                                    <p class="text-xs text-sleepy-600" id="goal-hint-text">各項目の目標を設定して、達成状況を確認できます。現在の数値は選択中のスタッフ・店舗のデータから自動計算されます。</p>
                                </div>

                                <div class="bg-green-50 p-4 rounded border-l-4 border-green-500" id="goal-save-notice" style="display:none;">
                                    <p class="text-xs font-bold text-green-800 mb-1">✓ 保存完了</p>
                                    <p class="text-xs text-green-600">目標が自動保存されました。スタッフダッシュボードに反映されます。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- TAB: EDIT -->
            <section id="content-edit" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="bg-sleepy-100 p-4 rounded border-l-4 border-sleepy-800 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <p class="text-sm text-sleepy-800 font-bold">データ修正モード</p>
                        <p class="text-xs text-sleepy-600">修正して「保存」を押すと、スプレッドシート本体が更新されます。</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="applyEditsLocally()" id="btn-preview-edit" class="bg-white border border-sleepy-300 text-sleepy-600 px-4 py-2 rounded hover:bg-sleepy-50 transition text-sm font-bold">
                            表示のみ更新 (プレビュー)
                        </button>
                        <button onclick="saveToSpreadsheet()" id="btn-save-sheet" class="bg-sleepy-800 text-white px-6 py-2 rounded shadow hover:bg-sleepy-900 transition text-sm font-bold flex items-center gap-2">
                            <span>☁</span> スプレッドシートに保存
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded shadow-sm border border-sleepy-200 overflow-hidden">
                    <div class="overflow-x-auto custom-scroll" style="max-height: 70vh;">
                        <table class="min-w-full divide-y divide-sleepy-200" id="edit-table">
                            <thead class="bg-sleepy-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-sleepy-800 whitespace-nowrap">日付</th>
                                    <th id="edit-th-store" class="px-4 py-3 text-left text-xs font-medium text-sleepy-800 whitespace-nowrap">店舗</th>
                                    <th id="edit-th-staff" class="px-4 py-3 text-left text-xs font-medium text-sleepy-800 whitespace-nowrap">スタッフ</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">売上(現金)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">売上(クレカ)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">売上(QR)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">物販</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">HPBポイント</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">HPBギフト</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">その他割引</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">返金</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">HPB新規</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">Mini/Nailie新規</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">既存</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">知り合い価格</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">次回予約(HPB新規)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">次回予約(Mini新規)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">次回予約(既存)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">★5口コミ</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">ブログ</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-sleepy-800 whitespace-nowrap">SNS</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-sleepy-100" id="edit-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- TAB: MEMBERSHIP & TICKETS -->
            <section id="content-membership" class="tab-content hidden">
                <h2 class="text-2xl font-display font-bold text-accent-800 mb-6 flex items-center gap-2">
                    <i data-lucide="credit-card" class="w-6 h-6 text-primary-500"></i>
                    会員・回数券管理
                </h2>

                <!-- Sub-tab navigation -->
                <div class="flex gap-2 mb-6">
                    <button onclick="switchMembershipSubTab('subscription')" id="membership-subtab-subscription" class="membership-subtab-btn px-4 py-2 rounded-lg text-sm font-medium bg-accent-700 text-white">サブスク会員管理</button>
                    <button onclick="switchMembershipSubTab('tickets')" id="membership-subtab-tickets" class="membership-subtab-btn px-4 py-2 rounded-lg text-sm font-medium bg-surface-200 text-surface-600">回数券管理</button>
                </div>

                <!-- ===== SUBSCRIPTION MANAGEMENT ===== -->
                <div id="membership-content-subscription">
                    <!-- Store & Month Selectors -->
                    <div class="premium-card p-6 mb-6">
                        <div class="flex flex-wrap items-end gap-4">
                            <div>
                                <label class="block text-xs font-medium text-surface-600 mb-1">店舗</label>
                                <select id="sub-store-selector" onchange="renderSubscriptionDashboard()" class="px-3 py-2 border border-sleepy-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-400">
                                    <option value="all">全店舗</option>
                                    <option value="ebisu">恵比寿駅前店</option>
                                    <option value="kadomori">大阪KADOMORI店</option>
                                    <option value="fukushima">福島店</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-surface-600 mb-1">表示月</label>
                                <input type="month" id="sub-month-selector" onchange="renderSubscriptionDashboard()" class="px-3 py-2 border border-sleepy-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-400">
                            </div>
                            <button onclick="openSubscriptionEditModal()" class="btn-primary py-2 px-4 text-sm flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i>月次データ登録
                            </button>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="premium-card p-4 text-center">
                            <p class="text-xs text-surface-500 mb-1">現在の会員数</p>
                            <p class="text-3xl font-bold text-accent-800" id="sub-current-members">0</p>
                            <p class="text-xs text-surface-400">名</p>
                        </div>
                        <div class="premium-card p-4 text-center">
                            <p class="text-xs text-surface-500 mb-1">当月入会</p>
                            <p class="text-3xl font-bold text-sage-500" id="sub-new-members">0</p>
                            <p class="text-xs text-surface-400">名</p>
                        </div>
                        <div class="premium-card p-4 text-center">
                            <p class="text-xs text-surface-500 mb-1">当月退会</p>
                            <p class="text-3xl font-bold text-rose-500" id="sub-cancelled-members">0</p>
                            <p class="text-xs text-surface-400">名</p>
                        </div>
                        <div class="premium-card p-4 text-center">
                            <p class="text-xs text-surface-500 mb-1">月間増減</p>
                            <p class="text-3xl font-bold" id="sub-net-change">0</p>
                            <p class="text-xs text-surface-400">名</p>
                        </div>
                    </div>

                    <!-- Membership Rate & Revenue -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="premium-card p-4 text-center">
                            <p class="text-xs text-surface-500 mb-1">サブスク月間売上</p>
                            <p class="text-2xl font-bold text-primary-500" id="sub-monthly-revenue">¥0</p>
                        </div>
                        <div class="premium-card p-4 text-center">
                            <p class="text-xs text-surface-500 mb-1">平均継続率（直近6ヶ月）</p>
                            <p class="text-2xl font-bold text-accent-700" id="sub-retention-rate">--%</p>
                        </div>
                    </div>

                    <!-- Monthly Trend Table -->
                    <div class="premium-card p-6">
                        <h3 class="text-lg font-display font-bold text-accent-900 mb-4">月別推移</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b-2 border-sleepy-300">
                                        <th class="py-2 px-3 text-left text-xs font-medium text-sleepy-800">月</th>
                                        <th class="py-2 px-3 text-center text-xs font-medium text-sleepy-800">月初会員数</th>
                                        <th class="py-2 px-3 text-center text-xs font-medium text-sleepy-800">入会</th>
                                        <th class="py-2 px-3 text-center text-xs font-medium text-sleepy-800">退会</th>
                                        <th class="py-2 px-3 text-center text-xs font-medium text-sleepy-800">月末会員数</th>
                                        <th class="py-2 px-3 text-center text-xs font-medium text-sleepy-800">増減</th>
                                        <th class="py-2 px-3 text-center text-xs font-medium text-sleepy-800">継続率</th>
                                        <th class="py-2 px-3 text-center text-xs font-medium text-sleepy-800">月額単価</th>
                                        <th class="py-2 px-3 text-center text-xs font-medium text-sleepy-800">月間売上</th>
                                        <th class="py-2 px-3 text-center text-xs font-medium text-sleepy-800">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="sub-trend-table-body" class="divide-y divide-sleepy-100">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ===== TICKET MANAGEMENT ===== -->
                <div id="membership-content-tickets" class="hidden">
                    <!-- Store Selector & Add -->
                    <div class="premium-card p-6 mb-6">
                        <div class="flex flex-wrap items-end gap-4">
                            <div>
                                <label class="block text-xs font-medium text-surface-600 mb-1">店舗</label>
                                <select id="ticket-store-selector" onchange="renderTicketDashboard()" class="px-3 py-2 border border-sleepy-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-400">
                                    <option value="all">全店舗</option>
                                    <option value="ebisu">恵比寿駅前店</option>
                                    <option value="kadomori">大阪KADOMORI店</option>
                                    <option value="fukushima">福島店</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-surface-600 mb-1">ステータス</label>
                                <select id="ticket-status-filter" onchange="renderTicketDashboard()" class="px-3 py-2 border border-sleepy-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-400">
                                    <option value="active">利用中</option>
                                    <option value="all">すべて</option>
                                    <option value="completed">消化済</option>
                                    <option value="expired">期限切れ</option>
                                </select>
                            </div>
                            <button onclick="openTicketModal()" class="btn-primary py-2 px-4 text-sm flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i>回数券を登録
                            </button>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="premium-card p-4 text-center">
                            <p class="text-xs text-surface-500 mb-1">有効回数券</p>
                            <p class="text-3xl font-bold text-accent-800" id="ticket-active-count">0</p>
                            <p class="text-xs text-surface-400">件</p>
                        </div>
                        <div class="premium-card p-4 text-center">
                            <p class="text-xs text-surface-500 mb-1">残回数合計</p>
                            <p class="text-3xl font-bold text-primary-500" id="ticket-remaining-count">0</p>
                            <p class="text-xs text-surface-400">回</p>
                        </div>
                        <div class="premium-card p-4 text-center">
                            <p class="text-xs text-surface-500 mb-1">残役務金額</p>
                            <p class="text-2xl font-bold text-rose-500" id="ticket-remaining-amount">¥0</p>
                        </div>
                        <div class="premium-card p-4 text-center">
                            <p class="text-xs text-surface-500 mb-1">消化率</p>
                            <p class="text-3xl font-bold text-sage-500" id="ticket-usage-rate">0%</p>
                        </div>
                    </div>

                    <!-- Ticket List -->
                    <div class="premium-card p-6">
                        <h3 class="text-lg font-display font-bold text-accent-900 mb-4">回数券一覧</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b-2 border-sleepy-300">
                                        <th class="py-2 px-3 text-left text-xs font-medium text-sleepy-800">顧客名</th>
                                        <th class="py-2 px-3 text-left text-xs font-medium text-sleepy-800">店舗</th>
                                        <th class="py-2 px-3 text-left text-xs font-medium text-sleepy-800">券種</th>
                                        <th class="py-2 px-3 text-center text-xs font-medium text-sleepy-800">購入日</th>
                                        <th class="py-2 px-3 text-center text-xs font-medium text-sleepy-800">総回数</th>
                                        <th class="py-2 px-3 text-center text-xs font-medium text-sleepy-800">使用済</th>
                                        <th class="py-2 px-3 text-center text-xs font-medium text-sleepy-800">残回数</th>
                                        <th class="py-2 px-3 text-right text-xs font-medium text-sleepy-800">金額</th>
                                        <th class="py-2 px-3 text-right text-xs font-medium text-sleepy-800">残役務額</th>
                                        <th class="py-2 px-3 text-center text-xs font-medium text-sleepy-800">有効期限</th>
                                        <th class="py-2 px-3 text-center text-xs font-medium text-sleepy-800">状態</th>
                                        <th class="py-2 px-3 text-center text-xs font-medium text-sleepy-800">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="ticket-table-body" class="divide-y divide-sleepy-100">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Modal: Subscription Edit -->
            <div id="subscription-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
                    <h3 class="text-lg font-display font-bold text-accent-800 mb-4">サブスク月次データ登録</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-surface-600 mb-1">対象月</label>
                            <input type="month" id="sub-edit-month" class="w-full px-3 py-2 border border-sleepy-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-surface-600 mb-1">店舗</label>
                            <select id="sub-edit-store" class="w-full px-3 py-2 border border-sleepy-300 rounded-lg text-sm">
                                <option value="ebisu">恵比寿駅前店</option>
                                <option value="kadomori">大阪KADOMORI店</option>
                                <option value="fukushima">福島店</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-surface-600 mb-1">月初会員数</label>
                            <input type="number" id="sub-edit-start" min="0" value="0" class="w-full px-3 py-2 border border-sleepy-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-surface-600 mb-1">当月入会数</label>
                            <input type="number" id="sub-edit-new" min="0" value="0" class="w-full px-3 py-2 border border-sleepy-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-surface-600 mb-1">当月退会数</label>
                            <input type="number" id="sub-edit-cancelled" min="0" value="0" class="w-full px-3 py-2 border border-sleepy-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-surface-600 mb-1">月額単価 (¥)</label>
                            <input type="number" id="sub-edit-fee" min="0" value="9800" class="w-full px-3 py-2 border border-sleepy-300 rounded-lg text-sm">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="saveSubscriptionData()" class="flex-1 btn-primary py-2 text-sm">保存</button>
                        <button onclick="closeSubscriptionModal()" class="flex-1 btn-secondary py-2 text-sm">キャンセル</button>
                    </div>
                </div>
            </div>

            <!-- Modal: Ticket Edit -->
            <div id="ticket-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
                    <h3 class="text-lg font-display font-bold text-accent-800 mb-4" id="ticket-modal-title">回数券登録</h3>
                    <input type="hidden" id="ticket-edit-id">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-surface-600 mb-1">顧客名</label>
                            <input type="text" id="ticket-edit-customer" placeholder="例: 田中太郎" class="w-full px-3 py-2 border border-sleepy-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-surface-600 mb-1">店舗</label>
                            <select id="ticket-edit-store" class="w-full px-3 py-2 border border-sleepy-300 rounded-lg text-sm">
                                <option value="ebisu">恵比寿駅前店</option>
                                <option value="kadomori">大阪KADOMORI店</option>
                                <option value="fukushima">福島店</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-surface-600 mb-1">券種名</label>
                            <input type="text" id="ticket-edit-name" placeholder="例: 5回券" class="w-full px-3 py-2 border border-sleepy-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-surface-600 mb-1">購入日</label>
                            <input type="date" id="ticket-edit-date" class="w-full px-3 py-2 border border-sleepy-300 rounded-lg text-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-surface-600 mb-1">総回数</label>
                                <input type="number" id="ticket-edit-total" min="1" value="5" class="w-full px-3 py-2 border border-sleepy-300 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-surface-600 mb-1">使用済回数</label>
                                <input type="number" id="ticket-edit-used" min="0" value="0" class="w-full px-3 py-2 border border-sleepy-300 rounded-lg text-sm">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-surface-600 mb-1">金額 (¥)</label>
                            <input type="number" id="ticket-edit-price" min="0" value="0" class="w-full px-3 py-2 border border-sleepy-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-surface-600 mb-1">有効期限</label>
                            <input type="date" id="ticket-edit-expiry" class="w-full px-3 py-2 border border-sleepy-300 rounded-lg text-sm">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="saveTicket()" class="flex-1 btn-primary py-2 text-sm">保存</button>
                        <button onclick="closeTicketModal()" class="flex-1 btn-secondary py-2 text-sm">キャンセル</button>
                    </div>
                </div>
            </div>

            <!-- TAB: SETTINGS -->
            <section id="content-settings" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="bg-gradient-to-br from-sleepy-50 to-white rounded-lg shadow-lg border border-sleepy-200 overflow-hidden">
                    <div class="bg-sleepy-800 text-white px-6 py-4">
                        <h3 class="text-xl font-serif font-bold flex items-center gap-2">
                            <span class="text-2xl">⚙</span> スタッフ・店舗管理
                        </h3>
                        <p class="text-xs text-sleepy-200 mt-1">スタッフと店舗の追加・削除を行います</p>
                    </div>

                    <div class="p-6 md:p-8 space-y-8">
                        <!-- Spreadsheet API Settings -->
                        <div class="bg-white p-6 rounded-lg border border-sleepy-200" id="spreadsheet-api-settings">
                            <h4 class="text-lg font-bold text-sleepy-800 mb-4 flex items-center gap-2">
                                <i data-lucide="table" class="w-5 h-5 text-primary-500"></i>
                                スプレッドシート連携設定
                            </h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold text-sleepy-600 mb-2">Google Apps Script Web App URL</label>
                                    <input type="text" id="spreadsheet-api-url" placeholder="https://script.google.com/macros/s/..." class="w-full px-4 py-2 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400">
                                    <p class="text-xs text-sleepy-500 mt-1">※ページを開くたびに自動でデータを取得します</p>
                                </div>
                                <div class="flex gap-2 flex-wrap">
                                    <button onclick="saveSpreadsheetApiUrl()" class="bg-sleepy-700 text-white px-6 py-2 rounded hover:bg-sleepy-800 transition font-bold flex items-center gap-2">
                                        <i data-lucide="save" class="w-4 h-4"></i>
                                        保存
                                    </button>
                                    <button onclick="testSpreadsheetConnection()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition font-bold flex items-center gap-2">
                                        <i data-lucide="wifi" class="w-4 h-4"></i>
                                        接続テスト
                                    </button>
                                </div>
                                <div id="spreadsheet-connection-status" class="hidden"></div>
                                <div class="bg-sleepy-50 p-4 rounded border-l-4 border-primary-500">
                                    <p class="text-xs font-bold text-sleepy-800 mb-2">📋 設定手順</p>
                                    <ol class="text-xs text-sleepy-600 space-y-1 list-decimal list-inside">
                                        <li>Google スプレッドシートを開きます</li>
                                        <li>「拡張機能」→「Apps Script」を選択</li>
                                        <li>データ取得用のスクリプトを作成し、Web Appとしてデプロイ</li>
                                        <li>生成されたURLをこちらに貼り付けてください</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Data API Settings -->
                        <div class="bg-white p-6 rounded-lg border border-sleepy-200" id="customer-api-settings">
                            <h4 class="text-lg font-bold text-sleepy-800 mb-4 flex items-center gap-2">
                                <i data-lucide="users" class="w-5 h-5 text-emerald-500"></i>
                                顧客データ連携設定（マーケティング用）
                            </h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold text-sleepy-600 mb-2">顧客データ API URL</label>
                                    <input type="text" id="customer-api-url" placeholder="https://script.google.com/macros/s/..." class="w-full px-4 py-2 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400">
                                    <p class="text-xs text-sleepy-500 mt-1">※Googleフォームの回答が保存されているスプレッドシートのAPI URL</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="saveCustomerApiUrl()" class="bg-sleepy-700 text-white px-6 py-2 rounded hover:bg-sleepy-800 transition font-bold flex items-center gap-2">
                                        <i data-lucide="save" class="w-4 h-4"></i>
                                        保存
                                    </button>
                                    <button onclick="testCustomerApiConnection()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition font-bold flex items-center gap-2">
                                        <i data-lucide="wifi" class="w-4 h-4"></i>
                                        接続テスト
                                    </button>
                                </div>
                                <div id="customer-api-connection-status" class="hidden"></div>
                                <div class="bg-emerald-50 p-4 rounded border-l-4 border-emerald-500">
                                    <p class="text-xs font-bold text-sleepy-800 mb-2">📝 顧客データ連携について</p>
                                    <p class="text-xs text-sleepy-600 mb-2">Googleフォームで収集した顧客情報をマーケティング分析に活用できます。</p>
                                    <p class="text-xs text-sleepy-600">設定後、「マーケティング」タブで年齢層・地域・来店理由などの分析が可能になります。</p>
                                </div>
                            </div>
                        </div>

                        <!-- API Key Settings -->
                        <div class="bg-white p-6 rounded-lg border border-sleepy-200" id="gemini-api-settings">
                            <h4 class="text-lg font-bold text-sleepy-800 mb-4 flex items-center gap-2">
                                <span>💡</span> Gemini API設定
                            </h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold text-sleepy-600 mb-2">Gemini APIキー</label>
                                    <input type="password" id="gemini-api-key" placeholder="APIキーを入力" class="w-full px-4 py-2 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400">
                                    <p class="text-xs text-sleepy-500 mt-1">※目標達成アドバイス機能で使用します</p>
                                </div>
                                <button onclick="saveGeminiApiKey()" class="bg-sleepy-700 text-white px-6 py-2 rounded hover:bg-sleepy-800 transition font-bold">保存</button>
                                <div class="bg-sleepy-50 p-3 rounded border-l-4 border-sleepy-400">
                                    <p class="text-xs font-bold text-sleepy-800 mb-1">💡 Gemini APIキーの取得方法</p>
                                    <p class="text-xs text-sleepy-600">Google AI Studioから無料でAPIキーを取得できます: <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline">https://aistudio.google.com/app/apikey</a></p>
                                </div>
                            </div>
                        </div>

                        <!-- Store Management -->
                        <div class="bg-white p-6 rounded-lg border border-sleepy-200">
                            <h4 class="text-lg font-bold text-sleepy-800 mb-4 flex items-center gap-2">
                                <span>🏢</span> 店舗管理
                            </h4>
                            <div class="space-y-4">
                                <div class="flex gap-2">
                                    <input type="text" id="new-store-id" placeholder="店舗ID (例: shinjuku)" class="flex-1 px-4 py-2 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400">
                                    <input type="text" id="new-store-name" placeholder="店舗名 (例: 新宿店)" class="flex-1 px-4 py-2 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400">
                                    <button onclick="addStore()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition font-bold">追加</button>
                                </div>
                                <div class="mt-4">
                                    <h5 class="text-sm font-bold text-sleepy-600 mb-2">現在の店舗:</h5>
                                    <div id="store-list" class="space-y-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Staff Management -->
                        <div class="bg-white p-6 rounded-lg border border-sleepy-200">
                            <h4 class="text-lg font-bold text-sleepy-800 mb-4 flex items-center gap-2">
                                <span>👥</span> スタッフ管理
                            </h4>
                            <div class="space-y-4">
                                <div class="flex gap-2">
                                    <select id="staff-store-selector" class="px-4 py-2 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400">
                                        <option value="">店舗を選択</option>
                                    </select>
                                    <input type="text" id="new-staff-name" placeholder="スタッフ名 (例: kiki)" class="flex-1 px-4 py-2 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400">
                                    <button onclick="addStaff()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition font-bold">追加</button>
                                </div>
                                <div class="mt-4">
                                    <h5 class="text-sm font-bold text-sleepy-600 mb-2">現在のスタッフ:</h5>
                                    <div id="staff-list" class="space-y-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Staff Password Management -->
                        <div class="bg-white p-6 rounded-lg border border-sleepy-200" id="staff-password-settings">
                            <h4 class="text-lg font-bold text-sleepy-800 mb-4 flex items-center gap-2">
                                <i data-lucide="lock" class="w-5 h-5 text-primary-500"></i>
                                スタッフログインパスワード設定
                            </h4>
                            <div class="space-y-4">
                                <p class="text-sm text-sleepy-600">各スタッフの専用ページ（URLパラメータでアクセス）にパスワード認証を設定できます。</p>
                                <div class="flex gap-2 flex-wrap">
                                    <select id="password-store-selector" onchange="updatePasswordStaffSelector()" class="px-4 py-2 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400">
                                        <option value="">店舗を選択</option>
                                    </select>
                                    <select id="password-staff-selector" class="px-4 py-2 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400">
                                        <option value="">スタッフを選択</option>
                                    </select>
                                    <input type="password" id="staff-password-input" placeholder="パスワード（空白で無効化）" class="flex-1 min-w-[150px] px-4 py-2 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400">
                                    <button onclick="saveStaffPasswordSettings()" class="bg-primary-500 text-white px-6 py-2 rounded hover:bg-primary-600 transition font-bold flex items-center gap-2">
                                        <i data-lucide="save" class="w-4 h-4"></i>
                                        保存
                                    </button>
                                </div>
                                <div id="staff-password-status" class="hidden"></div>
                                <div class="mt-4">
                                    <h5 class="text-sm font-bold text-sleepy-600 mb-2">パスワード設定状況:</h5>
                                    <div id="staff-password-list" class="space-y-2"></div>
                                </div>
                                <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-400">
                                    <p class="text-xs font-bold text-blue-800 mb-1">🔐 スタッフ専用ページのURL例</p>
                                    <p class="text-xs text-blue-600 font-mono">?store=ebisu&staff=yuki</p>
                                    <p class="text-xs text-sleepy-600 mt-2">パスワードを設定すると、スタッフはログイン後に自分のダッシュボードを確認できます。</p>
                                </div>
                            </div>
                        </div>

                        <!-- 管理ページパスワード設定 -->
                        <div class="bg-white p-6 rounded-lg border border-sleepy-200">
                            <h4 class="text-lg font-bold text-sleepy-800 mb-4 flex items-center gap-2">
                                <i data-lucide="shield" class="w-5 h-5 text-red-500"></i>
                                管理ページパスワード設定
                            </h4>
                            <div class="space-y-4">
                                <p class="text-sm text-sleepy-600">管理ページ（設定タブ）へのアクセスにパスワード認証を設定します。</p>
                                <div class="flex gap-2">
                                    <input type="password" id="admin-password-input" placeholder="新しいパスワード（空白で無効化）" class="flex-1 px-4 py-2 border border-sleepy-300 rounded focus:outline-none focus:ring-2 focus:ring-sleepy-400">
                                    <button onclick="saveAdminPassword()" class="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700 transition font-bold flex items-center gap-2">
                                        <i data-lucide="save" class="w-4 h-4"></i>
                                        保存
                                    </button>
                                </div>
                                <div id="admin-password-status" class="hidden"></div>
                                <div class="bg-red-50 p-4 rounded border-l-4 border-red-400">
                                    <p class="text-xs font-bold text-red-800 mb-1">⚠️ 重要</p>
                                    <p class="text-xs text-red-700">パスワードを設定すると、この管理ページを開くたびにパスワードの入力が必要になります。パスワードは忘れないようにしてください。</p>
                                    <p class="text-xs text-red-700 mt-2">※設定したパスワードはGoogleスプレッドシートの「ダッシュボード設定」シートに保存されます。</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded border-l-4 border-yellow-400">
                            <p class="text-xs font-bold text-yellow-800 mb-1">⚠️ 注意</p>
                            <p class="text-xs text-yellow-700">スタッフや店舗を削除すると、関連する目標データも削除されます。削除は慎重に行ってください。</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        
        <footer class="bg-sleepy-900 text-sleepy-300 py-8 mt-12 text-center text-xs">
            <p>&copy; 睡眠整体SLEEPY</p>
        </footer>
    </div>

    <!-- Application Logic -->
    <script>
        // ★ スプレッドシートAPI設定
        const SPREADSHEET_API_KEY = 'sleepy_spreadsheet_api_url';

        // デフォルトのAPI URL（コードに埋め込み）
        const DEFAULT_API_URL = 'https://script.google.com/macros/s/AKfycbwrz7LgQb2uH9VTtmalZxIEcJnHc-Ae53UNMnDi0MM5eLdP7XmZKOlDPTaOL5pmsFwf/exec';

        // API URL（デフォルトURLを使用）
        let API_URL = DEFAULT_API_URL;

        // スタッフ名簿（スプレッドシートから読み込み、未設定時はデフォルト値）
        let STAFF_ROSTER = {
            ebisu: ['yuki', 'ren'],
            kadomori: ['sora', 'hina'],
            fukushima: ['aoi']
        };
        const DEFAULT_STAFF_ROSTER = {
            ebisu: ['yuki', 'ren'],
            kadomori: ['sora', 'hina'],
            fukushima: ['aoi']
        };

        // SLEEPY Color Palette - Deep Navy & Cream (ロゴ配色ベース)
        const BrandColors = {
            // Primary - Deep Navy (ロゴ背景のディープネイビー)
            primary: '#2e3f62',
            primaryLight: '#4d6290',
            primaryDark: '#1e2d4d',
            // Accent - Warm Gold (月のウォームゴールド)
            accent: '#c99445',
            accentLight: '#e8c88a',
            accentDark: '#b07e34',
            // Surface - Cream (ひつじのクリームベージュ)
            surface: '#fdfcfa',
            surfaceAlt: '#f3ede3',
            surfaceDark: '#e8dfd2',
            // Charts (統一感のある配色)
            gold: '#dba95e',      // ムーンゴールド
            brown: '#2e3f62',     // ディープネイビー
            beige: '#f2dbb4',     // クリームベージュ
            light: '#faf6f0',     // ウォームクリーム
            white: '#ffffff',
            darkBrown: '#1e2d4d', // ダークネイビー
            // Harmonious accent colors
            sage: '#739977',      // セージグリーン
            rose: '#d49890',      // ソフトピンク
            warmgold: '#e8c88a',  // ライトゴールド
            success: '#739977',   // セージグリーン
            warning: '#dba95e',   // ムーンゴールド
            purple: '#d49890'     // ソフトピンク
        };

        let rawData = [];
        let customerData = []; // 顧客データ
        let customerListCurrentPage = 1;
        const customerListPageSize = 20;

        // 顧客データAPI設定
        const CUSTOMER_API_KEY = 'sleepy_customer_api_url';
        let CUSTOMER_API_URL = localStorage.getItem(CUSTOMER_API_KEY) || "";
        let charts = {};
        let lockedStore = null;
        let lockedStaff = null;
        let isStaffAuthenticated = false; // スタッフ認証済みフラグ
        let changedRows = new Set();
        let monthlyGoal = 1100000; // Default goal

        // --- STAFF PASSWORD FUNCTIONS ---
        const STAFF_PASSWORD_STORAGE_KEY = 'sleepy_staff_passwords';
        let staffPasswordsCache = null; // スプレッドシートから読み込んだパスワードのキャッシュ

        // ローカルストレージから読み込み（フォールバック用）
        function loadStaffPasswordsFromLocalStorage() {
            const stored = localStorage.getItem(STAFF_PASSWORD_STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        // ローカルストレージに保存（フォールバック用）
        function saveStaffPasswordsToLocalStorage(passwords) {
            localStorage.setItem(STAFF_PASSWORD_STORAGE_KEY, JSON.stringify(passwords));
        }

        // スプレッドシートからパスワードを読み込み
        async function loadStaffPasswordsFromSpreadsheet() {
            const apiUrl = document.getElementById('spreadsheet-api-url')?.value;
            if (!apiUrl) {
                // API未設定の場合はローカルストレージから読み込み
                staffPasswordsCache = loadStaffPasswordsFromLocalStorage();
                return staffPasswordsCache;
            }

            try {
                const response = await fetch(`${apiUrl}?action=load_passwords`);
                const result = await response.json();
                if (result.status === 'success' && result.passwords) {
                    staffPasswordsCache = result.passwords;
                    // ローカルストレージにもキャッシュ
                    saveStaffPasswordsToLocalStorage(result.passwords);
                    return result.passwords;
                }
            } catch (error) {
                console.error('パスワード読み込みエラー:', error);
            }

            // エラー時はローカルストレージから読み込み
            staffPasswordsCache = loadStaffPasswordsFromLocalStorage();
            return staffPasswordsCache;
        }

        // スプレッドシートにパスワードを保存
        async function saveStaffPasswordsToSpreadsheet(passwords) {
            const apiUrl = document.getElementById('spreadsheet-api-url')?.value;

            // ローカルストレージに保存（常に）
            saveStaffPasswordsToLocalStorage(passwords);
            staffPasswordsCache = passwords;

            if (!apiUrl) {
                return; // API未設定の場合はローカル保存のみ
            }

            try {
                // 階層構造をフラットなキー形式に変換 {ebisu: {staff1: pass}} -> {ebisu_staff1: pass}
                const flatPasswords = {};
                Object.keys(passwords).forEach(store => {
                    Object.keys(passwords[store]).forEach(staff => {
                        flatPasswords[store + '_' + staff] = passwords[store][staff];
                    });
                });

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'save_passwords',
                        passwords: flatPasswords
                    })
                });
                const result = await response.json();
                console.log('パスワード保存結果:', result);
            } catch (error) {
                console.error('パスワード保存エラー:', error);
            }
        }

        function getStaffPassword(store, staff) {
            // キャッシュがない場合はローカルストレージから読み込み
            const passwords = staffPasswordsCache || loadStaffPasswordsFromLocalStorage();
            if (passwords[store] && passwords[store][staff]) {
                return passwords[store][staff];
            }
            return null; // パスワード未設定
        }

        function setStaffPassword(store, staff, password) {
            const passwords = staffPasswordsCache || loadStaffPasswordsFromLocalStorage();
            if (!passwords[store]) passwords[store] = {};
            passwords[store][staff] = password;
            // スプレッドシートとローカルストレージ両方に保存
            saveStaffPasswordsToSpreadsheet(passwords);
        }

        // --- SETTINGS SYNC FUNCTIONS (スプレッドシート連携) ---
        const SETTINGS_LOCAL_KEY = 'sleepy_dashboard_settings';

        // ローカルストレージから設定を読み込み（フォールバック用）
        function loadSettingsFromLocalStorage() {
            const stored = localStorage.getItem(SETTINGS_LOCAL_KEY);
            return stored ? JSON.parse(stored) : { staffRoster: null, geminiApiKey: null };
        }

        // ローカルストレージに設定を保存
        function saveSettingsToLocalStorage(settings) {
            localStorage.setItem(SETTINGS_LOCAL_KEY, JSON.stringify(settings));
        }

        // スプレッドシートから設定を読み込み
        async function loadSettingsFromSpreadsheet() {
            const apiUrl = document.getElementById('spreadsheet-api-url')?.value;
            if (!apiUrl) {
                // API未設定の場合はローカルストレージから読み込み
                const localSettings = loadSettingsFromLocalStorage();
                if (localSettings.staffRoster) {
                    STAFF_ROSTER = localSettings.staffRoster;
                }
                return localSettings;
            }

            try {
                const response = await fetch(`${apiUrl}?action=load_settings`);
                const result = await response.json();
                if (result.status === 'success' && result.settings) {
                    // スタッフ名簿を更新
                    if (result.settings.staffRoster) {
                        STAFF_ROSTER = result.settings.staffRoster;
                    }
                    // Gemini APIキーを更新
                    if (result.settings.geminiApiKey) {
                        const geminiInput = document.getElementById('gemini-api-key');
                        if (geminiInput) geminiInput.value = result.settings.geminiApiKey;
                    }
                    // ローカルストレージにもキャッシュ
                    saveSettingsToLocalStorage(result.settings);
                    return result.settings;
                }
            } catch (error) {
                console.error('設定読み込みエラー:', error);
            }

            // エラー時はローカルストレージから読み込み
            const localSettings = loadSettingsFromLocalStorage();
            if (localSettings.staffRoster) {
                STAFF_ROSTER = localSettings.staffRoster;
            }
            return localSettings;
        }

        // スプレッドシートに設定を保存
        async function saveSettingsToSpreadsheet() {
            const apiUrl = document.getElementById('spreadsheet-api-url')?.value;
            const geminiApiKey = document.getElementById('gemini-api-key')?.value || '';

            const settings = {
                staffRoster: STAFF_ROSTER,
                geminiApiKey: geminiApiKey
            };

            // ローカルストレージに保存（常に）
            saveSettingsToLocalStorage(settings);

            if (!apiUrl) {
                return; // API未設定の場合はローカル保存のみ
            }

            try {
                await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'save_settings',
                        settings: settings
                    })
                });
                console.log('設定をスプレッドシートに保存しました');
            } catch (error) {
                console.error('設定保存エラー:', error);
            }
        }

        function showStaffLoginModal(store, staff) {
            const modal = document.getElementById('staff-login-modal');
            const nameEl = document.getElementById('staff-login-name');
            const passwordInput = document.getElementById('staff-login-password');
            const errorEl = document.getElementById('staff-login-error');
            const mainContent = document.getElementById('main-content');
            const header = document.querySelector('header');

            // スタッフ名を表示
            const storeName = store === 'ebisu' ? '恵比寿駅前店' : store === 'kadomori' ? '大阪KADOMORI店' : store === 'fukushima' ? '福島店' : store;
            nameEl.textContent = `${storeName} / ${staff}`;

            // エラーメッセージを非表示
            errorEl.classList.add('hidden');
            passwordInput.value = '';

            // モーダルを表示
            modal.classList.remove('hidden');

            // メインコンテンツとヘッダーを非表示
            if (mainContent) mainContent.style.display = 'none';
            if (header) header.style.display = 'none';

            // パスワード入力欄にフォーカス
            setTimeout(() => passwordInput.focus(), 100);
        }

        function hideStaffLoginModal() {
            const modal = document.getElementById('staff-login-modal');
            const mainContent = document.getElementById('main-content');
            const header = document.querySelector('header');

            modal.classList.add('hidden');

            // メインコンテンツとヘッダーを表示
            if (mainContent) mainContent.style.display = '';
            if (header) header.style.display = '';
        }

        function handleStaffLogin(event) {
            event.preventDefault();
            const passwordInput = document.getElementById('staff-login-password');
            const errorEl = document.getElementById('staff-login-error');
            const enteredPassword = passwordInput.value;

            const correctPassword = getStaffPassword(lockedStore, lockedStaff);

            // パスワード未設定の場合は空文字列で認証成功
            if (correctPassword === null || correctPassword === '' || enteredPassword === correctPassword) {
                isStaffAuthenticated = true;
                hideStaffLoginModal();
                // ダッシュボードを更新
                updateDashboard();
                // Lucide iconsを更新
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            } else {
                // パスワード不一致
                errorEl.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        // --- GOAL STORAGE FUNCTIONS ---
        const GOAL_STORAGE_KEY = 'sleepy_staff_goals_v2'; // v2: 月別対応
        const GOAL_STORAGE_KEY_LEGACY = 'sleepy_staff_goals'; // 旧バージョン
        const BASE_SALARY_STORAGE_KEY = 'sleepy_staff_base_salary';
        const DEFAULT_GOAL = {
            weekdays: 0,
            weekends: 0,
            weekdayTarget: 0,
            weekendTarget: 0,
            retail: 0,
            newCustomers: 0,
            existingCustomers: 0,
            unitPrice: 0,
            newReservationRate: 0,
            reservationRate: 0,
            reviews5Star: 0
        };
        const DEFAULT_BASE_SALARY = 0; // Default base salary

        // 現在選択されている月を取得（YYYY/M形式 - date-selectorと同じ形式）
        function getCurrentGoalMonth() {
            const monthSelector = document.getElementById('goal-month-selector');
            if (monthSelector && monthSelector.value) {
                // YYYY/MM形式をYYYY/M形式に正規化
                const parts = monthSelector.value.split('/');
                if (parts.length === 2) {
                    return `${parts[0]}/${parseInt(parts[1])}`;
                }
                return monthSelector.value;
            }
            // デフォルト：現在の月
            const now = new Date();
            return `${now.getFullYear()}/${now.getMonth() + 1}`;
        }

        // ダッシュボードで選択されている月を取得（YYYY/M形式）
        function getSelectedDashboardMonth() {
            const dateSelector = document.getElementById('date-selector');
            if (dateSelector && dateSelector.value) {
                return dateSelector.value;
            }
            const now = new Date();
            return `${now.getFullYear()}/${now.getMonth() + 1}`;
        }

        // 月の形式を正規化（YYYY/MM -> YYYY/M）
        function normalizeMonthFormat(monthStr) {
            if (!monthStr) return monthStr;
            const parts = monthStr.split('/');
            if (parts.length === 2) {
                return `${parts[0]}/${parseInt(parts[1])}`;
            }
            return monthStr;
        }

        function loadGoalsFromStorage() {
            const stored = localStorage.getItem(GOAL_STORAGE_KEY);
            if (stored) {
                const goals = JSON.parse(stored);
                // 月の形式を正規化（YYYY/MM -> YYYY/M）
                const normalizedGoals = {};
                let needsSave = false;
                for (const [month, storeData] of Object.entries(goals)) {
                    const normalizedMonth = normalizeMonthFormat(month);
                    if (normalizedMonth !== month) needsSave = true;
                    if (!normalizedGoals[normalizedMonth]) {
                        normalizedGoals[normalizedMonth] = storeData;
                    } else {
                        // 同じ月のデータがある場合はマージ
                        for (const [store, staffData] of Object.entries(storeData)) {
                            if (!normalizedGoals[normalizedMonth][store]) {
                                normalizedGoals[normalizedMonth][store] = staffData;
                            } else {
                                Object.assign(normalizedGoals[normalizedMonth][store], staffData);
                            }
                        }
                    }
                }
                // 形式が変更された場合は保存し直す
                if (needsSave) {
                    saveGoalsToStorage(normalizedGoals);
                }
                return normalizedGoals;
            }
            // 旧バージョンからのマイグレーション
            const legacy = localStorage.getItem(GOAL_STORAGE_KEY_LEGACY);
            if (legacy) {
                const legacyGoals = JSON.parse(legacy);
                // 現在の月として保存
                const currentMonth = getSelectedDashboardMonth();
                const migratedGoals = { [currentMonth]: legacyGoals };
                saveGoalsToStorage(migratedGoals);
                return migratedGoals;
            }
            return {};
        }

        function saveGoalsToStorage(goals) {
            localStorage.setItem(GOAL_STORAGE_KEY, JSON.stringify(goals));
        }

        // デバッグ用: localStorageの目標データを確認
        window.debugGoals = function() {
            const goals = loadGoalsFromStorage();
            console.log('=== Goal Storage Debug ===');
            console.log('All stored goals:', goals);
            console.log('Available months:', Object.keys(goals));
            Object.keys(goals).forEach(month => {
                console.log(`Month ${month}:`, goals[month]);
                Object.keys(goals[month] || {}).forEach(store => {
                    console.log(`  Store ${store}:`, goals[month][store]);
                });
            });
            console.log('Current goal month (from goal-month-selector):', getCurrentGoalMonth());
            console.log('Dashboard month (from date-selector):', getSelectedDashboardMonth());
            console.log('STAFF_ROSTER:', STAFF_ROSTER);

            // 店舗ごとの月間目標合計を表示
            console.log('=== Store Monthly Target Sums ===');
            const currentMonth = getCurrentGoalMonth();
            Object.keys(STAFF_ROSTER).forEach(store => {
                const storeGoal = getStoreAggregateGoal(store, currentMonth);
                console.log(`${store}: ¥${storeGoal.monthlyTargetSum.toLocaleString()} (個別スタッフ目標の合計)`);
                const incorrectCalc = (storeGoal.weekdays * storeGoal.weekdayTarget) + (storeGoal.weekends * storeGoal.weekendTarget);
                console.log(`  従来の計算: ¥${incorrectCalc.toLocaleString()} (平均出勤日数 × 合計目標)`);
            });

            return goals;
        };

        function getStaffGoal(store, staff, yearMonth = null) {
            const goals = loadGoalsFromStorage();
            const month = yearMonth || getSelectedDashboardMonth();
            if (goals[month] && goals[month][store] && goals[month][store][staff]) {
                return goals[month][store][staff];
            }
            return { ...DEFAULT_GOAL };
        }

        function saveStaffGoal(store, staff, goalData, yearMonth = null) {
            const goals = loadGoalsFromStorage();
            const month = yearMonth || getCurrentGoalMonth();
            console.log(`[saveStaffGoal] Saving goal for ${store}/${staff} under month ${month}`);
            if (!goals[month]) goals[month] = {};
            if (!goals[month][store]) goals[month][store] = {};
            goals[month][store][staff] = goalData;
            saveGoalsToStorage(goals);

            // スプレッドシートへの自動保存をスケジュール
            scheduleAutoSaveToSpreadsheet();
        }

        // スタッフ名から所属店舗を取得（STAFF_ROSTERから検索）- 大文字小文字を区別しない
        function getStaffStoreFromRoster(staffName) {
            const staffNameLower = staffName?.toLowerCase();
            for (const [store, staffList] of Object.entries(STAFF_ROSTER)) {
                if (staffList.some(s => s.toLowerCase() === staffNameLower)) return store;
            }
            return null;
        }

        function getStoreAggregateGoal(store, yearMonth = null) {
            const staffList = STAFF_ROSTER[store] || [];
            const month = yearMonth || getSelectedDashboardMonth();


            let aggregate = {
                weekdays: 0,
                weekends: 0,
                weekdayTarget: 0,
                weekendTarget: 0,
                retail: 0,
                newCustomers: 0,
                existingCustomers: 0,
                unitPrice: 0,
                newReservationRate: 0,
                reservationRate: 0,
                reviews5Star: 0,
                // 個別スタッフの月間目標の正確な合計
                monthlyTargetSum: 0
            };

            let staffCount = 0;
            let totalWeekdays = 0;
            let totalWeekends = 0;

            staffList.forEach(staff => {
                const staffGoal = getStaffGoal(store, staff, month);

                // 各スタッフの月間目標を正確に計算して合計
                const staffMonthlyTarget = ((staffGoal.weekdays || 0) * (staffGoal.weekdayTarget || 0)) +
                                           ((staffGoal.weekends || 0) * (staffGoal.weekendTarget || 0));
                aggregate.monthlyTargetSum += staffMonthlyTarget;

                // 出勤日数は平均を取るために合計
                totalWeekdays += staffGoal.weekdays || 0;
                totalWeekends += staffGoal.weekends || 0;

                // デイリー目標は店舗全体の売上として合計
                aggregate.weekdayTarget += staffGoal.weekdayTarget || 0;
                aggregate.weekendTarget += staffGoal.weekendTarget || 0;

                // その他の目標も合計
                aggregate.retail += staffGoal.retail || 0;
                aggregate.newCustomers += staffGoal.newCustomers || 0;
                aggregate.existingCustomers += staffGoal.existingCustomers || 0;
                aggregate.unitPrice += staffGoal.unitPrice || 0;
                aggregate.newReservationRate += staffGoal.newReservationRate || 0;
                aggregate.reservationRate += staffGoal.reservationRate || 0;
                aggregate.reviews5Star += staffGoal.reviews5Star || 0;
                staffCount++;
            });

            // 出勤日数は平均値（店舗の営業日数の目安）
            if (staffCount > 0) {
                aggregate.weekdays = Math.round(totalWeekdays / staffCount);
                aggregate.weekends = Math.round(totalWeekends / staffCount);
                aggregate.unitPrice = Math.round(aggregate.unitPrice / staffCount);
                aggregate.newReservationRate = Math.round(aggregate.newReservationRate / staffCount);
                aggregate.reservationRate = Math.round(aggregate.reservationRate / staffCount);
            }

            return aggregate;
        }

        function getAllStoresAggregateGoal(yearMonth = null) {
            const allStores = Object.keys(STAFF_ROSTER);
            const month = yearMonth || getSelectedDashboardMonth();


            let aggregate = {
                weekdays: 0,
                weekends: 0,
                weekdayTarget: 0,
                weekendTarget: 0,
                retail: 0,
                newCustomers: 0,
                existingCustomers: 0,
                unitPrice: 0,
                newReservationRate: 0,
                reservationRate: 0,
                reviews5Star: 0,
                // 個別スタッフの月間目標の正確な合計
                monthlyTargetSum: 0
            };

            let staffCount = 0;
            let totalWeekdays = 0;
            let totalWeekends = 0;

            allStores.forEach(store => {
                const staffList = STAFF_ROSTER[store] || [];
                staffList.forEach(staff => {
                    const staffGoal = getStaffGoal(store, staff, month);

                    // 各スタッフの月間目標を正確に計算して合計
                    const staffMonthlyTarget = ((staffGoal.weekdays || 0) * (staffGoal.weekdayTarget || 0)) +
                                               ((staffGoal.weekends || 0) * (staffGoal.weekendTarget || 0));
                    aggregate.monthlyTargetSum += staffMonthlyTarget;

                    // 出勤日数は平均を取るために合計
                    totalWeekdays += staffGoal.weekdays || 0;
                    totalWeekends += staffGoal.weekends || 0;

                    // デイリー目標は全店舗の売上として合計
                    aggregate.weekdayTarget += staffGoal.weekdayTarget || 0;
                    aggregate.weekendTarget += staffGoal.weekendTarget || 0;

                    // その他の目標も合計
                    aggregate.retail += staffGoal.retail || 0;
                    aggregate.newCustomers += staffGoal.newCustomers || 0;
                    aggregate.existingCustomers += staffGoal.existingCustomers || 0;
                    aggregate.unitPrice += staffGoal.unitPrice || 0;
                    aggregate.newReservationRate += staffGoal.newReservationRate || 0;
                    aggregate.reservationRate += staffGoal.reservationRate || 0;
                    aggregate.reviews5Star += staffGoal.reviews5Star || 0;
                    staffCount++;
                });
            });

            // 出勤日数は平均値（全店舗の営業日数の目安）
            if (staffCount > 0) {
                aggregate.weekdays = Math.round(totalWeekdays / staffCount);
                aggregate.weekends = Math.round(totalWeekends / staffCount);
                aggregate.unitPrice = Math.round(aggregate.unitPrice / staffCount);
                aggregate.newReservationRate = Math.round(aggregate.newReservationRate / staffCount);
                aggregate.reservationRate = Math.round(aggregate.reservationRate / staffCount);
            }

            return aggregate;
        }

        function getCurrentGoalContext() {
            const storeVal = document.getElementById('store-selector').value;
            const staffVal = document.getElementById('staff-selector').value;

            if (staffVal !== 'all') {
                return { type: 'staff', store: storeVal, staff: staffVal };
            } else if (storeVal !== 'all') {
                return { type: 'store', store: storeVal };
            } else {
                return { type: 'all' };
            }
        }

        // --- BASE SALARY FUNCTIONS ---
        function loadBaseSalariesFromStorage() {
            const stored = localStorage.getItem(BASE_SALARY_STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function saveBaseSalariesToStorage(salaries) {
            localStorage.setItem(BASE_SALARY_STORAGE_KEY, JSON.stringify(salaries));
        }

        function getStaffBaseSalary(store, staff) {
            const salaries = loadBaseSalariesFromStorage();
            if (salaries[store] && salaries[store][staff] !== undefined) {
                return salaries[store][staff];
            }
            return DEFAULT_BASE_SALARY;
        }

        function saveStaffBaseSalary(store, staff, salary) {
            const salaries = loadBaseSalariesFromStorage();
            if (!salaries[store]) salaries[store] = {};
            salaries[store][staff] = salary;
            saveBaseSalariesToStorage(salaries);

            // スプレッドシートへの自動保存をスケジュール
            scheduleAutoSaveToSpreadsheet();
        }

        // --- AUTO SAVE TO SPREADSHEET ---
        let autoSaveTimeout = null;
        let isSavingToSpreadsheet = false;

        /**
         * スプレッドシートへの自動保存をスケジュール（5秒後に実行）
         */
        function scheduleAutoSaveToSpreadsheet() {
            // 既存のタイマーをクリア
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
            }

            // 5秒後に自動保存
            autoSaveTimeout = setTimeout(() => {
                autoSaveToSpreadsheet();
            }, 5000);
        }

        /**
         * スプレッドシートに自動保存（静かに実行）
         */
        async function autoSaveToSpreadsheet() {
            if (!API_URL || isSavingToSpreadsheet) {
                return;
            }

            isSavingToSpreadsheet = true;

            try {
                const goals = loadGoalsFromStorage();
                const salaries = loadBaseSalariesFromStorage();

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify({
                        action: "save_goals",
                        goals: goals,
                        salaries: salaries
                    })
                });

                const result = await response.json();

                if (result.status === "success") {
                    console.log("目標データをスプレッドシートに自動保存しました");
                } else {
                    console.warn("自動保存エラー:", result.message);
                }

            } catch (e) {
                console.error("自動保存中にエラーが発生:", e);
            } finally {
                isSavingToSpreadsheet = false;
            }
        }

        /**
         * ページ読み込み時にスプレッドシートから目標データを自動読み込み
         */
        async function autoLoadFromSpreadsheet() {
            if (!API_URL) {
                console.log("API URLが設定されていないため、ローカルストレージのデータを使用します");
                return;
            }

            try {
                const response = await fetch(API_URL + '?action=load_goals');
                const result = await response.json();

                if (result.status === "success") {
                    // 目標データをローカルストレージに保存
                    if (result.goals) {
                        saveGoalsToStorage(result.goals);
                    }
                    // 基本給データを保存
                    if (result.salaries) {
                        saveBaseSalariesToStorage(result.salaries);
                    }
                    console.log("スプレッドシートから目標データを読み込みました");
                } else {
                    console.log("スプレッドシートからの読み込みに失敗:", result.message);
                }

            } catch (e) {
                console.error("スプレッドシートからの自動読み込み中にエラーが発生:", e);
            }
        }

        // --- INCENTIVE CALCULATION ---
        function calculateIncentive(data, store, staff) {
            // Get base salary
            const baseSalary = getStaffBaseSalary(store, staff);

            // Calculate service sales (cash + credit + qr)
            let serviceSales = 0;
            let retailSales = 0;

            // dataが配列でない場合は空配列として扱う
            const dataArray = Array.isArray(data) ? data : [];

            dataArray.forEach(d => {
                if (!d) return;
                const sales = d.sales || {};
                serviceSales += (sales.cash || 0) + (sales.credit || 0) + (sales.qr || 0);
                retailSales += sales.product || 0;
            });

            // Incentive from service sales (5%)
            const serviceIncentive = serviceSales * 0.05;

            // Incentive from retail sales (5% if < 100k, 10% if >= 100k)
            const retailIncentive = retailSales >= 100000
                ? retailSales * 0.1
                : retailSales * 0.05;

            // Total incentive = base salary + service incentive + retail incentive
            const totalIncentive = baseSalary + serviceIncentive + retailIncentive;

            return {
                baseSalary,
                serviceSales,
                serviceIncentive,
                retailSales,
                retailIncentive,
                totalIncentive
            };
        }
        
        // --- 0. INIT & DATE SELECTOR ---
        function initDateSelector() {
            const sel = document.getElementById('date-selector');
            const startYear = 2024;
            const endYear = 2030;
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;

            for (let y = startYear; y <= endYear; y++) {
                for (let m = 1; m <= 12; m++) {
                    const opt = document.createElement('option');
                    const val = `${y}/${m}`; 
                    opt.value = val;
                    opt.text = `${y}年 ${m}月`;
                    if (y === currentYear && m === currentMonth) opt.selected = true;
                    sel.appendChild(opt);
                }
            }
        }

        function handleDateChange() {
            const dateVal = document.getElementById('date-selector').value;
            if (!API_URL) rawData = generateData(dateVal);
            updateDashboard();
        }

        // --- 1. MOCK DATA ---
        function generateData(yearMonthStr = "2024/1") {
            const data = [];
            const [year, month] = yearMonthStr.split('/').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            let idCounter = 1;

            Object.keys(STAFF_ROSTER).forEach(storeKey => {
                STAFF_ROSTER[storeKey].forEach(staffName => {
                    for (let i = 1; i <= daysInMonth; i++) {
                        if (Math.random() > 0.8) continue;

                        // All values set to 0
                        const salesCash = 0;
                        const salesCredit = 0;
                        const salesQr = 0;
                        const salesProduct = 0;

                        // All customer values set to 0
                        let newHPB = 0;
                        let newMiniNai = 0;
                        const acquaintance = 0;
                        const existing = 0;

                        const nextResNewHPB = 0;
                        const nextResMiniNai = 0;
                        const nextResExisting = 0;

                        data.push({
                            id: idCounter++,
                            date: `${year}/${month}/${i}`,
                            store: storeKey,
                            storeName: storeKey === 'ebisu' ? '恵比寿駅前店' : storeKey === 'kadomori' ? '大阪KADOMORI店' : storeKey === 'fukushima' ? '福島店' : storeKey,
                            staff: staffName,
                            sales: { cash: salesCash, credit: salesCredit, qr: salesQr, product: salesProduct },
                            discounts: { hpbPoints: Math.random()>0.9?500:0, hpbGift: 0, other: 0, refund: Math.random()>0.98?3000:0 },
                            customers: { newHPB, newMiniNai, existing, acquaintance },
                            nextRes: { newHPB: nextResNewHPB, newMiniNai: nextResMiniNai, existing: nextResExisting },
                            reviews5Star: 0,
                            blogUpdates: 0,
                            snsUpdates: 0
                        });
                    }
                });
            });
            return data;
        }

        // --- 2. DATA LOADING ---

        // スプラッシュスクリーン / ローディングオーバーレイの表示/非表示
        function showLoading(text = '読み込み中...') {
            const overlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            const progressBar = document.getElementById('splash-progress-bar');
            if (overlay) {
                overlay.classList.remove('hidden', 'splash-fade-out');
                overlay.style.opacity = '1';
                overlay.style.visibility = 'visible';
            }
            if (loadingText) loadingText.textContent = text;
            // プログレスバーのアニメーションをリセット
            if (progressBar) {
                progressBar.style.animation = 'none';
                progressBar.offsetHeight; // リフロー強制
                progressBar.style.animation = 'progressBar 2s ease-in-out forwards';
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.add('splash-fade-out');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    overlay.style.visibility = 'hidden';
                }, 500);
            }
        }

        // 更新完了通知を表示（簡易トースト）
        function showUpdateNotification(message) {
            // 既存の通知を削除
            const existing = document.getElementById('update-notification');
            if (existing) existing.remove();

            // 新しい通知を作成
            const notification = document.createElement('div');
            notification.id = 'update-notification';
            notification.className = 'fixed bottom-4 right-4 bg-emerald-500 text-white px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-fade-in';
            notification.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span class="font-medium">${message}</span>
            `;
            document.body.appendChild(notification);

            // 2秒後に自動で消える
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        // スプレッドシートAPI URL管理
        function saveSpreadsheetApiUrl() {
            const urlInput = document.getElementById('spreadsheet-api-url');
            const url = urlInput ? urlInput.value.trim() : '';
            localStorage.setItem(SPREADSHEET_API_KEY, url);
            API_URL = url;

            const status = document.getElementById('spreadsheet-connection-status');
            if (status) {
                status.classList.remove('hidden');
                status.innerHTML = '<div class="bg-green-50 border border-green-400 text-green-700 px-4 py-2 rounded text-sm flex items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i>APIのURLが保存されました</div>';
                if (typeof lucide !== 'undefined') lucide.createIcons();
                setTimeout(() => status.classList.add('hidden'), 3000);
            }
        }

        function loadSpreadsheetApiUrl() {
            const urlInput = document.getElementById('spreadsheet-api-url');
            // デフォルトURLをフォールバックとして使用
            const savedUrl = localStorage.getItem(SPREADSHEET_API_KEY) || DEFAULT_API_URL;
            if (urlInput) {
                urlInput.value = savedUrl;
                API_URL = savedUrl;
            }
        }

        async function testSpreadsheetConnection() {
            const status = document.getElementById('spreadsheet-connection-status');
            const url = document.getElementById('spreadsheet-api-url')?.value.trim() || API_URL;

            if (!url) {
                if (status) {
                    status.classList.remove('hidden');
                    status.innerHTML = '<div class="bg-yellow-50 border border-yellow-400 text-yellow-700 px-4 py-2 rounded text-sm flex items-center gap-2"><i data-lucide="alert-circle" class="w-4 h-4"></i>URLを入力してください</div>';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
                return;
            }

            if (status) {
                status.classList.remove('hidden');
                status.innerHTML = '<div class="bg-blue-50 border border-blue-400 text-blue-700 px-4 py-2 rounded text-sm flex items-center gap-2"><svg class="animate-spin w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>接続テスト中...</div>';
            }

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (status) {
                    status.innerHTML = `<div class="bg-green-50 border border-green-400 text-green-700 px-4 py-2 rounded text-sm flex items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i>接続成功！ ${Array.isArray(data) ? data.length + '件のデータを取得' : 'データを取得しました'}</div>`;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }

                // 接続成功時に設定とパスワードもスプレッドシートから読み込み
                await loadSettingsFromSpreadsheet();
                await loadStaffPasswordsFromSpreadsheet();
                updateSettingsList();
                updatePasswordList();
            } catch (e) {
                if (status) {
                    status.innerHTML = `<div class="bg-red-50 border border-red-400 text-red-700 px-4 py-2 rounded text-sm flex items-center gap-2"><i data-lucide="x-circle" class="w-4 h-4"></i>接続エラー: ${e.message}</div>`;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
            }
        }

        // データ更新（手動）
        async function refreshData() {
            const refreshBtn = document.getElementById('refresh-data-btn');
            const refreshIcon = document.getElementById('refresh-icon');

            // ボタンをスピン状態に
            if (refreshIcon) refreshIcon.classList.add('animate-spin');
            if (refreshBtn) refreshBtn.disabled = true;

            showLoading('データを更新中...', '最新データをスプレッドシートから取得しています');

            try {
                await loadDataFromSpreadsheet();
                updateDashboard();
            } finally {
                hideLoading();
                if (refreshIcon) refreshIcon.classList.remove('animate-spin');
                if (refreshBtn) refreshBtn.disabled = false;
            }
        }

        // スプレッドシートからデータ読み込み
        async function loadDataFromSpreadsheet() {
            // APIのURLを最新の状態に更新（デフォルトURLをフォールバック）
            API_URL = localStorage.getItem(SPREADSHEET_API_KEY) || DEFAULT_API_URL;

            if (API_URL) {
                try {
                    const response = await fetch(API_URL);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    let data = await response.json();

                    // レスポンスが配列でない場合（エラーオブジェクトなど）のチェック
                    if (!Array.isArray(data)) {
                        // { status: 'success', data: [...] } 形式の場合
                        if (data && Array.isArray(data.data)) {
                            data = data.data;
                        } else if (data && data.status === 'error') {
                            throw new Error(data.message || 'APIエラー');
                        } else {
                            console.warn('予期しないレスポンス形式:', data);
                            return false;
                        }
                    }

                    // idが欠けているレコードにのみidを付与し、データ構造を正規化
                    rawData = data.map((d, i) => {
                        const normalized = d.id ? {...d} : {...d, id: i+1};
                        // nextResオブジェクトが存在しない場合は作成
                        if (!normalized.nextRes) {
                            normalized.nextRes = {
                                newHPB: normalized.nextResNewHPB || normalized['nextRes.newHPB'] || 0,
                                newMiniNai: normalized.nextResNewMiniNai || normalized['nextRes.newMiniNai'] || 0,
                                existing: normalized.nextResExisting || normalized['nextRes.existing'] || 0
                            };
                        }
                        // customersオブジェクトが存在しない場合は作成
                        if (!normalized.customers) {
                            normalized.customers = {
                                newHPB: normalized.customersNewHPB || normalized['customers.newHPB'] || 0,
                                newMiniNai: normalized.customersNewMiniNai || normalized['customers.newMiniNai'] || 0,
                                existing: normalized.customersExisting || normalized['customers.existing'] || 0,
                                acquaintance: normalized.customersAcquaintance || normalized['customers.acquaintance'] || 0
                            };
                        }
                        // salesオブジェクトが存在しない場合は作成
                        if (!normalized.sales) {
                            normalized.sales = {
                                cash: normalized.salesCash || normalized['sales.cash'] || 0,
                                credit: normalized.salesCredit || normalized['sales.credit'] || 0,
                                qr: normalized.salesQr || normalized['sales.qr'] || 0,
                                product: normalized.salesProduct || normalized['sales.product'] || 0
                            };
                        }
                        // discountsオブジェクトが存在しない場合は作成
                        if (!normalized.discounts) {
                            normalized.discounts = {
                                hpbPoints: normalized.discountsHpbPoints || normalized['discounts.hpbPoints'] || 0,
                                hpbGift: normalized.discountsHpbGift || normalized['discounts.hpbGift'] || 0,
                                other: normalized.discountsOther || normalized['discounts.other'] || 0,
                                refund: normalized.discountsRefund || normalized['discounts.refund'] || 0
                            };
                        }
                        return normalized;
                    });
                    console.log(`✓ スプレッドシートから ${rawData.length} 件のデータを取得しました`);
                    return true;
                } catch (e) {
                    console.error("スプレッドシート読み込みエラー:", e);
                    console.error("API URL:", API_URL);
                    // エラー通知（ページ上部に表示）
                    setTimeout(() => {
                        const banner = document.createElement('div');
                        banner.className = 'fixed top-0 left-0 right-0 bg-red-500 text-white text-center py-2 text-sm z-50';
                        banner.innerHTML = `スプレッドシート読み込みエラー: ${e.message} <button onclick="this.parentElement.remove()" class="ml-4 underline">閉じる</button>`;
                        document.body.prepend(banner);
                    }, 500);
                    return false;
                }
            }
            return false;
        }

        async function loadData() {
            showLoading();
            try {
                initDateSelector();
                const initialDate = document.getElementById('date-selector').value;

                // スプレッドシートからデータを読み込み
                const loaded = await loadDataFromSpreadsheet();

                // スプレッドシートからの読み込みに失敗した場合はサンプルデータを使用
                if (!loaded) {
                    console.log('サンプルデータを使用します');
                    rawData = generateData(initialDate);
                }

                checkUrlParams();
                updateDashboard();
            } catch (e) {
                console.error('loadData エラー:', e);
            } finally {
                hideLoading();
            }
        }

        // --- 顧客データ（マーケティング）関連 ---
        function saveCustomerApiUrl() {
            const urlInput = document.getElementById('customer-api-url');
            const url = urlInput ? urlInput.value.trim() : '';
            localStorage.setItem(CUSTOMER_API_KEY, url);
            CUSTOMER_API_URL = url;

            const status = document.getElementById('customer-api-connection-status');
            if (status) {
                status.classList.remove('hidden');
                status.innerHTML = '<div class="bg-green-50 border border-green-400 text-green-700 px-4 py-2 rounded text-sm flex items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i>URLが保存されました</div>';
                if (typeof lucide !== 'undefined') lucide.createIcons();
                setTimeout(() => status.classList.add('hidden'), 3000);
            }
        }

        function loadCustomerApiUrl() {
            const urlInput = document.getElementById('customer-api-url');
            const savedUrl = localStorage.getItem(CUSTOMER_API_KEY) || '';
            if (urlInput) urlInput.value = savedUrl;
        }

        async function testCustomerApiConnection() {
            const status = document.getElementById('customer-api-connection-status');
            const url = document.getElementById('customer-api-url')?.value.trim() || CUSTOMER_API_URL;

            if (!url) {
                if (status) {
                    status.classList.remove('hidden');
                    status.innerHTML = '<div class="bg-yellow-50 border border-yellow-400 text-yellow-700 px-4 py-2 rounded text-sm flex items-center gap-2"><i data-lucide="alert-circle" class="w-4 h-4"></i>URLを入力してください</div>';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
                return;
            }

            if (status) {
                status.classList.remove('hidden');
                status.innerHTML = '<div class="bg-blue-50 border border-blue-400 text-blue-700 px-4 py-2 rounded text-sm flex items-center gap-2"><svg class="animate-spin w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>接続テスト中...</div>';
            }

            try {
                // action=get_customersパラメータを追加して顧客データを取得
                const testUrl = new URL(url);
                testUrl.searchParams.set('action', 'get_customers');

                // Google Apps Script Web App はリダイレクトするため、redirect: 'follow' が必要
                const response = await fetch(testUrl.toString(), {
                    method: 'GET',
                    redirect: 'follow'
                });

                // レスポンスのContent-Typeを確認
                const contentType = response.headers.get('content-type');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const text = await response.text();
                let result;
                try {
                    result = JSON.parse(text);
                } catch (parseError) {
                    // HTMLが返ってきた場合（認証エラーなど）
                    if (text.includes('<!DOCTYPE') || text.includes('<html')) {
                        throw new Error('認証エラー: Apps Scriptのデプロイ設定を確認してください（アクセスできるユーザー: 全員）');
                    }
                    throw new Error('JSONパースエラー: レスポンスがJSON形式ではありません');
                }

                // エラーレスポンスのチェック
                if (result.error || result.status === 'error') {
                    throw new Error(`スクリプトエラー: ${result.error || result.message}`);
                }

                // APIレスポンス形式に対応 { status: 'success', data: [...] }
                const data = result.data || result;

                if (status) {
                    status.innerHTML = `<div class="bg-green-50 border border-green-400 text-green-700 px-4 py-2 rounded text-sm flex items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i>接続成功！ ${Array.isArray(data) ? data.length + '件の顧客データを取得' : 'データを取得しました'}</div>`;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
            } catch (e) {
                if (status) {
                    status.innerHTML = `<div class="bg-red-50 border border-red-400 text-red-700 px-4 py-2 rounded text-sm flex items-center gap-2"><i data-lucide="x-circle" class="w-4 h-4"></i>接続エラー: ${e.message}</div>`;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
            }
        }

        async function loadCustomerData() {
            CUSTOMER_API_URL = localStorage.getItem(CUSTOMER_API_KEY) || '';
            if (!CUSTOMER_API_URL) {
                console.log('顧客データAPIが設定されていません');
                return false;
            }

            try {
                // action=get_customersパラメータを追加して顧客データを取得
                const url = new URL(CUSTOMER_API_URL);
                url.searchParams.set('action', 'get_customers');

                const response = await fetch(url.toString(), {
                    method: 'GET',
                    redirect: 'follow'
                });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const text = await response.text();
                const result = JSON.parse(text);

                // APIレスポンス形式に対応 { status: 'success', data: [...] }
                if (result.error || result.status === 'error') {
                    throw new Error(result.error || result.message || '不明なエラー');
                }

                // dataプロパティがあればそれを使用、なければ結果をそのまま使用
                customerData = result.data || result;

                if (!Array.isArray(customerData)) {
                    throw new Error('顧客データの形式が正しくありません');
                }

                console.log(`✓ 顧客データから ${customerData.length} 件のデータを取得しました`);
                return true;
            } catch (e) {
                console.error('顧客データ読み込みエラー:', e);
                return false;
            }
        }

        async function refreshCustomerData() {
            const refreshBtn = document.getElementById('refresh-customer-btn');
            const refreshIcon = document.getElementById('refresh-customer-icon');

            if (refreshIcon) refreshIcon.classList.add('animate-spin');
            if (refreshBtn) refreshBtn.disabled = true;

            const loaded = await loadCustomerData();
            if (loaded) {
                updateMarketingDashboard();
                document.getElementById('customer-data-status').innerHTML = `<span class="text-emerald-600">${customerData.length}件のデータ</span>`;
                showUpdateNotification('マーケティングデータを更新しました');
            } else {
                document.getElementById('customer-data-status').innerHTML = '<span class="text-red-500">取得失敗</span>';
            }

            if (refreshIcon) refreshIcon.classList.remove('animate-spin');
            if (refreshBtn) refreshBtn.disabled = false;
        }

        // 店舗フィルターでフィルタリングされた顧客データを取得
        function getFilteredCustomerData() {
            const storeFilter = document.getElementById('marketing-store-filter')?.value || 'all';
            if (storeFilter === 'all') {
                return customerData;
            }
            return customerData.filter(c => c.store === storeFilter);
        }

        // マーケティングダッシュボード更新
        function updateMarketingDashboard() {
            if (!customerData || customerData.length === 0) {
                return;
            }

            const filtered = getFilteredCustomerData();
            const storeFilter = document.getElementById('marketing-store-filter')?.value || 'all';
            const storeName = storeFilter === 'all' ? '全店' : storeFilter === 'ebisu' ? '恵比寿駅前店' : storeFilter === 'kadomori' ? '大阪KADOMORI店' : storeFilter === 'fukushima' ? '福島店' : storeFilter;

            const fmt = n => n.toLocaleString();
            const now = new Date();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();

            // KPI計算（フィルター済みデータを使用）
            const totalCustomers = filtered.length;
            const newThisMonth = filtered.filter(c => {
                if (!c.timestamp) return false;
                const d = new Date(c.timestamp);
                return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
            }).length;

            // snsOk(Code.gs) または snsPermission の両方に対応
            const snsYes = filtered.filter(c => {
                const snsVal = c.snsOk || c.snsPermission || '';
                return snsVal.includes('はい') || snsVal.includes('OK') || snsVal.includes('許可');
            }).length;
            const snsRate = totalCustomers > 0 ? Math.round((snsYes / totalCustomers) * 100) : 0;

            // 年齢計算 (birthday(Code.gs) または birthDate の両方に対応)
            const ages = filtered.map(c => {
                const birthVal = c.birthday || c.birthDate;
                if (!birthVal) return null;
                const birth = new Date(birthVal);
                if (isNaN(birth.getTime())) return null;
                return now.getFullYear() - birth.getFullYear();
            }).filter(a => a && a > 0 && a < 100);
            const avgAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length) : '-';

            // KPI更新
            document.getElementById('mkt-total-customers').textContent = fmt(totalCustomers);
            document.getElementById('mkt-new-this-month').textContent = fmt(newThisMonth);
            document.getElementById('mkt-sns-rate').textContent = `${snsRate}%`;
            document.getElementById('mkt-avg-age').textContent = avgAge + (avgAge !== '-' ? '歳' : '');

            // データステータス更新
            document.getElementById('customer-data-status').innerHTML = `<span class="text-emerald-600">${storeName}: ${totalCustomers}件</span>`;

            // チャート更新
            updateVisitReasonChart();
            updateAgeDistributionChart();
            updateOccupationChart();
            updateGeographicAnalysis();
            updateMenuPreferences();
            updateCustomerList();

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function updateVisitReasonChart() {
            const filtered = getFilteredCustomerData();
            const reasonCounts = {};
            filtered.forEach(c => {
                if (c.visitReason) {
                    const reasons = c.visitReason.split(',').map(r => r.trim());
                    reasons.forEach(r => {
                        if (r) reasonCounts[r] = (reasonCounts[r] || 0) + 1;
                    });
                }
            });

            const sorted = Object.entries(reasonCounts).sort((a, b) => b[1] - a[1]);
            const labels = sorted.map(([k]) => k.length > 15 ? k.substring(0, 15) + '...' : k);
            const data = sorted.map(([, v]) => v);
            // Elegant harmonious color palette
            const colors = [
                '#c99445', // Champagne Gold
                '#2e3f62', // Slate Blue
                '#739977', // Sage Green
                '#d49890', // Dusty Rose
                '#dba95e', // Warm Gold
                '#4d6290', // Light Slate
                '#8ba88e', // Light Sage
                '#e0b0a8', // Light Rose
                '#e8c88a', // Light Gold
                '#3b4f78', // Medium Slate
                '#5d7d60', // Deep Sage
                '#c08078'  // Deep Rose
            ];

            if (charts.visitReason) charts.visitReason.destroy();
            charts.visitReason = new Chart(document.getElementById('visitReasonChart'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, data.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } }
                    }
                }
            });

            // 詳細リスト
            document.getElementById('visit-reason-details').innerHTML = sorted.slice(0, 5).map(([reason, count], i) => `
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full" style="background-color: ${colors[i]}"></span>
                    <span class="flex-1 text-sm text-accent-700 truncate">${reason}</span>
                    <span class="text-sm font-semibold text-accent-800">${count}人</span>
                </div>
            `).join('');
        }

        function updateAgeDistributionChart() {
            const filtered = getFilteredCustomerData();
            const ageGroups = { '10代': 0, '20代': 0, '30代': 0, '40代': 0, '50代': 0, '60代以上': 0 };
            const now = new Date();

            filtered.forEach(c => {
                const birthVal = c.birthday || c.birthDate;
                if (!birthVal) return;
                const birth = new Date(birthVal);
                if (isNaN(birth.getTime())) return;
                const age = now.getFullYear() - birth.getFullYear();
                if (age < 20) ageGroups['10代']++;
                else if (age < 30) ageGroups['20代']++;
                else if (age < 40) ageGroups['30代']++;
                else if (age < 50) ageGroups['40代']++;
                else if (age < 60) ageGroups['50代']++;
                else ageGroups['60代以上']++;
            });

            // Gradient colors for age groups
            const ageColors = [
                '#e8c88a', // 10代 - Light Gold
                '#dba95e', // 20代 - Warm Gold
                '#c99445', // 30代 - Champagne Gold (peak)
                '#739977', // 40代 - Sage Green
                '#4d6290', // 50代 - Light Slate
                '#2e3f62'  // 60代以上 - Slate Blue
            ];

            if (charts.ageDistribution) charts.ageDistribution.destroy();
            charts.ageDistribution = new Chart(document.getElementById('ageDistributionChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(ageGroups),
                    datasets: [{
                        label: '人数',
                        data: Object.values(ageGroups),
                        backgroundColor: ageColors,
                        borderRadius: 8,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f3ede3' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateOccupationChart() {
            const filtered = getFilteredCustomerData();
            const occCounts = {};
            filtered.forEach(c => {
                // job(Code.gs) または occupation の両方に対応
                const occ = c.job || c.occupation || '未回答';
                occCounts[occ] = (occCounts[occ] || 0) + 1;
            });

            const sorted = Object.entries(occCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);
            // Elegant harmonious color palette for occupation
            const colors = [
                '#c99445', // Champagne Gold
                '#2e3f62', // Slate Blue
                '#739977', // Sage Green
                '#d49890', // Dusty Rose
                '#dba95e', // Warm Gold
                '#4d6290', // Light Slate
                '#8ba88e', // Light Sage
                '#e0b0a8'  // Light Rose
            ];

            if (charts.occupation) charts.occupation.destroy();
            charts.occupation = new Chart(document.getElementById('occupationChart'), {
                type: 'pie',
                data: {
                    labels: sorted.map(([k]) => k),
                    datasets: [{
                        data: sorted.map(([, v]) => v),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } }
                    }
                }
            });
        }

        function updateGeographicAnalysis() {
            const filtered = getFilteredCustomerData();
            const areaCounts = {};
            filtered.forEach(c => {
                if (!c.address) return;
                // 都道府県と市区町村を抽出
                const match = c.address.match(/^(.+?[都道府県])(.+?[市区町村])?/);
                if (match) {
                    const area = match[2] ? match[1] + match[2] : match[1];
                    areaCounts[area] = (areaCounts[area] || 0) + 1;
                }
            });

            const sorted = Object.entries(areaCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const max = sorted[0]?.[1] || 1;

            document.getElementById('geographic-analysis').innerHTML = sorted.map(([area, count]) => `
                <div class="flex items-center gap-3">
                    <span class="w-32 text-sm text-accent-700 truncate">${area}</span>
                    <div class="flex-1 bg-surface-200 h-3 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-primary-400 to-primary-500 rounded-full" style="width: ${(count / max) * 100}%"></div>
                    </div>
                    <span class="text-sm font-semibold text-accent-800 w-12 text-right">${count}人</span>
                </div>
            `).join('');
        }

        function updateMenuPreferences() {
            const filtered = getFilteredCustomerData();

            // 眉毛のお悩み (eyebrowConcern(Code.gs) または eyebrowConcerns の両方に対応)
            const eyebrowConcerns = {};
            filtered.forEach(c => {
                const concernVal = c.eyebrowConcern || c.eyebrowConcerns;
                if (concernVal) {
                    concernVal.split(',').forEach(concern => {
                        const t = concern.trim();
                        if (t) eyebrowConcerns[t] = (eyebrowConcerns[t] || 0) + 1;
                    });
                }
            });
            const sortedConcerns = Object.entries(eyebrowConcerns).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const maxConcern = sortedConcerns[0]?.[1] || 1;
            document.getElementById('eyebrow-concerns-list').innerHTML = sortedConcerns.map(([concern, count]) => `
                <div class="flex items-center gap-2">
                    <div class="flex-1 bg-surface-200 h-2 rounded-full overflow-hidden">
                        <div class="h-full bg-[#d49890] rounded-full" style="width: ${(count / maxConcern) * 100}%"></div>
                    </div>
                    <span class="text-xs text-accent-700 w-24 truncate">${concern}</span>
                    <span class="text-xs font-semibold text-accent-800">${count}</span>
                </div>
            `).join('') || '<p class="text-xs text-surface-500">データなし</p>';

            // 眉毛の希望印象
            const impressions = {};
            filtered.forEach(c => {
                if (c.eyebrowImpression) {
                    impressions[c.eyebrowImpression] = (impressions[c.eyebrowImpression] || 0) + 1;
                }
            });
            document.getElementById('eyebrow-impression-list').innerHTML = Object.entries(impressions)
                .sort((a, b) => b[1] - a[1]).slice(0, 6)
                .map(([imp, count]) => `<span class="px-3 py-1 bg-[#faf0ed] text-[#d49890] rounded-full text-xs">${imp} (${count})</span>`).join('') || '<p class="text-xs text-surface-500">データなし</p>';

            // まつ毛デザイン (lashDesign(Code.gs) または eyelashDesign の両方に対応)
            const eyelashDesigns = {};
            filtered.forEach(c => {
                const designVal = c.lashDesign || c.eyelashDesign;
                if (designVal) {
                    eyelashDesigns[designVal] = (eyelashDesigns[designVal] || 0) + 1;
                }
            });
            const sortedDesigns = Object.entries(eyelashDesigns).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const maxDesign = sortedDesigns[0]?.[1] || 1;
            document.getElementById('eyelash-design-list').innerHTML = sortedDesigns.map(([design, count]) => `
                <div class="flex items-center gap-2">
                    <div class="flex-1 bg-surface-200 h-2 rounded-full overflow-hidden">
                        <div class="h-full bg-[#c99445] rounded-full" style="width: ${(count / maxDesign) * 100}%"></div>
                    </div>
                    <span class="text-xs text-accent-700 w-24 truncate">${design}</span>
                    <span class="text-xs font-semibold text-accent-800">${count}</span>
                </div>
            `).join('') || '<p class="text-xs text-surface-500">データなし</p>';

            // 目の見え方 (lashEyeLook(Code.gs) または eyelashEyeLook の両方に対応)
            const eyeLooks = {};
            filtered.forEach(c => {
                const eyeLookVal = c.lashEyeLook || c.eyelashEyeLook;
                if (eyeLookVal) {
                    eyeLooks[eyeLookVal] = (eyeLooks[eyeLookVal] || 0) + 1;
                }
            });
            document.getElementById('eyelash-eyelook-list').innerHTML = Object.entries(eyeLooks)
                .sort((a, b) => b[1] - a[1]).slice(0, 6)
                .map(([look, count]) => `<span class="px-3 py-1 bg-[#faf5f0] text-[#c99445] rounded-full text-xs">${look} (${count})</span>`).join('') || '<p class="text-xs text-surface-500">データなし</p>';
        }

        function updateCustomerList() {
            renderCustomerList();
        }

        function renderCustomerList() {
            const searchTerm = document.getElementById('customer-search')?.value.toLowerCase() || '';
            const snsFilter = document.getElementById('customer-filter-sns')?.value || 'all';

            // 店舗フィルターを適用したデータを使用
            let filtered = getFilteredCustomerData().filter(c => {
                const matchesSearch = !searchTerm || (c.name && c.name.toLowerCase().includes(searchTerm));
                const snsVal = c.snsOk || c.snsPermission || '';
                const hasSns = snsVal.includes('はい') || snsVal.includes('OK') || snsVal.includes('許可');
                const matchesSns = snsFilter === 'all' || (snsFilter === 'yes' && hasSns) || (snsFilter === 'no' && !hasSns);
                return matchesSearch && matchesSns;
            });

            // Sort by timestamp descending
            filtered.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));

            const total = filtered.length;
            const startIdx = (customerListCurrentPage - 1) * customerListPageSize;
            const pageData = filtered.slice(startIdx, startIdx + customerListPageSize);

            const now = new Date();
            const tbody = document.getElementById('customer-list-body');
            tbody.innerHTML = pageData.map(c => {
                const regDate = c.timestamp ? new Date(c.timestamp).toLocaleDateString('ja-JP') : '-';
                let age = '-';
                const birthVal = c.birthday || c.birthDate;
                if (birthVal) {
                    const birth = new Date(birthVal);
                    if (!isNaN(birth.getTime())) {
                        age = now.getFullYear() - birth.getFullYear() + '歳';
                    }
                }
                const area = c.address ? (c.address.match(/^(.+?[都道府県])(.+?[市区町村])?/)?.[0] || c.address.substring(0, 10)) : '-';
                const snsVal = c.snsOk || c.snsPermission || '';
                const hasSns = snsVal.includes('はい') || snsVal.includes('OK') || snsVal.includes('許可');
                const reason = c.visitReason ? (c.visitReason.length > 20 ? c.visitReason.substring(0, 20) + '...' : c.visitReason) : '-';
                const occupation = c.job || c.occupation || '-';

                return `
                    <tr class="border-b border-surface-100 hover:bg-surface-50 transition">
                        <td class="py-3 px-4 text-surface-600">${regDate}</td>
                        <td class="py-3 px-4 font-medium text-accent-800">${c.name || '-'}</td>
                        <td class="py-3 px-4">${age}</td>
                        <td class="py-3 px-4 text-surface-600">${occupation}</td>
                        <td class="py-3 px-4 text-surface-600">${area}</td>
                        <td class="py-3 px-4 text-center">
                            ${hasSns ? '<span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-emerald-100 text-emerald-600"><i data-lucide="check" class="w-3 h-3"></i></span>' : '<span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-surface-100 text-surface-400"><i data-lucide="x" class="w-3 h-3"></i></span>'}
                        </td>
                        <td class="py-3 px-4 text-surface-600 text-xs">${reason}</td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="7" class="text-center py-8 text-surface-500">データがありません</td></tr>';

            document.getElementById('customer-list-count').textContent = `${total}件中 ${startIdx + 1}-${Math.min(startIdx + customerListPageSize, total)}件表示`;
            document.getElementById('customer-list-page').textContent = customerListCurrentPage;

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function filterCustomerList() {
            customerListCurrentPage = 1;
            renderCustomerList();
        }

        function customerListPage(delta) {
            const searchTerm = document.getElementById('customer-search')?.value.toLowerCase() || '';
            const snsFilter = document.getElementById('customer-filter-sns')?.value || 'all';

            const filtered = customerData.filter(c => {
                const matchesSearch = !searchTerm || (c.name && c.name.toLowerCase().includes(searchTerm));
                const hasSns = c.snsPermission && (c.snsPermission.includes('はい') || c.snsPermission.includes('OK'));
                const matchesSns = snsFilter === 'all' || (snsFilter === 'yes' && hasSns) || (snsFilter === 'no' && !hasSns);
                return matchesSearch && matchesSns;
            });

            const maxPage = Math.ceil(filtered.length / customerListPageSize);
            const newPage = customerListCurrentPage + delta;
            if (newPage >= 1 && newPage <= maxPage) {
                customerListCurrentPage = newPage;
                renderCustomerList();
            }
        }

        // カウンセリング回答結果の更新
        async function refreshCounselingResults() {
            const refreshIcon = document.getElementById('counseling-refresh-icon');
            if (refreshIcon) refreshIcon.classList.add('animate-spin');

            const loaded = await loadCustomerData();
            renderCounselingResults();

            if (refreshIcon) refreshIcon.classList.remove('animate-spin');

            if (loaded) {
                showUpdateNotification('カウンセリング回答を更新しました');
            }
        }

        // カウンセリング回答結果の表示
        function renderCounselingResults() {
            const container = document.getElementById('counseling-results-container');
            if (!container) return;

            if (!customerData || customerData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-sleepy-400">
                        <i data-lucide="clipboard-list" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                        <p class="text-sm">顧客データAPIを設定すると、カウンセリング回答が表示されます</p>
                        <p class="text-xs mt-1">設定タブ → 顧客データ連携設定</p>
                    </div>
                `;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            // スタッフ専用の場合は所属店舗のみ表示
            const storeFilter = lockedStore || (document.getElementById('counseling-store-filter')?.value || 'all');
            const searchTerm = document.getElementById('counseling-result-search')?.value.toLowerCase() || '';
            const dateFilter = document.getElementById('counseling-date-filter')?.value || 'month';

            // スタッフ専用の場合、店舗フィルターを無効化
            const storeFilterElement = document.getElementById('counseling-store-filter');
            if (lockedStore && storeFilterElement) {
                storeFilterElement.value = lockedStore;
                storeFilterElement.disabled = true;
            }

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

            let filtered = customerData.filter(c => {
                // 店舗フィルター（スタッフ専用の場合は所属店舗のみ）
                if (storeFilter !== 'all' && c.store !== storeFilter) return false;

                // 検索フィルター
                if (searchTerm && !(c.name && c.name.toLowerCase().includes(searchTerm))) return false;

                // 日付フィルター
                if (dateFilter !== 'all' && c.timestamp) {
                    const recordDate = new Date(c.timestamp);
                    if (dateFilter === 'today' && recordDate < today) return false;
                    if (dateFilter === 'week' && recordDate < weekAgo) return false;
                    if (dateFilter === 'month' && recordDate < monthStart) return false;
                }

                return true;
            });

            // 日付の新しい順にソート
            filtered.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            // 件数表示
            document.getElementById('counseling-result-count').textContent = `${filtered.length}件の回答`;

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-sleepy-400">
                        <i data-lucide="search-x" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                        <p class="text-sm">該当する回答がありません</p>
                    </div>
                `;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            container.innerHTML = filtered.map(c => {
                const regDate = c.timestamp ? new Date(c.timestamp).toLocaleDateString('ja-JP', {year: 'numeric', month: 'short', day: 'numeric'}) : '-';
                const storeName = c.store === 'ebisu' ? '恵比寿駅前店' : c.store === 'kadomori' ? '大阪KADOMORI店' : c.store === 'fukushima' ? '福島店' : c.storeName || '-';
                const birthVal = c.birthday || c.birthDate;
                let age = '-';
                if (birthVal) {
                    const birth = new Date(birthVal);
                    if (!isNaN(birth.getTime())) {
                        age = now.getFullYear() - birth.getFullYear();
                    }
                }
                const snsVal = c.snsOk || c.snsPermission || '';
                const hasSns = snsVal.includes('はい') || snsVal.includes('OK') || snsVal.includes('許可');

                // 眉毛メニュー情報があるか
                const hasEyebrowInfo = c.eyebrowFrequency || c.eyebrowLastCare || c.eyebrowConcern || c.eyebrowDesign || c.eyebrowImpression || c.eyebrowTrouble;
                // まつ毛メニュー情報があるか
                const hasLashInfo = c.lashFrequency || c.lashDesign || c.lashEyeLook || c.lashContact || c.lashTrouble;
                // その他情報があるか
                const hasOtherInfo = c.allergy || c.fromOtherSalon || c.dissatisfaction;

                return `
                    <div class="bg-white border border-sleepy-200 rounded-lg shadow-sm hover:shadow-md transition overflow-hidden">
                        <!-- ヘッダー: 名前・日付・店舗 -->
                        <div class="bg-gradient-to-r ${c.store === 'ebisu' ? 'from-blue-50 to-blue-100' : 'from-purple-50 to-purple-100'} px-4 py-3 border-b border-sleepy-200">
                            <div class="flex flex-wrap items-center justify-between gap-2">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-full ${c.store === 'ebisu' ? 'bg-blue-200 text-blue-700' : 'bg-purple-200 text-purple-700'} flex items-center justify-center font-bold text-lg">
                                        ${c.name ? c.name.charAt(0) : '?'}
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-sleepy-800 text-lg">${c.name || '名前未入力'}</h4>
                                        <p class="text-sm text-sleepy-500">${c.nameKana || ''}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="px-3 py-1 text-sm font-semibold rounded-full ${c.store === 'ebisu' ? 'bg-blue-500 text-white' : 'bg-purple-500 text-white'}">${storeName}</span>
                                    <span class="text-sm text-sleepy-500 bg-white px-2 py-1 rounded">${regDate}</span>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 space-y-4">
                            <!-- 基本情報 -->
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3 text-sm bg-sleepy-50 p-3 rounded-lg">
                                <div>
                                    <span class="text-xs text-sleepy-400 block">年齢</span>
                                    <span class="font-semibold text-sleepy-700">${age !== '-' ? age + '歳' : '-'}</span>
                                </div>
                                <div>
                                    <span class="text-xs text-sleepy-400 block">職業</span>
                                    <span class="font-semibold text-sleepy-700">${c.job || c.occupation || '-'}</span>
                                </div>
                                <div>
                                    <span class="text-xs text-sleepy-400 block">電話番号</span>
                                    <span class="font-semibold text-sleepy-700">${c.phone || '-'}</span>
                                </div>
                                <div>
                                    <span class="text-xs text-sleepy-400 block">住所</span>
                                    <span class="font-semibold text-sleepy-700 text-xs">${c.address || '-'}</span>
                                </div>
                                <div>
                                    <span class="text-xs text-sleepy-400 block">生年月日</span>
                                    <span class="font-semibold text-sleepy-700 text-xs">${birthVal || '-'}</span>
                                </div>
                                <div>
                                    <span class="text-xs text-sleepy-400 block">SNS許可</span>
                                    <span class="font-semibold ${hasSns ? 'text-emerald-600' : 'text-red-500'}">${c.snsOk || c.snsPermission || '-'}</span>
                                </div>
                            </div>

                            <!-- 来店理由 -->
                            ${c.visitReason ? `
                            <div class="bg-amber-50 p-3 rounded-lg border-l-4 border-amber-400">
                                <span class="text-xs font-bold text-amber-700 block mb-1">来店理由</span>
                                <p class="text-sm text-sleepy-700">${c.visitReason}</p>
                            </div>
                            ` : ''}

                            <!-- 他サロン・不満点 -->
                            ${(c.fromOtherSalon || c.dissatisfaction) ? `
                            <div class="bg-orange-50 p-3 rounded-lg border-l-4 border-orange-400">
                                <span class="text-xs font-bold text-orange-700 block mb-2">他サロン情報</span>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                                    ${c.fromOtherSalon ? `<div><span class="text-sleepy-400">他サロン利用:</span> <span class="text-sleepy-700">${c.fromOtherSalon}</span></div>` : ''}
                                    ${c.dissatisfaction ? `<div><span class="text-sleepy-400">不満点:</span> <span class="text-sleepy-700">${c.dissatisfaction}</span></div>` : ''}
                                </div>
                            </div>
                            ` : ''}

                            <!-- アレルギー情報 -->
                            ${c.allergy ? `
                            <div class="bg-red-50 p-3 rounded-lg border-l-4 border-red-500">
                                <span class="text-xs font-bold text-red-600 block mb-1">アレルギー情報</span>
                                <p class="text-sm text-red-700 font-semibold">${c.allergy}</p>
                            </div>
                            ` : ''}

                            <!-- 眉毛・まつ毛メニュー情報 -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                ${hasEyebrowInfo ? `
                                <div class="bg-[#fdf5f2] p-4 rounded-lg border border-[#f0d5ce]">
                                    <h5 class="text-sm font-bold text-[#d49890] mb-3 flex items-center gap-2 pb-2 border-b border-[#f0d5ce]">
                                        <i data-lucide="eye" class="w-4 h-4"></i>眉毛メニュー
                                    </h5>
                                    <div class="space-y-2 text-sm">
                                        ${c.eyebrowFrequency ? `<div class="flex"><span class="text-sleepy-400 w-28 shrink-0">利用頻度:</span><span class="text-sleepy-700">${c.eyebrowFrequency}</span></div>` : ''}
                                        ${c.eyebrowLastCare ? `<div class="flex"><span class="text-sleepy-400 w-28 shrink-0">最後のお手入れ:</span><span class="text-sleepy-700">${c.eyebrowLastCare}</span></div>` : ''}
                                        ${c.eyebrowConcern ? `<div class="flex"><span class="text-sleepy-400 w-28 shrink-0">お悩み:</span><span class="text-sleepy-700">${c.eyebrowConcern}</span></div>` : ''}
                                        ${c.eyebrowDesign ? `<div class="flex"><span class="text-sleepy-400 w-28 shrink-0">希望デザイン:</span><span class="text-sleepy-700">${c.eyebrowDesign}</span></div>` : ''}
                                        ${c.eyebrowImpression ? `<div class="flex"><span class="text-sleepy-400 w-28 shrink-0">希望印象:</span><span class="text-sleepy-700">${c.eyebrowImpression}</span></div>` : ''}
                                        ${c.eyebrowTrouble ? `<div class="flex"><span class="text-red-400 w-28 shrink-0">施術後トラブル:</span><span class="text-red-600">${c.eyebrowTrouble}</span></div>` : ''}
                                    </div>
                                </div>
                                ` : ''}
                                ${hasLashInfo ? `
                                <div class="bg-[#fdf8f0] p-4 rounded-lg border border-[#e8ddd0]">
                                    <h5 class="text-sm font-bold text-[#c99445] mb-3 flex items-center gap-2 pb-2 border-b border-[#e8ddd0]">
                                        <i data-lucide="sparkles" class="w-4 h-4"></i>まつ毛メニュー
                                    </h5>
                                    <div class="space-y-2 text-sm">
                                        ${c.lashFrequency ? `<div class="flex"><span class="text-sleepy-400 w-28 shrink-0">利用頻度:</span><span class="text-sleepy-700">${c.lashFrequency}</span></div>` : ''}
                                        ${c.lashDesign ? `<div class="flex"><span class="text-sleepy-400 w-28 shrink-0">希望デザイン:</span><span class="text-sleepy-700">${c.lashDesign}</span></div>` : ''}
                                        ${c.lashEyeLook ? `<div class="flex"><span class="text-sleepy-400 w-28 shrink-0">目の見え方:</span><span class="text-sleepy-700">${c.lashEyeLook}</span></div>` : ''}
                                        ${c.lashContact ? `<div class="flex"><span class="text-sleepy-400 w-28 shrink-0">コンタクト:</span><span class="text-sleepy-700">${c.lashContact}</span></div>` : ''}
                                        ${c.lashTrouble ? `<div class="flex"><span class="text-red-400 w-28 shrink-0">施術後トラブル:</span><span class="text-red-600">${c.lashTrouble}</span></div>` : ''}
                                    </div>
                                </div>
                                ` : ''}
                            </div>

                            <!-- 同意確認 -->
                            ${c.agreement ? `
                            <div class="text-xs text-sleepy-400 pt-2 border-t border-sleepy-100">
                                <span class="font-semibold">注意事項確認:</span> ${c.agreement}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            // URLパラメータを小文字に正規化（STAFF_ROSTERと一致させるため）
            const pStore = (params.get('store') || '').toLowerCase() || null;
            const pStaff = (params.get('staff') || '').toLowerCase() || null;
            const storeSel = document.getElementById('store-selector');
            const staffSel = document.getElementById('staff-selector');
            const staffModeBadge = document.getElementById('staff-mode-badge');

            if (pStore && STAFF_ROSTER[pStore]) {
                lockedStore = pStore;
                storeSel.value = pStore;
                storeSel.disabled = true;
                staffSel.innerHTML = '<option value="all">店舗合計</option>';

                // 大文字小文字を区別しないでスタッフ名を照合
                const matchedStaff = pStaff && STAFF_ROSTER[pStore].find(s => s.toLowerCase() === pStaff.toLowerCase());
                if (matchedStaff) {
                    lockedStaff = matchedStaff; // STAFF_ROSTERの正式な名前を使用
                    const opt = document.createElement('option');
                    opt.value = matchedStaff;
                    opt.text = matchedStaff;
                    staffSel.appendChild(opt);
                    staffSel.value = matchedStaff;

                    // グレーアウトしたセレクターを非表示にする
                    storeSel.parentElement.style.display = 'none';
                    staffSel.parentElement.style.display = 'none';

                    // Show staff mode badge
                    staffModeBadge.classList.remove('hidden');
                    staffModeBadge.innerText = `${matchedStaff} 専用`;

                    // スタッフ専用ページ：不要なタブを非表示にする
                    const hideTabs = ['tab-overview', 'tab-customers', 'tab-kpi', 'tab-marketing', 'tab-goal', 'tab-settings'];
                    hideTabs.forEach(tabId => {
                        const tab = document.getElementById(tabId);
                        if (tab) tab.style.display = 'none';
                    });

                    // スタッフ専用ページ：タブ順序を変更（マイダッシュボード→カウンセリング回答→売上詳細→カレンダー→データ編集）
                    const tabContainer = document.getElementById('main-tabs');
                    if (tabContainer) {
                        const tabOrder = ['tab-staff-dashboard', 'tab-counseling-results', 'tab-sales', 'tab-calendar', 'tab-edit'];
                        tabOrder.forEach((tabId, index) => {
                            const tab = document.getElementById(tabId);
                            if (tab) {
                                tab.style.order = index;
                                tab.classList.remove('hidden');
                            }
                        });
                    }

                    // Hide AI advice section for staff-specific URLs
                    const aiAdviceSection = document.getElementById('ai-advice-section');
                    if (aiAdviceSection) aiAdviceSection.style.display = 'none';

                    // スタッフ専用：編集テーブルのプレビューボタンを非表示
                    const previewBtn = document.getElementById('btn-preview-edit');
                    if (previewBtn) previewBtn.style.display = 'none';

                    // スタッフ専用：編集テーブルの店舗・スタッフ列を非表示
                    const editStoreHeader = document.getElementById('edit-th-store');
                    const editStaffHeader = document.getElementById('edit-th-staff');
                    if (editStoreHeader) editStoreHeader.style.display = 'none';
                    if (editStaffHeader) editStaffHeader.style.display = 'none';

                    // スタッフ専用ページはマイダッシュボードを初期タブとして開く
                    setTimeout(() => switchTab('staff-dashboard'), 100);

                    // スタッフ専用ページはパスワード認証が必要（matchedStaffを使用）
                    const staffPassword = getStaffPassword(pStore, matchedStaff);
                    if (staffPassword !== null && staffPassword !== '') {
                        // パスワードが設定されている場合はログインモーダルを表示
                        showStaffLoginModal(pStore, matchedStaff);
                    } else {
                        // パスワード未設定の場合は認証済みとする
                        isStaffAuthenticated = true;
                    }
                } else {
                    STAFF_ROSTER[pStore].forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.text = name;
                        staffSel.appendChild(opt);
                    });
                }
            } else {
                handleStoreChange(false);
            }
        }

        let currentPeriodFilter = 'month'; // 'month', '3months', '6months', 'year'

        function getFilteredData() {
            // rawDataが配列でない場合は空配列を返す
            if (!Array.isArray(rawData)) {
                console.warn('getFilteredData: rawDataが配列ではありません');
                return [];
            }

            const storeFilter = document.getElementById('store-selector')?.value || 'all';
            const staffFilter = document.getElementById('staff-selector')?.value || 'all';
            const dateSelector = document.getElementById('date-selector');
            const selectedDate = dateSelector ? dateSelector.value : null;

            const result = rawData.filter(d => {
                if (!d || !d.date) return false;
                if (storeFilter !== 'all' && d.store !== storeFilter) return false;
                // スタッフ名の比較は大文字小文字を区別しない
                if (staffFilter !== 'all' && d.staff?.toLowerCase() !== staffFilter.toLowerCase()) return false;

                // 期間フィルタの適用
                const recordDate = new Date(d.date);
                const today = new Date();
                let startDate;

                switch (currentPeriodFilter) {
                    case 'month':
                        // selectedDateがない場合は現在の月を使用
                        const dateStr = selectedDate || `${today.getFullYear()}/${today.getMonth() + 1}`;
                        const [year, month] = dateStr.split('/').map(Number);
                        return recordDate.getFullYear() === year && (recordDate.getMonth() + 1) === month;
                    case '3months':
                        startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
                        return recordDate >= startDate;
                    case '6months':
                        startDate = new Date(today.getFullYear(), today.getMonth() - 5, 1);
                        return recordDate >= startDate;
                    case 'year':
                        startDate = new Date(today.getFullYear() - 1, today.getMonth(), 1);
                        return recordDate >= startDate;
                    default:
                        return true;
                }
            });

            return result;
        }

        function setPeriodFilter(period) {
            currentPeriodFilter = period;

            // ボタンのスタイルを更新
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-surface-600', 'hover:bg-surface-200');
            });
            const activeBtn = document.getElementById(`period-${period}`);
            if (activeBtn) {
                activeBtn.classList.remove('text-surface-600', 'hover:bg-surface-200');
                activeBtn.classList.add('active');
            }

            // 日付セレクタの表示/非表示を切り替え
            const dateSelectorWrapper = document.getElementById('date-selector').parentElement;
            if (period === 'month') {
                dateSelectorWrapper.style.display = '';
            } else {
                dateSelectorWrapper.style.display = 'none';
            }

            // ダッシュボードを更新
            updateDashboard();
        }

        function calculateMetrics(data) {
            let agg = {
                salesTotal: 0, salesCash: 0, salesCredit: 0, salesQR: 0,
                customersTotal: 0, customersNew: 0, customersExisting: 0,
                newByChannel: { hpb: 0, mininai: 0 },
                nextRes: { hpbNew: 0, mininaiNew: 0, existing: 0, total: 0 },
                hpbNewCount: 0, lossTotal: 0, reviews5StarTotal: 0, daily: {}
            };

            // dataが配列でない場合は空の結果を返す
            if (!Array.isArray(data)) {
                console.warn('calculateMetrics: dataが配列ではありません', data);
                return agg;
            }

            data.forEach(d => {
                if (!d || !d.date) return; // 無効なデータをスキップ
                if (!agg.daily[d.date]) agg.daily[d.date] = { sales: 0, customers: 0, new: 0, existing: 0, hpb: 0, mininai: 0 };
            });

            data.forEach(d => {
                // 無効なデータをスキップ
                if (!d) return;

                // オブジェクトの存在チェックとデフォルト値の設定
                const sales = d.sales || {};
                const discounts = d.discounts || {};
                const customers = d.customers || {};
                const nextRes = d.nextRes || {};

                // 売上 = 現金 + クレジット + QR + HPBポイント + HPBギフト券
                const salesCash = sales.cash || 0;
                const salesCredit = sales.credit || 0;
                const salesQR = sales.qr || 0;
                const hpbPoints = discounts.hpbPoints || 0;
                const hpbGift = discounts.hpbGift || 0;
                const totalSales = salesCash + salesCredit + salesQR + hpbPoints + hpbGift;

                agg.salesTotal += totalSales;
                agg.salesCash += salesCash;
                agg.salesCredit += salesCredit;
                agg.salesQR += salesQR;
                // 損失 = その他割引 + 返金（HPBポイントとギフト券は売上に含まれるため除外）
                agg.lossTotal += ((discounts.other || 0) + (discounts.refund || 0));

                // 既存客には知り合い価格も含める
                const custNewHPB = customers.newHPB || 0;
                const custNewMiniNai = customers.newMiniNai || 0;
                const existingCount = (customers.existing || 0) + (customers.acquaintance || 0);
                const totalCust = custNewHPB + custNewMiniNai + existingCount;
                const newCust = custNewHPB + custNewMiniNai;

                agg.customersTotal += totalCust;
                agg.customersNew += newCust;
                agg.customersExisting += existingCount;
                agg.newByChannel.hpb += custNewHPB;
                agg.newByChannel.mininai += custNewMiniNai;

                const nextResNewHPB = nextRes.newHPB || 0;
                const nextResNewMiniNai = nextRes.newMiniNai || 0;
                const nextResExisting = nextRes.existing || 0;

                agg.nextRes.hpbNew += nextResNewHPB;
                agg.nextRes.mininaiNew += nextResNewMiniNai;
                agg.nextRes.existing += nextResExisting;
                agg.nextRes.total += (nextResNewHPB + nextResNewMiniNai + nextResExisting);
                agg.hpbNewCount += custNewHPB;
                agg.reviews5StarTotal += (d.reviews5Star || 0);

                if(d.date && agg.daily[d.date]) {
                    agg.daily[d.date].sales += totalSales;
                    agg.daily[d.date].customers += totalCust;
                    agg.daily[d.date].new += newCust;
                    agg.daily[d.date].existing += existingCount;
                    agg.daily[d.date].hpb += custNewHPB;
                    agg.daily[d.date].mininai += custNewMiniNai;
                }
            });
            return agg;
        }

        // --- 3. UI LOGIC ---
        function handleStoreChange(isUserAction = true) {
            if (isUserAction && lockedStore) return;
            const storeSel = document.getElementById('store-selector');
            const staffSel = document.getElementById('staff-selector');
            const selectedStore = storeSel.value;

            staffSel.innerHTML = '<option value="all">店舗合計</option>';
            if (selectedStore === 'all') {
                staffSel.disabled = true;
            } else {
                staffSel.disabled = false;
                if(STAFF_ROSTER[selectedStore]){
                    STAFF_ROSTER[selectedStore].forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.text = name;
                        staffSel.appendChild(opt);
                    });
                }
            }
            if(isUserAction) updateDashboard();
        }

        function updateDashboard() {
            const filtered = getFilteredData();
            const metrics = calculateMetrics(filtered);
            const fmt = n => n.toLocaleString();

            // Get current goal based on context
            const context = getCurrentGoalContext();
            let currentGoalData;
            if (context.type === 'staff') {
                currentGoalData = getStaffGoal(context.store, context.staff);
            } else if (context.type === 'store') {
                currentGoalData = getStoreAggregateGoal(context.store);
            } else {
                currentGoalData = getAllStoresAggregateGoal();
            }
            const currentGoal = currentGoalData.weekdays * currentGoalData.weekdayTarget + currentGoalData.weekends * currentGoalData.weekendTarget;
            monthlyGoal = currentGoal; // Update global for backwards compatibility

            document.getElementById('kpi-sales').innerText = `¥${fmt(metrics.salesTotal)}`;
            document.getElementById('kpi-customers').innerHTML = `${fmt(metrics.customersTotal)}<span class="text-base font-normal ml-1">名</span>`;
            document.getElementById('kpi-new').innerText = fmt(metrics.customersNew);
            document.getElementById('kpi-existing').innerText = fmt(metrics.customersExisting);

            // Update goal ratio
            const goalRatio = currentGoal > 0 ? Math.round((metrics.salesTotal / currentGoal) * 100) : 0;
            document.getElementById('kpi-goal-ratio').innerText = `${goalRatio}%`;

            const unitPrice = metrics.customersTotal > 0 ? Math.round(metrics.salesTotal / metrics.customersTotal) : 0;
            document.getElementById('kpi-unit-price').innerText = `¥${fmt(unitPrice)}`;

            // New Customer Reservation Rate: (HPB new reservations + Mini/Nailie new reservations) / All new customers
            const allNewCustomers = metrics.customersNew;
            const newResRate = allNewCustomers > 0 ? (((metrics.nextRes.hpbNew + metrics.nextRes.mininaiNew) / allNewCustomers)*100).toFixed(1) : 0;
            document.getElementById('kpi-new-reservation-rate').innerText = `${newResRate}%`;
            // Also update the large display in KPI tab
            const kpiRateHpbLg = document.getElementById('kpi-rate-hpb-lg');
            if (kpiRateHpbLg) kpiRateHpbLg.innerText = `${newResRate}%`;

            // Existing Customer Reservation Rate
            const existingResRate = metrics.customersExisting > 0 ? ((metrics.nextRes.existing / metrics.customersExisting)*100).toFixed(1) : 0;
            // Update the large display in KPI tab
            const kpiRateExistLg = document.getElementById('kpi-rate-exist-lg');
            if (kpiRateExistLg) kpiRateExistLg.innerText = `${existingResRate}%`;

            // Total Reservation Rate: Total next reservations / Total customers
            const totalResRate = metrics.customersTotal > 0 ? ((metrics.nextRes.total / metrics.customersTotal)*100).toFixed(1) : 0;
            document.getElementById('kpi-total-reservation-rate').innerText = `${totalResRate}%`;
            // Also update the large display in KPI tab
            const kpiRateTotalLg = document.getElementById('kpi-rate-total-lg');
            if (kpiRateTotalLg) kpiRateTotalLg.innerText = `${totalResRate}%`;

            // Staff Dashboard Tab Logic
            const staffSel = document.getElementById('staff-selector');
            const staffDashboardTab = document.getElementById('tab-staff-dashboard');
            const counselingResultsTab = document.getElementById('tab-counseling-results');

            if (staffSel.value !== 'all') {
                staffDashboardTab.classList.remove('hidden');
                if (counselingResultsTab) counselingResultsTab.classList.remove('hidden');

                // Calculate incentive data for staff dashboard
                const storeVal = document.getElementById('store-selector').value;
                const incentiveData = calculateIncentive(filtered, storeVal, staffSel.value);

                // Update Staff Dashboard
                updateStaffDashboard(staffSel.value, metrics, incentiveData);
            } else {
                staffDashboardTab.classList.add('hidden');
                if (counselingResultsTab) counselingResultsTab.classList.add('hidden');
            }

            updateTable(filtered);
            updateCharts(metrics);
            try { renderEditTable(filtered); } catch (e) { console.error('renderEditTable エラー:', e); }

            // Update Staff Summary in Overview
            updateStaffSummary();

            // Update Staff Incentive Summary (Admin Only)
            updateStaffIncentiveSummary();

            // Update Blog Progress
            updateBlogProgress();
        }

        function updateStaffDashboard(staffName, personalMetrics, incentiveData) {
            const fmt = n => n.toLocaleString();

            // Update staff name (if element exists)
            const staffNameEl = document.getElementById('staff-dashboard-name');
            if (staffNameEl) staffNameEl.innerText = staffName;

            // Get store total (filter by current store AND period)
            const storeFilter = document.getElementById('store-selector')?.value || 'all';
            const dateSelector = document.getElementById('date-selector');
            const selectedDate = dateSelector ? dateSelector.value : null;
            const safeRawData = Array.isArray(rawData) ? rawData : [];

            // 店舗データも同じ期間でフィルタリング
            const storeData = safeRawData.filter(d => {
                if (!d || !d.date) return false;
                if (storeFilter !== 'all' && d.store !== storeFilter) return false;

                // 期間フィルターの適用
                const recordDate = new Date(d.date);
                const today = new Date();
                let startDate;

                switch (currentPeriodFilter) {
                    case 'month':
                        // selectedDateがない場合は現在の月を使用
                        const dateStr = selectedDate || `${today.getFullYear()}/${today.getMonth() + 1}`;
                        const [year, month] = dateStr.split('/').map(Number);
                        return recordDate.getFullYear() === year && (recordDate.getMonth() + 1) === month;
                    case '3months':
                        startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
                        return recordDate >= startDate;
                    case '6months':
                        startDate = new Date(today.getFullYear(), today.getMonth() - 5, 1);
                        return recordDate >= startDate;
                    case 'year':
                        startDate = new Date(today.getFullYear() - 1, today.getMonth(), 1);
                        return recordDate >= startDate;
                    default:
                        return true;
                }
            });
            const storeMetrics = calculateMetrics(storeData);

            // Get staff goals from storage
            const staffGoalData = getStaffGoal(storeFilter, staffName);
            const salesGoal = staffGoalData.weekdays * staffGoalData.weekdayTarget + staffGoalData.weekends * staffGoalData.weekendTarget;
            const newGoal = staffGoalData.newCustomers;
            const existingGoal = staffGoalData.existingCustomers;
            const unitPriceGoal = staffGoalData.unitPrice;
            const newResRateGoal = staffGoalData.newReservationRate;
            const resRateGoal = staffGoalData.reservationRate;

            // Store goals (aggregate from all staff in store)
            const storeGoalData = getStoreAggregateGoal(storeFilter);
            const storeSalesGoal = storeGoalData.weekdays * storeGoalData.weekdayTarget + storeGoalData.weekends * storeGoalData.weekendTarget;
            const storeNewGoal = storeGoalData.newCustomers;
            const storeExistingGoal = storeGoalData.existingCustomers;
            const storeUnitPriceGoal = storeGoalData.unitPrice;
            const storeNewResRateGoal = storeGoalData.newReservationRate;
            const storeResRateGoal = storeGoalData.reservationRate;

            // Personal metrics
            const personalUnitPrice = personalMetrics.customersTotal > 0 ? Math.round(personalMetrics.salesTotal / personalMetrics.customersTotal) : 0;
            const personalNewResRate = personalMetrics.hpbNewCount > 0 ? (((personalMetrics.nextRes.hpbNew + personalMetrics.nextRes.mininaiNew) / personalMetrics.hpbNewCount)*100).toFixed(1) : 0;
            const personalResRate = personalMetrics.customersTotal > 0 ? ((personalMetrics.nextRes.total / personalMetrics.customersTotal)*100).toFixed(1) : 0;
            const personalSalesPercent = salesGoal > 0 ? Math.round((personalMetrics.salesTotal / salesGoal) * 100) : 0;

            // Store metrics
            const storeUnitPrice = storeMetrics.customersTotal > 0 ? Math.round(storeMetrics.salesTotal / storeMetrics.customersTotal) : 0;
            const storeNewResRate = storeMetrics.hpbNewCount > 0 ? (((storeMetrics.nextRes.hpbNew + storeMetrics.nextRes.mininaiNew) / storeMetrics.hpbNewCount)*100).toFixed(1) : 0;
            const storeResRate = storeMetrics.customersTotal > 0 ? ((storeMetrics.nextRes.total / storeMetrics.customersTotal)*100).toFixed(1) : 0;
            const storeSalesPercent = storeSalesGoal > 0 ? Math.round((storeMetrics.salesTotal / storeSalesGoal) * 100) : 0;

            // Update Personal Section
            document.getElementById('staff-personal-sales').innerText = `¥${fmt(personalMetrics.salesTotal)}`;
            document.getElementById('staff-personal-goal').innerText = `¥${fmt(salesGoal)}`;
            document.getElementById('staff-personal-goal-rate').innerText = `${personalSalesPercent}%`;
            document.getElementById('staff-personal-customers').innerText = `${fmt(personalMetrics.customersTotal)}名`;
            document.getElementById('staff-personal-new').innerText = fmt(personalMetrics.customersNew);
            document.getElementById('staff-personal-new-goal').innerText = newGoal;
            document.getElementById('staff-personal-existing').innerText = fmt(personalMetrics.customersExisting);
            document.getElementById('staff-personal-existing-goal').innerText = existingGoal;
            document.getElementById('staff-personal-unit-price').innerText = `¥${fmt(personalUnitPrice)}`;
            document.getElementById('staff-personal-unit-price-goal').innerText = `¥${fmt(unitPriceGoal)}`;
            document.getElementById('staff-personal-new-res-rate').innerText = `${personalNewResRate}%`;
            document.getElementById('staff-personal-new-res-rate-goal').innerText = `${newResRateGoal}%`;
            document.getElementById('staff-personal-res-rate').innerText = `${personalResRate}%`;
            document.getElementById('staff-personal-res-rate-goal').innerText = `${resRateGoal}%`;
            document.getElementById('staff-personal-reviews').innerText = fmt(personalMetrics.reviews5StarTotal);
            document.getElementById('staff-personal-reviews-goal').innerText = staffGoalData.reviews5Star || 0;

            // Update Store Section
            document.getElementById('staff-store-sales').innerText = `¥${fmt(storeMetrics.salesTotal)}`;
            document.getElementById('staff-store-goal').innerText = `¥${fmt(storeSalesGoal)}`;
            document.getElementById('staff-store-goal-rate').innerText = `${storeSalesPercent}%`;
            document.getElementById('staff-store-customers').innerText = `${fmt(storeMetrics.customersTotal)}名`;
            document.getElementById('staff-store-new').innerText = fmt(storeMetrics.customersNew);
            document.getElementById('staff-store-new-goal').innerText = storeNewGoal;
            document.getElementById('staff-store-existing').innerText = fmt(storeMetrics.customersExisting);
            document.getElementById('staff-store-existing-goal').innerText = storeExistingGoal;
            document.getElementById('staff-store-unit-price').innerText = `¥${fmt(storeUnitPrice)}`;
            document.getElementById('staff-store-unit-price-goal').innerText = `¥${fmt(storeUnitPriceGoal)}`;
            document.getElementById('staff-store-new-res-rate').innerText = `${storeNewResRate}%`;
            document.getElementById('staff-store-new-res-rate-goal').innerText = `${storeNewResRateGoal}%`;
            document.getElementById('staff-store-res-rate').innerText = `${storeResRate}%`;
            document.getElementById('staff-store-res-rate-goal').innerText = `${storeResRateGoal}%`;
            document.getElementById('staff-store-reviews').innerText = fmt(storeMetrics.reviews5StarTotal);
            document.getElementById('staff-store-reviews-goal').innerText = storeGoalData.reviews5Star || 0;

            // Update Progress Bars
            const newPercent = newGoal > 0 ? Math.min(Math.round((personalMetrics.customersNew / newGoal) * 100), 100) : 0;
            const existingPercent = existingGoal > 0 ? Math.min(Math.round((personalMetrics.customersExisting / existingGoal) * 100), 100) : 0;

            document.getElementById('staff-progress-sales-percent').innerText = personalSalesPercent;
            document.getElementById('staff-progress-sales-bar').style.width = `${Math.min(personalSalesPercent, 100)}%`;
            document.getElementById('staff-progress-new-percent').innerText = newPercent;
            document.getElementById('staff-progress-new-bar').style.width = `${newPercent}%`;
            document.getElementById('staff-progress-existing-percent').innerText = existingPercent;
            document.getElementById('staff-progress-existing-bar').style.width = `${existingPercent}%`;

            // Update Incentive Details
            if (incentiveData) {
                document.getElementById('staff-incentive-total').innerText = `¥${Math.round(incentiveData.totalIncentive).toLocaleString()}`;
                document.getElementById('staff-incentive-base').innerText = `¥${incentiveData.baseSalary.toLocaleString()}`;
                document.getElementById('staff-incentive-service-sales').innerText = `施術売上: ¥${Math.round(incentiveData.serviceSales).toLocaleString()}`;
                document.getElementById('staff-incentive-service').innerText = `¥${Math.round(incentiveData.serviceIncentive).toLocaleString()}`;
                document.getElementById('staff-incentive-retail-sales').innerText = `物販売上: ¥${Math.round(incentiveData.retailSales).toLocaleString()}`;
                document.getElementById('staff-incentive-retail-rate').innerText = incentiveData.retailSales >= 100000 ? '(10%適用)' : '(5%適用)';
                document.getElementById('staff-incentive-retail').innerText = `¥${Math.round(incentiveData.retailIncentive).toLocaleString()}`;
            }

            // Load counseling data for staff dashboard
            loadCounselingForStaffDashboard();
        }

        // --- STAFF SUMMARY FUNCTIONS ---
        let staffSummaryView = 'cards';
        let staffSummarySortKey = 'sales';
        let staffSummarySortAsc = false;

        function toggleStaffSummaryView(view) {
            staffSummaryView = view;
            const cardsView = document.getElementById('staff-cards-view');
            const tableView = document.getElementById('staff-table-view');
            const cardsBtn = document.getElementById('staff-view-cards');
            const tableBtn = document.getElementById('staff-view-table');

            if (view === 'cards') {
                cardsView.classList.remove('hidden');
                tableView.classList.add('hidden');
                cardsBtn.classList.add('bg-primary-500', 'text-white');
                cardsBtn.classList.remove('text-surface-600', 'hover:bg-surface-100');
                tableBtn.classList.remove('bg-primary-500', 'text-white');
                tableBtn.classList.add('text-surface-600', 'hover:bg-surface-100');
            } else {
                cardsView.classList.add('hidden');
                tableView.classList.remove('hidden');
                tableBtn.classList.add('bg-primary-500', 'text-white');
                tableBtn.classList.remove('text-surface-600', 'hover:bg-surface-100');
                cardsBtn.classList.remove('bg-primary-500', 'text-white');
                cardsBtn.classList.add('text-surface-600', 'hover:bg-surface-100');
            }
        }

        function getStaffMetrics() {
            // rawDataが配列でない場合は空配列として扱う
            const safeRawData = Array.isArray(rawData) ? rawData : [];

            const storeFilter = document.getElementById('store-selector')?.value || 'all';
            const dateFilter = document.getElementById('date-selector')?.value || '';
            const dateParts = dateFilter.split('/');
            const year = dateParts[0] ? Number(dateParts[0]) : new Date().getFullYear();
            const month = dateParts[1] ? Number(dateParts[1]) : new Date().getMonth() + 1;

            // Filter data by store and date
            let filtered = safeRawData.filter(d => {
                if (!d || !d.date) return false;
                const dDate = new Date(d.date);
                const matchesDate = dDate.getFullYear() === year && (dDate.getMonth() + 1) === month;
                const matchesStore = storeFilter === 'all' || d.store === storeFilter;
                return matchesDate && matchesStore;
            });

            // If period filter is not 'month', expand the date range
            // スタッフフィルタを無視して、店舗と期間のみでフィルタリング
            if (currentPeriodFilter !== 'month') {
                filtered = safeRawData.filter(d => {
                    if (!d || !d.date) return false;
                    const matchesStore = storeFilter === 'all' || d.store === storeFilter;
                    if (!matchesStore) return false;

                    const recordDate = new Date(d.date);
                    const today = new Date();
                    let startDate;

                    switch (currentPeriodFilter) {
                        case '3months':
                            startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
                            return recordDate >= startDate;
                        case '6months':
                            startDate = new Date(today.getFullYear(), today.getMonth() - 5, 1);
                            return recordDate >= startDate;
                        case 'year':
                            startDate = new Date(today.getFullYear() - 1, today.getMonth(), 1);
                            return recordDate >= startDate;
                    }
                    return true;
                });
            }

            // Get all staff for the selected store(s)
            let staffList = [];
            if (storeFilter === 'all') {
                Object.values(STAFF_ROSTER).forEach(s => staffList.push(...s));
            } else {
                staffList = STAFF_ROSTER[storeFilter] || [];
            }

            // Calculate metrics for each staff
            const staffMetrics = staffList.map(staff => {
                // スタッフ名の比較は大文字小文字を区別しない
                const staffLower = staff.toLowerCase();
                const staffData = filtered.filter(d => d.staff?.toLowerCase() === staffLower);
                const metrics = calculateMetrics(staffData);

                // Calculate previous period for trend comparison
                let prevFiltered = [];
                if (currentPeriodFilter === 'month') {
                    const prevMonth = month === 1 ? 12 : month - 1;
                    const prevYear = month === 1 ? year - 1 : year;
                    prevFiltered = safeRawData.filter(d => {
                        if (!d || !d.date) return false;
                        const dDate = new Date(d.date);
                        const matchesDate = dDate.getFullYear() === prevYear && (dDate.getMonth() + 1) === prevMonth;
                        const matchesStore = storeFilter === 'all' || d.store === storeFilter;
                        return matchesDate && matchesStore && d.staff?.toLowerCase() === staffLower;
                    });
                }
                const prevMetrics = calculateMetrics(prevFiltered);

                // Calculate derived metrics
                const unitPrice = metrics.customersTotal > 0 ? Math.round(metrics.salesTotal / metrics.customersTotal) : 0;
                const nextResRate = metrics.customersTotal > 0 ? Math.round((metrics.nextRes.total / metrics.customersTotal) * 100) : 0;
                const salesTrend = prevMetrics.salesTotal > 0 ? Math.round(((metrics.salesTotal - prevMetrics.salesTotal) / prevMetrics.salesTotal) * 100) : 0;

                // Get staff goal（期間フィルターに応じて調整）
                const staffStore = storeFilter === 'all' ? (safeRawData.find(d => d && d.staff?.toLowerCase() === staffLower)?.store || getStaffStoreFromRoster(staff) || 'ebisu') : storeFilter;
                const goalData = getStaffGoal(staffStore, staff);
                const monthlyGoal = goalData.weekdays * goalData.weekdayTarget + goalData.weekends * goalData.weekendTarget;

                // 期間フィルターに応じて目標を倍数化
                let goalMultiplier = 1;
                switch (currentPeriodFilter) {
                    case '3months': goalMultiplier = 3; break;
                    case '6months': goalMultiplier = 6; break;
                    case 'year': goalMultiplier = 12; break;
                }
                const salesGoal = monthlyGoal * goalMultiplier;
                const goalRate = salesGoal > 0 ? Math.round((metrics.salesTotal / salesGoal) * 100) : 0;

                return {
                    name: staff,
                    store: staffStore,
                    sales: metrics.salesTotal,
                    customers: metrics.customersTotal,
                    newCustomers: metrics.customersNew,
                    existingCustomers: metrics.customersExisting,
                    unitPrice,
                    nextResRate,
                    salesTrend,
                    goalRate,
                    salesGoal,
                    hpbNew: metrics.newByChannel?.hpb || 0,
                    miniNaiNew: metrics.newByChannel?.mininai || 0
                };
            });

            // Sort by sales (default)
            return staffMetrics.sort((a, b) => b.sales - a.sales);
        }

        function updateStaffSummary() {
            let staffMetrics = getStaffMetrics();
            const fmt = n => n.toLocaleString();

            // スタッフ専用URLの場合は上位3名のみ表示
            if (lockedStaff) {
                staffMetrics = staffMetrics.slice(0, 3);
            }

            // Update Cards View
            const cardsContainer = document.getElementById('staff-cards-view');
            if (staffMetrics.length === 0) {
                cardsContainer.innerHTML = `
                    <div class="text-center text-surface-500 py-8 col-span-full">
                        <i data-lucide="users" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                        <p class="text-sm">スタッフデータがありません</p>
                    </div>
                `;
            } else {
                cardsContainer.innerHTML = staffMetrics.map((s, i) => `
                    <div class="bg-surface-50 dark:bg-accent-900/50 rounded-xl p-4 hover:shadow-md transition-all duration-200 border border-surface-200 dark:border-accent-700">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full ${i === 0 ? 'bg-gradient-to-br from-amber-400 to-amber-500' : i === 1 ? 'bg-gradient-to-br from-gray-300 to-gray-400' : i === 2 ? 'bg-gradient-to-br from-amber-600 to-amber-700' : 'bg-surface-300'} flex items-center justify-center text-white text-sm font-bold">
                                    ${i + 1}
                                </div>
                                <div>
                                    <h4 class="font-semibold text-accent-800 dark:text-surface-100">${s.name}</h4>
                                    <p class="text-xs text-surface-500">${s.store === 'ebisu' ? '恵比寿駅前店' : s.store === 'kadomori' ? '大阪KADOMORI店' : s.store === 'fukushima' ? '福島店' : s.store}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="text-xs px-2 py-1 rounded-full ${s.salesTrend >= 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
                                    ${s.salesTrend >= 0 ? '↑' : '↓'} ${Math.abs(s.salesTrend)}%
                                </span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white dark:bg-accent-800 rounded-lg p-2">
                                <p class="text-xs text-surface-500 mb-1">売上</p>
                                <p class="text-lg font-bold text-accent-800 dark:text-surface-100">¥${fmt(s.sales)}</p>
                                <div class="mt-1 flex items-center gap-1">
                                    <div class="flex-1 bg-surface-200 dark:bg-accent-700 h-1.5 rounded-full overflow-hidden">
                                        <div class="h-full bg-primary-500 rounded-full" style="width: ${Math.min(s.goalRate, 100)}%"></div>
                                    </div>
                                    <span class="text-xs text-surface-500">${s.goalRate}%</span>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-accent-800 rounded-lg p-2">
                                <p class="text-xs text-surface-500 mb-1">来店数</p>
                                <p class="text-lg font-bold text-accent-800 dark:text-surface-100">${s.customers}<span class="text-xs font-normal ml-1">名</span></p>
                                <p class="text-xs text-surface-500 mt-1">新規 ${s.newCustomers} / 既存 ${s.existingCustomers}</p>
                            </div>
                            <div class="bg-white dark:bg-accent-800 rounded-lg p-2">
                                <p class="text-xs text-surface-500 mb-1">客単価</p>
                                <p class="text-lg font-bold text-accent-800 dark:text-surface-100">¥${fmt(s.unitPrice)}</p>
                            </div>
                            <div class="bg-white dark:bg-accent-800 rounded-lg p-2">
                                <p class="text-xs text-surface-500 mb-1">次回予約率</p>
                                <p class="text-lg font-bold text-accent-800 dark:text-surface-100">${s.nextResRate}%</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Update Table View
            const tableBody = document.getElementById('staff-table-body');
            tableBody.innerHTML = staffMetrics.map((s, i) => `
                <tr class="border-b border-surface-100 hover:bg-surface-50 dark:hover:bg-accent-800/50 transition">
                    <td class="py-3 px-4">
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full ${i === 0 ? 'bg-amber-500 text-white' : i === 1 ? 'bg-gray-400 text-white' : i === 2 ? 'bg-amber-700 text-white' : 'bg-surface-200 text-surface-600'} text-xs font-bold">
                            ${i + 1}
                        </span>
                    </td>
                    <td class="py-3 px-4 font-medium text-accent-800 dark:text-surface-100">${s.name}</td>
                    <td class="py-3 px-4 text-right font-semibold text-accent-800 dark:text-surface-100">¥${fmt(s.sales)}</td>
                    <td class="py-3 px-4 text-right">${s.customers}</td>
                    <td class="py-3 px-4 text-right text-primary-600 font-medium">${s.newCustomers}</td>
                    <td class="py-3 px-4 text-right">¥${fmt(s.unitPrice)}</td>
                    <td class="py-3 px-4 text-right">${s.nextResRate}%</td>
                    <td class="py-3 px-4 text-center">
                        <span class="inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full ${s.salesTrend >= 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
                            ${s.salesTrend >= 0 ? '↑' : '↓'} ${Math.abs(s.salesTrend)}%
                        </span>
                    </td>
                </tr>
            `).join('');

            // Update Rankings
            updateStaffRankings(staffMetrics);

            // Re-render Lucide icons
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function updateStaffRankings(staffMetrics) {
            const fmt = n => n.toLocaleString();
            // スタッフ専用URLの場合は上位3名、それ以外は上位5名
            const rankingLimit = lockedStaff ? 3 : 5;

            // Sales Ranking
            const salesRanking = [...staffMetrics].sort((a, b) => b.sales - a.sales).slice(0, rankingLimit);
            const maxSales = salesRanking[0]?.sales || 1;
            document.getElementById('sales-ranking-list').innerHTML = salesRanking.map((s, i) => `
                <div class="flex items-center gap-2">
                    <span class="w-5 h-5 rounded-full ${i === 0 ? 'bg-amber-500' : i === 1 ? 'bg-gray-400' : i === 2 ? 'bg-amber-700' : 'bg-surface-300'} text-white text-xs flex items-center justify-center font-bold">${i + 1}</span>
                    <span class="flex-shrink-0 w-16 text-sm text-accent-700 dark:text-surface-200 truncate">${s.name}</span>
                    <div class="flex-1 bg-surface-200 dark:bg-accent-700 h-2 rounded-full overflow-hidden">
                        <div class="h-full bg-amber-500 rounded-full" style="width: ${(s.sales / maxSales) * 100}%"></div>
                    </div>
                    <span class="text-xs text-accent-600 dark:text-surface-300 w-20 text-right">¥${fmt(s.sales)}</span>
                </div>
            `).join('');

            // New Customers Ranking
            const newRanking = [...staffMetrics].sort((a, b) => b.newCustomers - a.newCustomers).slice(0, rankingLimit);
            const maxNew = newRanking[0]?.newCustomers || 1;
            document.getElementById('new-customers-ranking-list').innerHTML = newRanking.map((s, i) => `
                <div class="flex items-center gap-2">
                    <span class="w-5 h-5 rounded-full ${i === 0 ? 'bg-emerald-500' : i === 1 ? 'bg-emerald-400' : i === 2 ? 'bg-emerald-300' : 'bg-surface-300'} text-white text-xs flex items-center justify-center font-bold">${i + 1}</span>
                    <span class="flex-shrink-0 w-16 text-sm text-accent-700 dark:text-surface-200 truncate">${s.name}</span>
                    <div class="flex-1 bg-surface-200 dark:bg-accent-700 h-2 rounded-full overflow-hidden">
                        <div class="h-full bg-emerald-500 rounded-full" style="width: ${(s.newCustomers / maxNew) * 100}%"></div>
                    </div>
                    <span class="text-xs text-accent-600 dark:text-surface-300 w-12 text-right">${s.newCustomers}名</span>
                </div>
            `).join('');

            // Unit Price Ranking
            const priceRanking = [...staffMetrics].filter(s => s.unitPrice > 0).sort((a, b) => b.unitPrice - a.unitPrice).slice(0, rankingLimit);
            const maxPrice = priceRanking[0]?.unitPrice || 1;
            document.getElementById('unit-price-ranking-list').innerHTML = priceRanking.map((s, i) => `
                <div class="flex items-center gap-2">
                    <span class="w-5 h-5 rounded-full ${i === 0 ? 'bg-[#c99445]' : i === 1 ? 'bg-[#dba95e]' : i === 2 ? 'bg-[#e8c88a]' : 'bg-surface-300'} text-white text-xs flex items-center justify-center font-bold">${i + 1}</span>
                    <span class="flex-shrink-0 w-16 text-sm text-accent-700 dark:text-surface-200 truncate">${s.name}</span>
                    <div class="flex-1 bg-surface-200 dark:bg-accent-700 h-2 rounded-full overflow-hidden">
                        <div class="h-full bg-[#c99445] rounded-full" style="width: ${(s.unitPrice / maxPrice) * 100}%"></div>
                    </div>
                    <span class="text-xs text-accent-600 dark:text-surface-300 w-16 text-right">¥${fmt(s.unitPrice)}</span>
                </div>
            `).join('');
        }

        // 管理者専用：スタッフ別インセンティブ一覧を更新
        function updateStaffIncentiveSummary() {
            const fmt = n => n.toLocaleString();
            const incentiveSection = document.getElementById('staff-incentive-section');

            // スタッフ専用ページの場合は非表示
            if (lockedStore || lockedStaff) {
                if (incentiveSection) incentiveSection.style.display = 'none';
                return;
            }

            if (incentiveSection) incentiveSection.style.display = 'block';

            const tableBody = document.getElementById('staff-incentive-table-body');
            if (!tableBody) return;

            // Get current store/staff filter
            const storeFilter = document.getElementById('store-selector')?.value || 'all';
            const dateFilter = document.getElementById('date-selector')?.value || '';

            // Get all staff for all stores (or filtered store)
            const stores = storeFilter === 'all' ? Object.keys(STAFF_ROSTER) : [storeFilter];

            let allIncentives = [];
            let totals = {
                baseSalary: 0,
                serviceSales: 0,
                serviceIncentive: 0,
                retailSales: 0,
                retailIncentive: 0,
                totalIncentive: 0
            };

            // Calculate incentives for each staff
            stores.forEach(store => {
                const storeStaff = STAFF_ROSTER[store] || [];
                storeStaff.forEach(staffName => {
                    // Filter data for this staff
                    const staffData = (Array.isArray(rawData) ? rawData : []).filter(d => {
                        if (!d) return false;
                        // Date filter
                        if (dateFilter && d.date) {
                            const dateParts = d.date.split('/');
                            if (dateParts.length >= 2) {
                                const dataYM = `${dateParts[0]}/${parseInt(dateParts[1])}`;
                                if (dataYM !== dateFilter) return false;
                            }
                        }
                        return d.store === store && d.staff === staffName;
                    });

                    // Calculate incentive
                    const incentive = calculateIncentive(staffData, store, staffName);

                    allIncentives.push({
                        store,
                        name: staffName,
                        ...incentive
                    });

                    // Add to totals
                    totals.baseSalary += incentive.baseSalary;
                    totals.serviceSales += incentive.serviceSales;
                    totals.serviceIncentive += incentive.serviceIncentive;
                    totals.retailSales += incentive.retailSales;
                    totals.retailIncentive += incentive.retailIncentive;
                    totals.totalIncentive += incentive.totalIncentive;
                });
            });

            // Sort by total incentive descending
            allIncentives.sort((a, b) => b.totalIncentive - a.totalIncentive);

            // Generate table rows
            tableBody.innerHTML = allIncentives.map(s => {
                const storeName = s.store === 'ebisu' ? '恵比寿駅前店' : s.store === 'kadomori' ? '大阪KADOMORI店' : s.store === 'fukushima' ? '福島店' : s.store;
                return `
                    <tr class="hover:bg-surface-50 transition">
                        <td class="py-3 px-4 text-surface-600">${storeName}</td>
                        <td class="py-3 px-4 font-medium text-accent-800">${s.name}</td>
                        <td class="py-3 px-4 text-right text-surface-600">¥${fmt(s.baseSalary)}</td>
                        <td class="py-3 px-4 text-right text-surface-600">¥${fmt(Math.round(s.serviceSales))}</td>
                        <td class="py-3 px-4 text-right text-emerald-600">¥${fmt(Math.round(s.serviceIncentive))}</td>
                        <td class="py-3 px-4 text-right text-surface-600">¥${fmt(Math.round(s.retailSales))}</td>
                        <td class="py-3 px-4 text-right text-emerald-600">¥${fmt(Math.round(s.retailIncentive))}</td>
                        <td class="py-3 px-4 text-right font-bold text-[#c99445] text-base">¥${fmt(Math.round(s.totalIncentive))}</td>
                    </tr>
                `;
            }).join('');

            // Update totals
            document.getElementById('incentive-total-base').innerText = `¥${fmt(totals.baseSalary)}`;
            document.getElementById('incentive-total-service-sales').innerText = `¥${fmt(Math.round(totals.serviceSales))}`;
            document.getElementById('incentive-total-service').innerText = `¥${fmt(Math.round(totals.serviceIncentive))}`;
            document.getElementById('incentive-total-retail-sales').innerText = `¥${fmt(Math.round(totals.retailSales))}`;
            document.getElementById('incentive-total-retail').innerText = `¥${fmt(Math.round(totals.retailIncentive))}`;
            document.getElementById('incentive-grand-total').innerText = `¥${fmt(Math.round(totals.totalIncentive))}`;
        }

        // ブログ・SNS更新進捗を更新
        function updateBlogProgress() {
            const container = document.getElementById('blog-progress-container');
            if (!container) return;

            const BLOG_TARGET = 10; // 月間目標10件
            const filtered = getFilteredData();

            // 選択中の月のデータを取得
            const dateSelector = document.getElementById('date-selector');
            const selectedDate = dateSelector?.value || '';
            const [targetYear, targetMonth] = selectedDate ? selectedDate.split('/').map(Number) : [new Date().getFullYear(), new Date().getMonth() + 1];

            // スタッフごとのブログ・SNS更新数を集計
            const staffProgress = {};
            filtered.forEach(record => {
                if (!record.date) return;
                const recordDate = new Date(record.date);
                if (recordDate.getFullYear() === targetYear && (recordDate.getMonth() + 1) === targetMonth) {
                    const staffName = record.staff;
                    if (!staffProgress[staffName]) {
                        staffProgress[staffName] = { blogUpdates: 0, snsUpdates: 0 };
                    }
                    staffProgress[staffName].blogUpdates += record.blogUpdates || 0;
                    staffProgress[staffName].snsUpdates += record.snsUpdates || 0;
                }
            });

            const staffList = Object.entries(staffProgress).sort((a, b) => b[1].blogUpdates - a[1].blogUpdates);

            if (staffList.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-surface-500 py-8 col-span-full">
                        <i data-lucide="file-x" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                        <p class="text-sm">ブログ更新データがありません</p>
                    </div>
                `;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            container.innerHTML = staffList.map(([staffName, data]) => {
                const blogPercent = Math.min((data.blogUpdates / BLOG_TARGET) * 100, 100);
                const isComplete = data.blogUpdates >= BLOG_TARGET;
                const barColor = isComplete ? 'bg-emerald-500' : blogPercent >= 70 ? 'bg-amber-500' : 'bg-orange-500';

                return `
                    <div class="bg-surface-50 rounded-xl p-4 border border-surface-200">
                        <div class="flex items-center justify-between mb-3">
                            <span class="font-semibold text-accent-800">${staffName}</span>
                            ${isComplete ? '<span class="text-emerald-600 text-xs font-bold">🎉 達成!</span>' : ''}
                        </div>
                        <div class="space-y-2">
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-surface-600">ブログ</span>
                                    <span class="font-bold ${isComplete ? 'text-emerald-600' : 'text-accent-800'}">${data.blogUpdates} / ${BLOG_TARGET}件</span>
                                </div>
                                <div class="w-full bg-surface-200 h-3 rounded-full overflow-hidden">
                                    <div class="h-full ${barColor} rounded-full transition-all duration-500" style="width: ${blogPercent}%"></div>
                                </div>
                            </div>
                            <div class="flex justify-between text-xs text-surface-500 pt-1">
                                <span>SNS更新</span>
                                <span class="font-medium text-accent-700">${data.snsUpdates}件</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function updateTable(data) {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = '';
            const sorted = [...data].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 20);

            sorted.forEach(d => {
                const total = d.sales.cash + d.sales.credit + d.sales.qr;
                const allNewCust = (d.customers.newHPB || 0) + (d.customers.newMiniNai || 0);
                const newResRate = allNewCust > 0 ? Math.round(((d.nextRes.newHPB + d.nextRes.newMiniNai)/allNewCust)*100) : '-';
                const storeLabel = d.store === 'ebisu' ? '恵比寿駅前店' : d.store === 'kadomori' ? '大阪KADOMORI店' : d.store === 'fukushima' ? '福島店' : d.store;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-xs font-bold text-sleepy-800">${storeLabel}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-sleepy-600">${d.staff}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-sleepy-500">${d.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-right font-medium text-sleepy-800">¥${total.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-right text-sleepy-600">${d.customers.newHPB + d.customers.newMiniNai + d.customers.existing}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-right ${newResRate < 40 && newResRate !== '-' ? 'text-red-400' : ''}">${newResRate !== '-' ? newResRate+'%' : '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 4. CHARTS ---
        function initCharts() {
            const common = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: {family: 'sans-serif'} } } } };
            
            // Overview Chart: Line (Unit Price) + Stacked Bar (New/Existing)
            charts.overview = new Chart(document.getElementById('overviewChart'), {
                type: 'bar', // Base type
                data: {},
                options: {
                    ...common,
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: { 
                            type: 'linear', position: 'left', 
                            title: { display: true, text: '単価 (¥)' },
                            grid: { display: false } 
                        },
                        y1: { 
                            type: 'linear', position: 'right', stacked: true,
                            title: { display: true, text: '来店数 (名)' },
                            grid: { borderDash: [4, 4], color: '#e8e6e1' } 
                        }
                    }
                }
            });

            charts.ratio = new Chart(document.getElementById('customerRatioChart'), { type: 'doughnut', data: {}, options: { ...common, cutout: '70%' } });
            charts.share = new Chart(document.getElementById('channelShareChart'), { type: 'pie', data: {}, options: common });
            charts.trend = new Chart(document.getElementById('channelTrendChart'), { type: 'bar', data: {}, options: { ...common, scales: { x:{stacked:true}, y:{stacked:true} } } });
            charts.payment = new Chart(document.getElementById('paymentChart'), { type: 'doughnut', data: {}, options: { ...common, cutout: '60%' } });
            charts.loss = new Chart(document.getElementById('lossChart'), { type: 'bar', indexAxis: 'y', data: {}, options: common });
        }

        function updateCharts(metrics) {
            // Debug log for HPB data
            console.log('📊 媒体データ:', { HPB: metrics.newByChannel?.hpb || 0, minimo: metrics.newByChannel?.mininai || 0 });

            const labels = Object.keys(metrics.daily).sort((a,b) => new Date(a) - new Date(b));
            const d = metrics.daily;

            // Calculate Daily Unit Price
            const unitPriceData = labels.map(k => {
                const totalCust = d[k].customers;
                return totalCust > 0 ? Math.round(d[k].sales / totalCust) : 0;
            });

            // Update Overview Chart
            charts.overview.data = { 
                labels: labels, 
                datasets: [
                    {
                        type: 'line',
                        label: '平均客単価',
                        data: unitPriceData,
                        borderColor: BrandColors.brown,
                        backgroundColor: BrandColors.brown,
                        borderWidth: 2,
                        tension: 0.3,
                        yAxisID: 'y',
                        pointRadius: 2
                    },
                    {
                        type: 'bar',
                        label: '新規来店',
                        data: labels.map(k => d[k].new),
                        backgroundColor: BrandColors.gold,
                        yAxisID: 'y1',
                        stack: 'visits'
                    },
                    {
                        type: 'bar',
                        label: '既存来店',
                        data: labels.map(k => d[k].existing),
                        backgroundColor: BrandColors.beige,
                        yAxisID: 'y1',
                        stack: 'visits'
                    }
                ]
            }; 
            charts.overview.update();

            charts.ratio.data = { labels: ['新規', '既存'], datasets: [{ data: [metrics.customersNew, metrics.customersExisting], backgroundColor: [BrandColors.gold, BrandColors.brown], borderWidth:0 }] }; charts.ratio.update();
            // Update HPB share chart and display counts
            const hpbCount = metrics.newByChannel.hpb || 0;
            const mininaiCount = metrics.newByChannel.mininai || 0;
            document.getElementById('hpb-count').innerText = hpbCount;
            document.getElementById('mininai-count').innerText = mininaiCount;
            charts.share.data = { labels: ['HPB', 'minimo/Nailie'], datasets: [{ data: [hpbCount, mininaiCount], backgroundColor: [BrandColors.gold, BrandColors.beige], borderWidth:1, borderColor:'#fff' }] }; charts.share.update();
            charts.trend.data = { labels: labels, datasets: [
                { label: 'HPB', data: labels.map(k=>d[k].hpb), backgroundColor: BrandColors.gold },
                { label: 'minimo/Nailie', data: labels.map(k=>d[k].mininai), backgroundColor: BrandColors.beige }
            ]}; charts.trend.update();
            charts.payment.data = { labels: ['現金', 'クレカ', 'QR'], datasets: [{ data: [metrics.salesCash, metrics.salesCredit, metrics.salesQR], backgroundColor: [BrandColors.beige, BrandColors.gold, BrandColors.brown], borderWidth:0 }] }; charts.payment.update();
            charts.loss.data = { labels: ['損失'], datasets: [{ label: '割引・返金', data: [metrics.lossTotal], backgroundColor: BrandColors.brown, barThickness:40 }] }; charts.loss.update();
        }

        // --- 5. EDIT & SAVE LOGIC ---
        // 数値の安全な取得（空白・undefined・NaN → 0）
        function safeNum(val) {
            const n = parseInt(val);
            return isNaN(n) ? 0 : n;
        }

        function renderEditTable(data) {
            const tbody = document.getElementById('edit-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';

            // dataが配列でない場合は空配列として扱う
            const dataArray = Array.isArray(data) ? data : [];
            const sorted = [...dataArray].sort((a,b) => new Date(b.date) - new Date(a.date));

            const isStaffMode = !!lockedStaff;

            sorted.forEach(row => {
                if (!row) return;

                // オブジェクトのデフォルト値設定
                const sales = row.sales || {};
                const customers = row.customers || {};
                const nextRes = row.nextRes || {};
                const discounts = row.discounts || {};

                // 日付フォーマット: 年を省略して MM/DD 表記にする
                let displayDate = row.date || '';
                if (displayDate) {
                    const parts = displayDate.split('/');
                    if (parts.length === 3) {
                        displayDate = String(parts[1]).padStart(2, '0') + '/' + String(parts[2]).padStart(2, '0');
                    }
                }

                const tr = document.createElement('tr');
                tr.dataset.id = row.id;
                if (changedRows.has(row.id)) tr.classList.add('changed-row');

                // スタッフ専用モードでは店舗・スタッフ列を非表示
                const storeStaffCols = isStaffMode ? '' : `
                    <td class="px-4 py-2"><input type="text" class="edit-input edit-readonly" value="${row.storeName || ''}" readonly></td>
                    <td class="px-4 py-2"><input type="text" class="edit-input edit-readonly" value="${row.staff || ''}" readonly></td>
                `;

                tr.innerHTML = `
                    <td class="px-4 py-2"><input type="text" class="edit-input edit-input-date edit-readonly" value="${displayDate}" readonly></td>
                    ${storeStaffCols}
                    <td class="px-4 py-2"><input type="number" class="edit-input edit-input-amount" data-field="sales.cash" value="${safeNum(sales.cash)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input edit-input-amount" data-field="sales.credit" value="${safeNum(sales.credit)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input edit-input-amount" data-field="sales.qr" value="${safeNum(sales.qr)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input edit-input-amount" data-field="sales.product" value="${safeNum(sales.product)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input edit-input-amount" data-field="discounts.hpbPoints" value="${safeNum(discounts.hpbPoints)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input edit-input-amount" data-field="discounts.hpbGift" value="${safeNum(discounts.hpbGift)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input edit-input-amount" data-field="discounts.other" value="${safeNum(discounts.other)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input edit-input-amount" data-field="discounts.refund" value="${safeNum(discounts.refund)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="customers.newHPB" value="${safeNum(customers.newHPB)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="customers.newMiniNai" value="${safeNum(customers.newMiniNai)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="customers.existing" value="${safeNum(customers.existing)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="customers.acquaintance" value="${safeNum(customers.acquaintance)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="nextRes.newHPB" value="${safeNum(nextRes.newHPB)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="nextRes.newMiniNai" value="${safeNum(nextRes.newMiniNai)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="nextRes.existing" value="${safeNum(nextRes.existing)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="reviews5Star" value="${safeNum(row.reviews5Star)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="blogUpdates" value="${safeNum(row.blogUpdates)}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="snsUpdates" value="${safeNum(row.snsUpdates)}" onchange="markChanged(${row.id})"></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function markChanged(id) {
            changedRows.add(id);
            const row = document.querySelector(`tr[data-id='${id}']`);
            if(row) row.classList.add('changed-row');
        }

        function applyEditsLocally() {
            // rawDataが配列でない場合はエラーを防ぐ
            if (!Array.isArray(rawData)) {
                console.warn('applyEditsLocally: rawDataが配列ではありません');
                return;
            }

            const inputs = document.querySelectorAll('#edit-table-body input:not([readonly])');
            inputs.forEach(input => {
                const tr = input.closest('tr');
                if (!tr) return;
                const id = parseInt(tr.dataset.id);
                if (!changedRows.has(id)) return;

                const fieldPath = input.dataset.field?.split('.') || [];
                // 空白・NaN は 0 として扱う
                const val = safeNum(input.value);
                const item = rawData.find(d => d && d.id === id);
                if (item) {
                    if (fieldPath.length === 2) {
                        // ネストされたオブジェクトが存在しない場合は作成
                        if (!item[fieldPath[0]]) {
                            item[fieldPath[0]] = {};
                        }
                        item[fieldPath[0]][fieldPath[1]] = val;
                    } else if (fieldPath.length === 1) {
                        // Handle top-level fields like reviews5Star
                        item[fieldPath[0]] = val;
                    }
                }
            });
            alert("表示を更新しました (未保存)");
            updateDashboard();
        }

        async function saveToSpreadsheet() {
            if (!API_URL) {
                alert("API URLが設定されていないため、保存できません。GASをデプロイしてください。");
                applyEditsLocally();
                return;
            }

            const btn = document.getElementById('btn-save-sheet');
            const originalText = btn.innerHTML;
            btn.innerHTML = "保存中...";
            btn.disabled = true;

            applyEditsLocally();
            const safeRawData = Array.isArray(rawData) ? rawData : [];
            const modifiedData = safeRawData.filter(d => d && changedRows.has(d.id));
            
            if (modifiedData.length === 0) {
                alert("変更されたデータがありません");
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify({
                        action: "update",
                        rows: modifiedData
                    })
                });
                
                const result = await response.json();
                
                if (result.status === "success") {
                    alert("スプレッドシートへの保存が完了しました！");
                    changedRows.clear();
                    renderEditTable(getFilteredData());
                } else {
                    alert("保存エラー: " + result.message);
                }

            } catch (e) {
                console.error(e);
                alert("通信エラーが発生しました。コンソールを確認してください。");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function saveGoalsToSpreadsheet() {
            if (!API_URL) {
                alert("API URLが設定されていないため、スプレッドシートに保存できません。ローカルストレージに保存されます。");
                return;
            }

            const btn = document.getElementById('btn-save-goals');
            const originalText = btn.innerHTML;
            btn.innerHTML = "保存中...";
            btn.disabled = true;

            try {
                const goals = loadGoalsFromStorage();
                const salaries = loadBaseSalariesFromStorage();

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify({
                        action: "save_goals",
                        goals: goals,
                        salaries: salaries
                    })
                });

                const result = await response.json();

                if (result.status === "success") {
                    alert("目標データがスプレッドシートに保存されました！");
                } else {
                    alert("保存エラー: " + result.message);
                }

            } catch (e) {
                console.error(e);
                alert("通信エラーが発生しました。コンソールを確認してください。");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // スプレッドシートから目標を読み込む
        async function loadGoalsFromSpreadsheet() {
            if (!API_URL) {
                alert("API URLが設定されていません。設定タブでAPI URLを入力してください。");
                return;
            }

            const btn = document.getElementById('btn-load-goals');
            const originalText = btn.innerHTML;
            btn.innerHTML = "読み込み中...";
            btn.disabled = true;

            try {
                const response = await fetch(API_URL + '?action=load_goals');
                const result = await response.json();

                if (result.status === "success") {
                    // 目標データをローカルストレージに保存
                    if (result.goals) {
                        saveGoalsToStorage(result.goals);
                    }
                    // 基本給データを保存
                    if (result.salaries) {
                        saveBaseSalariesToStorage(result.salaries);
                    }
                    alert("目標データをスプレッドシートから読み込みました！");
                    // UIを更新
                    loadGoalInputs();
                } else {
                    alert("読み込みエラー: " + (result.message || "不明なエラー"));
                }

            } catch (e) {
                console.error(e);
                alert("通信エラーが発生しました。コンソールを確認してください。");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- 6. GOAL CALCULATOR ---

        // 目標設定タブの月セレクタを初期化
        function initGoalMonthSelector() {
            const monthSelector = document.getElementById('goal-month-selector');
            if (!monthSelector) return;

            // 既存の値をYYYY/M形式に正規化
            let currentValue = monthSelector.value;
            if (currentValue) {
                const parts = currentValue.split('/');
                if (parts.length === 2) {
                    currentValue = `${parts[0]}/${parseInt(parts[1])}`;
                }
            }
            monthSelector.innerHTML = '';

            // 過去6ヶ月から未来12ヶ月までの選択肢を生成（YYYY/M形式で統一）
            const now = new Date();
            const options = [];

            for (let i = -6; i <= 12; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const year = d.getFullYear();
                const month = d.getMonth() + 1;
                const value = `${year}/${month}`; // YYYY/M形式（date-selectorと同じ）
                const label = `${year}年${month}月`;
                options.push({ value, label, isCurrent: i === 0 });
            }

            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.text = opt.label + (opt.isCurrent ? ' (今月)' : '');
                monthSelector.appendChild(option);
            });

            // 現在選択されている月またはダッシュボードの月を選択
            const dateSelector = document.getElementById('date-selector');
            const dashboardMonth = dateSelector ? dateSelector.value : null;

            if (currentValue && Array.from(monthSelector.options).some(o => o.value === currentValue)) {
                monthSelector.value = currentValue;
            } else if (dashboardMonth && Array.from(monthSelector.options).some(o => o.value === dashboardMonth)) {
                monthSelector.value = dashboardMonth;
            } else {
                // デフォルト：今月（YYYY/M形式）
                const defaultMonth = `${now.getFullYear()}/${now.getMonth() + 1}`;
                monthSelector.value = defaultMonth;
            }
        }

        function handleGoalStoreChange() {
            const storeSel = document.getElementById('goal-store-selector');
            const staffSel = document.getElementById('goal-staff-selector');
            const selectedStore = storeSel.value;

            staffSel.innerHTML = '<option value="all">店舗合計</option>';
            if (selectedStore === 'all') {
                staffSel.disabled = true;
            } else {
                staffSel.disabled = false;
                if(STAFF_ROSTER[selectedStore]){
                    STAFF_ROSTER[selectedStore].forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.text = name;
                        staffSel.appendChild(opt);
                    });
                }
            }
            loadGoalInputs();
        }

        function getCurrentGoalContextForGoalTab() {
            const storeVal = document.getElementById('goal-store-selector').value;
            const staffVal = document.getElementById('goal-staff-selector').value;

            if (staffVal !== 'all') {
                return { type: 'staff', store: storeVal, staff: staffVal };
            } else if (storeVal !== 'all') {
                return { type: 'store', store: storeVal };
            } else {
                return { type: 'all' };
            }
        }

        function loadGoalInputs() {
            const context = getCurrentGoalContextForGoalTab();
            const yearMonth = getCurrentGoalMonth();
            let goalData;

            if (context.type === 'staff') {
                goalData = getStaffGoal(context.store, context.staff, yearMonth);
            } else if (context.type === 'store') {
                goalData = getStoreAggregateGoal(context.store, yearMonth);
            } else {
                goalData = getAllStoresAggregateGoal(yearMonth);
            }

            const fmt = n => n.toLocaleString();
            const inputColumn1 = document.getElementById('goal-input-column-1');
            const inputColumn2 = document.getElementById('goal-input-column-2');
            const storeSummary = document.getElementById('goal-store-summary');
            const hintText = document.getElementById('goal-hint-text');

            if (context.type === 'staff') {
                // スタッフ個人表示: 入力フィールドを表示、サマリーを非表示
                inputColumn1.classList.remove('hidden');
                inputColumn2.classList.remove('hidden');
                storeSummary.classList.add('hidden');

                // Load values into inputs
                document.getElementById('goal-weekdays').value = goalData.weekdays;
                document.getElementById('goal-weekends').value = goalData.weekends;
                document.getElementById('goal-weekday-target').value = goalData.weekdayTarget;
                document.getElementById('goal-weekend-target').value = goalData.weekendTarget;
                document.getElementById('goal-retail').value = goalData.retail;
                document.getElementById('goal-new-customers').value = goalData.newCustomers;
                document.getElementById('goal-existing-customers').value = goalData.existingCustomers;
                document.getElementById('goal-unit-price').value = goalData.unitPrice;
                document.getElementById('goal-new-reservation-rate').value = goalData.newReservationRate;
                document.getElementById('goal-reservation-rate').value = goalData.reservationRate;
                document.getElementById('goal-reviews-5star').value = goalData.reviews5Star || 0;

                const monthlyTarget = (goalData.weekdays * goalData.weekdayTarget) + (goalData.weekends * goalData.weekendTarget);
                document.getElementById('goal-monthly-target').value = monthlyTarget;

                // Update display fields
                document.getElementById('goal-weekday-target-display').innerText = `¥${fmt(goalData.weekdayTarget)}`;
                document.getElementById('goal-weekend-target-display').innerText = `¥${fmt(goalData.weekendTarget)}`;

                // Analyze past performance and display
                const performance = analyzeWeekdayWeekendPerformance();
                document.getElementById('goal-past-weekday-avg').innerText = `¥${fmt(performance.weekdayAvg)}`;
                document.getElementById('goal-past-weekend-avg').innerText = `¥${fmt(performance.weekendAvg)}`;
                document.getElementById('goal-past-ratio').innerText = `${performance.ratio}倍`;

                // Load base salary
                const baseSalary = getStaffBaseSalary(context.store, context.staff);
                document.getElementById('goal-base-salary').value = baseSalary;

                // Enable inputs
                const inputs = document.querySelectorAll('#content-goal input');
                inputs.forEach(input => input.disabled = false);
                hintText.innerHTML = '各項目の目標を設定すると<strong>自動保存</strong>されます。スタッフダッシュボードに反映されます。店舗合計は所属スタッフの目標の<strong>合算値</strong>となります。';
            } else {
                // 店舗または全店舗表示: 入力フィールドを非表示、サマリーを表示
                inputColumn1.classList.add('hidden');
                inputColumn2.classList.add('hidden');
                storeSummary.classList.remove('hidden');

                // サマリーの表示内容を更新
                const monthlyTarget = goalData.monthlyTargetSum || 0;
                document.getElementById('summary-monthly-target').innerText = `¥${fmt(monthlyTarget)}`;
                document.getElementById('summary-retail').innerText = `¥${fmt(goalData.retail)}`;
                document.getElementById('summary-new-customers').innerText = `${goalData.newCustomers}名`;
                document.getElementById('summary-existing-customers').innerText = `${goalData.existingCustomers}名`;
                document.getElementById('summary-unit-price').innerText = `¥${fmt(goalData.unitPrice)}`;
                document.getElementById('summary-reservation-rate').innerText = `${goalData.reservationRate}%`;

                // タイトルと説明を更新
                const titleEl = document.getElementById('goal-summary-title');
                const descEl = document.getElementById('goal-summary-description');
                if (context.type === 'store') {
                    const storeName = context.store === 'ebisu' ? '恵比寿駅前店' : context.store === 'kadomori' ? '大阪KADOMORI店' : context.store === 'fukushima' ? '福島店' : context.store;
                    titleEl.innerText = `${storeName} 目標サマリー`;
                    descEl.innerText = 'この目標は所属スタッフの目標の合算値です。個別のスタッフを選択すると、個人目標を編集できます。';
                } else {
                    titleEl.innerText = '全店舗 目標サマリー';
                    descEl.innerText = 'この目標は全スタッフの目標の合算値です。個別のスタッフを選択すると、個人目標を編集できます。';
                }

                // スタッフ別内訳を表示
                updateGoalStaffBreakdown(context, yearMonth);

                if (context.type === 'store') {
                    hintText.innerHTML = '<strong>店舗合計表示中</strong>: スタッフを選択すると個人目標を編集できます。';
                } else {
                    hintText.innerHTML = '<strong>全店舗表示中</strong>: スタッフを選択すると個人目標を編集できます。';
                }
            }

            calculateGoal();
        }

        // スタッフ別内訳テーブルを更新
        function updateGoalStaffBreakdown(context, yearMonth) {
            const tbody = document.getElementById('goal-staff-breakdown-body');
            if (!tbody) return;

            const fmt = n => n.toLocaleString();
            let rows = [];

            if (context.type === 'store') {
                // 特定店舗のスタッフ
                const staffList = STAFF_ROSTER[context.store] || [];
                staffList.forEach(staff => {
                    const staffGoal = getStaffGoal(context.store, staff, yearMonth);
                    const monthlyTarget = ((staffGoal.weekdays || 0) * (staffGoal.weekdayTarget || 0)) +
                                          ((staffGoal.weekends || 0) * (staffGoal.weekendTarget || 0));
                    rows.push({
                        name: staff,
                        store: context.store,
                        monthlyTarget,
                        retail: staffGoal.retail || 0,
                        newCustomers: staffGoal.newCustomers || 0,
                        existingCustomers: staffGoal.existingCustomers || 0
                    });
                });
            } else {
                // 全店舗のスタッフ
                Object.keys(STAFF_ROSTER).forEach(store => {
                    const staffList = STAFF_ROSTER[store] || [];
                    const storeName = store === 'ebisu' ? '恵比寿駅前店' : store === 'kadomori' ? '大阪KADOMORI店' : store === 'fukushima' ? '福島店' : store;
                    staffList.forEach(staff => {
                        const staffGoal = getStaffGoal(store, staff, yearMonth);
                        const monthlyTarget = ((staffGoal.weekdays || 0) * (staffGoal.weekdayTarget || 0)) +
                                              ((staffGoal.weekends || 0) * (staffGoal.weekendTarget || 0));
                        rows.push({
                            name: `${storeName} - ${staff}`,
                            store,
                            monthlyTarget,
                            retail: staffGoal.retail || 0,
                            newCustomers: staffGoal.newCustomers || 0,
                            existingCustomers: staffGoal.existingCustomers || 0
                        });
                    });
                });
            }

            tbody.innerHTML = rows.map(r => `
                <tr class="border-b border-sleepy-100 hover:bg-sleepy-50">
                    <td class="py-2 px-3 text-sleepy-800 font-medium">${r.name}</td>
                    <td class="py-2 px-3 text-right text-sleepy-700">¥${fmt(r.monthlyTarget)}</td>
                    <td class="py-2 px-3 text-right text-sleepy-600">¥${fmt(r.retail)}</td>
                    <td class="py-2 px-3 text-right text-sleepy-600">${r.newCustomers}名</td>
                    <td class="py-2 px-3 text-right text-sleepy-600">${r.existingCustomers}名</td>
                </tr>
            `).join('');
        }

        function saveBaseSalaryAndCalculate() {
            const context = getCurrentGoalContextForGoalTab();
            if (context.type === 'staff') {
                const baseSalary = parseInt(document.getElementById('goal-base-salary').value) || DEFAULT_BASE_SALARY;
                saveStaffBaseSalary(context.store, context.staff, baseSalary);
            }
            calculateGoal();
        }

        /**
         * 過去の実績データから平日・休日の売上傾向を分析
         */
        function analyzeWeekdayWeekendPerformance() {
            const filtered = getFilteredData();

            let weekdayTotal = 0, weekdayCount = 0;
            let weekendTotal = 0, weekendCount = 0;

            filtered.forEach(record => {
                // 日付を解析
                const dateParts = record.date.split('/');
                if (dateParts.length === 3) {
                    const year = parseInt(dateParts[0]);
                    const month = parseInt(dateParts[1]) - 1; // 月は0-indexed
                    const day = parseInt(dateParts[2]);
                    const date = new Date(year, month, day);
                    const dayOfWeek = date.getDay(); // 0=日, 1=月, ..., 6=土

                    const sales = record.sales.cash + record.sales.credit + record.sales.qr;

                    // 平日: 月〜金 (1-5), 休日: 土日 (0, 6)
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                        weekdayTotal += sales;
                        weekdayCount++;
                    } else {
                        weekendTotal += sales;
                        weekendCount++;
                    }
                }
            });

            const weekdayAvg = weekdayCount > 0 ? Math.round(weekdayTotal / weekdayCount) : 40000;
            const weekendAvg = weekendCount > 0 ? Math.round(weekendTotal / weekendCount) : 50000;
            const ratio = weekdayAvg > 0 ? (weekendAvg / weekdayAvg).toFixed(2) : 1.25;

            return {
                weekdayAvg,
                weekendAvg,
                ratio: parseFloat(ratio),
                weekdayCount,
                weekendCount
            };
        }

        /**
         * 月間目標金額から平日・休日のデイリー目標を自動計算
         */
        function calculateGoalFromMonthlyTarget() {
            const monthlyTarget = parseInt(document.getElementById('goal-monthly-target').value) || 0;
            const weekdays = parseInt(document.getElementById('goal-weekdays').value) || 0;
            const weekends = parseInt(document.getElementById('goal-weekends').value) || 0;

            // 過去の実績を分析
            const performance = analyzeWeekdayWeekendPerformance();

            // 過去の実績データを表示
            const fmt = n => n.toLocaleString();
            document.getElementById('goal-past-weekday-avg').innerText = `¥${fmt(performance.weekdayAvg)}`;
            document.getElementById('goal-past-weekend-avg').innerText = `¥${fmt(performance.weekendAvg)}`;
            document.getElementById('goal-past-ratio').innerText = `${performance.ratio}倍`;

            // 平日と休日の売上比率を使って月間目標を配分
            // 月間目標 = (平日日数 × 平日目標) + (休日日数 × 休日目標)
            // 休日目標 = 平日目標 × ratio
            // 月間目標 = (平日日数 × 平日目標) + (休日日数 × 平日目標 × ratio)
            // 月間目標 = 平日目標 × (平日日数 + 休日日数 × ratio)
            // 平日目標 = 月間目標 / (平日日数 + 休日日数 × ratio)

            const totalDays = weekdays + weekends;
            if (totalDays === 0) {
                alert('平日または休日の出勤日数を入力してください');
                return;
            }

            const weekdayTarget = Math.round(monthlyTarget / (weekdays + weekends * performance.ratio));
            const weekendTarget = Math.round(weekdayTarget * performance.ratio);

            // hiddenフィールドに値を設定
            document.getElementById('goal-weekday-target').value = weekdayTarget;
            document.getElementById('goal-weekend-target').value = weekendTarget;

            // 表示用フィールドに値を設定
            document.getElementById('goal-weekday-target-display').innerText = `¥${fmt(weekdayTarget)}`;
            document.getElementById('goal-weekend-target-display').innerText = `¥${fmt(weekendTarget)}`;

            // 元のcalculateGoal関数を呼び出して目標を更新
            calculateGoal();
        }

        function calculateGoal() {
            const context = getCurrentGoalContextForGoalTab();
            const yearMonth = getCurrentGoalMonth();

            let weekdays, weekends, weekdayTarget, weekendTarget, retailTarget;
            let newCustomersTarget, existingCustomersTarget, unitPriceTarget;
            let newResRateTarget, resRateTarget, reviews5StarTarget;
            let totalGoal;

            if (context.type === 'staff') {
                // スタッフ個人: 入力フィールドから値を取得
                weekdays = parseInt(document.getElementById('goal-weekdays').value) || 0;
                weekends = parseInt(document.getElementById('goal-weekends').value) || 0;
                weekdayTarget = parseInt(document.getElementById('goal-weekday-target').value) || 0;
                weekendTarget = parseInt(document.getElementById('goal-weekend-target').value) || 0;
                retailTarget = parseInt(document.getElementById('goal-retail').value) || 0;
                newCustomersTarget = parseInt(document.getElementById('goal-new-customers').value) || 0;
                existingCustomersTarget = parseInt(document.getElementById('goal-existing-customers').value) || 0;
                unitPriceTarget = parseInt(document.getElementById('goal-unit-price').value) || 0;
                newResRateTarget = parseInt(document.getElementById('goal-new-reservation-rate').value) || 0;
                resRateTarget = parseInt(document.getElementById('goal-reservation-rate').value) || 0;
                reviews5StarTarget = parseInt(document.getElementById('goal-reviews-5star').value) || 0;

                totalGoal = (weekdays * weekdayTarget) + (weekends * weekendTarget);

                // 目標を保存
                const goalData = {
                    weekdays, weekends, weekdayTarget, weekendTarget,
                    retail: retailTarget,
                    newCustomers: newCustomersTarget,
                    existingCustomers: existingCustomersTarget,
                    unitPrice: unitPriceTarget,
                    newReservationRate: newResRateTarget,
                    reservationRate: resRateTarget,
                    reviews5Star: reviews5StarTarget
                };
                saveStaffGoal(context.store, context.staff, goalData);

                // Show save notice briefly
                const saveNotice = document.getElementById('goal-save-notice');
                saveNotice.style.display = 'block';
                setTimeout(() => {
                    saveNotice.style.display = 'none';
                }, 2000);
            } else {
                // 店舗または全店舗: 集計データから値を取得
                let goalData;
                if (context.type === 'store') {
                    goalData = getStoreAggregateGoal(context.store, yearMonth);
                } else {
                    goalData = getAllStoresAggregateGoal(yearMonth);
                }

                weekdays = goalData.weekdays;
                weekends = goalData.weekends;
                weekdayTarget = goalData.weekdayTarget;
                weekendTarget = goalData.weekendTarget;
                retailTarget = goalData.retail;
                newCustomersTarget = goalData.newCustomers;
                existingCustomersTarget = goalData.existingCustomers;
                unitPriceTarget = goalData.unitPrice;
                newResRateTarget = goalData.newReservationRate;
                resRateTarget = goalData.reservationRate;
                reviews5StarTarget = goalData.reviews5Star || 0;

                // 店舗/全店舗の場合は正確な合計を使用
                totalGoal = goalData.monthlyTargetSum || 0;
            }

            // Update global goal
            monthlyGoal = totalGoal;

            // Format numbers
            const fmt = n => n.toLocaleString();

            // Update display
            document.getElementById('goal-total').innerText = `¥${fmt(totalGoal)}`;
            const weekdayTotal = weekdays * weekdayTarget;
            const weekendTotal = weekends * weekendTarget;
            document.getElementById('goal-weekday-total').innerText = `¥${fmt(weekdayTotal)}`;
            document.getElementById('goal-weekend-total').innerText = `¥${fmt(weekendTotal)}`;
            document.getElementById('goal-retail-display').innerText = `¥${fmt(retailTarget)}`;

            // Update display fields for daily targets (only for staff view)
            if (context.type === 'staff') {
                document.getElementById('goal-weekday-target-display').innerText = `¥${fmt(weekdayTarget)}`;
                document.getElementById('goal-weekend-target-display').innerText = `¥${fmt(weekendTarget)}`;
            }

            // Get current metrics
            const filtered = getFilteredData();
            const metrics = calculateMetrics(filtered);

            // Update achievement status - Sales
            const currentSales = metrics.salesTotal;
            const percentage = totalGoal > 0 ? Math.round((currentSales / totalGoal) * 100) : 0;
            const remaining = totalGoal - currentSales;
            const progressWidth = Math.min(percentage, 100);

            document.getElementById('goal-current-sales').innerText = `¥${fmt(currentSales)}`;
            document.getElementById('goal-percentage').innerText = `${percentage}%`;
            document.getElementById('goal-remaining').innerText = `¥${fmt(Math.max(remaining, 0))}`;
            document.getElementById('goal-progress-bar').style.width = `${progressWidth}%`;

            // Update achievement status - Customers & KPIs
            document.getElementById('goal-new-current').innerText = `${fmt(metrics.customersNew)}名`;
            document.getElementById('goal-new-target').innerText = `${fmt(newCustomersTarget)}名`;

            document.getElementById('goal-existing-current').innerText = `${fmt(metrics.customersExisting)}名`;
            document.getElementById('goal-existing-target').innerText = `${fmt(existingCustomersTarget)}名`;

            const currentUnitPrice = metrics.customersTotal > 0 ? Math.round(metrics.salesTotal / metrics.customersTotal) : 0;
            document.getElementById('goal-unit-price-current').innerText = `¥${fmt(currentUnitPrice)}`;
            document.getElementById('goal-unit-price-target').innerText = `¥${fmt(unitPriceTarget)}`;

            const currentNewResRate = metrics.hpbNewCount > 0 ? (((metrics.nextRes.hpbNew + metrics.nextRes.mininaiNew) / metrics.hpbNewCount)*100).toFixed(1) : 0;
            document.getElementById('goal-new-res-rate-current').innerText = `${currentNewResRate}%`;
            document.getElementById('goal-new-res-rate-target').innerText = `${newResRateTarget}%`;

            const currentResRate = metrics.customersTotal > 0 ? ((metrics.nextRes.total / metrics.customersTotal)*100).toFixed(1) : 0;
            document.getElementById('goal-res-rate-current').innerText = `${currentResRate}%`;
            document.getElementById('goal-res-rate-target').innerText = `${resRateTarget}%`;

            // Update main KPI card
            updateDashboard();
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`content-${id}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'text-accent-800');
                btn.classList.add('text-surface-500');
            });
            const active = document.getElementById(`tab-${id}`);
            active.classList.remove('text-surface-500');
            active.classList.add('active', 'text-accent-800');

            // Load goal when switching to goal tab
            if (id === 'goal') {
                // Initialize month selector for goal tab
                initGoalMonthSelector();
                // Initialize goal selectors from main selectors
                const mainStore = document.getElementById('store-selector').value;
                const mainStaff = document.getElementById('staff-selector').value;
                document.getElementById('goal-store-selector').value = mainStore;
                handleGoalStoreChange();
                // Try to set staff selector if available
                const goalStaffSel = document.getElementById('goal-staff-selector');
                const matchingOption = Array.from(goalStaffSel.options).find(opt => opt.value === mainStaff);
                if (matchingOption) {
                    goalStaffSel.value = mainStaff;
                }
                loadGoalInputs();
            }

            // Update settings list when switching to settings tab
            if (id === 'settings') {
                updateSettingsList();
                loadGeminiApiKey(); // Load API key
                loadSpreadsheetApiUrl(); // Load spreadsheet API URL
                loadCustomerApiUrl(); // Load customer API URL
                // Re-render Lucide icons for settings tab
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            // Render calendar when switching to calendar tab
            if (id === 'calendar') {
                renderCalendar();
            }

            // Load marketing data when switching to marketing tab
            if (id === 'marketing') {
                if (customerData.length === 0) {
                    refreshCustomerData();
                } else {
                    updateMarketingDashboard();
                }
            }

            // Load membership data when switching to membership tab
            if (id === 'membership') {
                renderSubscriptionDashboard();
                renderTicketDashboard();
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            // Load counseling results when switching to staff-dashboard or counseling-results tab
            if (id === 'staff-dashboard' || id === 'counseling-results') {
                if (customerData.length === 0) {
                    refreshCounselingResults();
                } else {
                    renderCounselingResults();
                }
            }

            // Load counseling results when switching to marketing tab
            if (id === 'marketing') {
                if (counselingData.length === 0) {
                    // 当日分を先に読み込んで高速表示
                    loadCustomerDataFast().then(() => {
                        renderAdminCounselingResults();
                    });
                } else {
                    renderAdminCounselingResults();
                }
            }
        }

        function generateStaffURL() {
            const storeVal = document.getElementById('store-selector').value;
            const staffVal = document.getElementById('staff-selector').value;

            if (staffVal === 'all') {
                alert('スタッフを選択してください');
                return;
            }

            const baseURL = window.location.origin + window.location.pathname;
            // パラメータを小文字に正規化
            const staffURL = `${baseURL}?store=${storeVal.toLowerCase()}&staff=${staffVal.toLowerCase()}`;

            // 別タブで開く
            window.open(staffURL, '_blank');
        }

        // --- COUNSELING DATA FUNCTIONS ---
        let counselingData = [];

        async function refreshCounselingData() {
            const loaded = await loadCustomerDataForCounseling();
            if (loaded) {
                filterCounselingData();
            }
        }

        async function loadCustomerDataForCounseling(todayOnly = false) {
            CUSTOMER_API_URL = localStorage.getItem(CUSTOMER_API_KEY) || '';
            if (!CUSTOMER_API_URL) {
                return false;
            }
            try {
                let action, url;

                // スタッフ専用URL時は店舗別取得（超高速：30秒キャッシュ）
                if (lockedStore) {
                    action = 'get_customers_by_store';
                    url = CUSTOMER_API_URL.includes('?')
                        ? `${CUSTOMER_API_URL}&action=${action}&store=${lockedStore}`
                        : `${CUSTOMER_API_URL}?action=${action}&store=${lockedStore}`;
                } else {
                    // 当日分のみの場合は専用エンドポイント使用（高速）
                    action = todayOnly ? 'get_customers_today' : 'get_customers';
                    url = CUSTOMER_API_URL.includes('?')
                        ? `${CUSTOMER_API_URL}&action=${action}`
                        : `${CUSTOMER_API_URL}?action=${action}`;
                }

                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                const result = await response.json();
                if (result.status === 'success' && result.data) {
                    if (todayOnly && !lockedStore) {
                        // 当日分のみの場合は既存データとマージ
                        const existingData = counselingData || [];
                        const todayData = result.data;
                        const todayIds = new Set(todayData.map(d => d.id));
                        const otherData = existingData.filter(d => !todayIds.has(d.id));
                        counselingData = [...todayData, ...otherData];
                    } else {
                        counselingData = result.data;
                    }
                } else if (Array.isArray(result)) {
                    counselingData = result;
                } else {
                    counselingData = [];
                }
                return true;
            } catch (e) {
                console.error('顧客データの取得に失敗:', e);
                return false;
            }
        }

        // 当日分を先に読み込み、その後全データを読み込む（高速表示）
        async function loadCustomerDataFast() {
            // まず当日分を高速表示
            const todayLoaded = await loadCustomerDataForCounseling(true);
            if (todayLoaded) {
                filterCounselingData();
            }
            // バックグラウンドで全データを読み込み
            setTimeout(async () => {
                await loadCustomerDataForCounseling(false);
                filterCounselingData();
            }, 100);
            return todayLoaded;
        }

        function filterCounselingData() {
            const container = document.getElementById('counseling-cards-container');
            if (!container) return;

            const filterVal = document.getElementById('counseling-filter')?.value || 'today';
            const searchVal = document.getElementById('counseling-search')?.value?.toLowerCase() || '';

            // スタッフ専用ページの場合、そのスタッフのデータのみ表示
            const storeFilter = lockedStore || document.getElementById('store-selector')?.value;
            const staffFilter = lockedStaff || document.getElementById('staff-selector')?.value;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;

            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);

            let filtered = counselingData.filter(c => {
                // 店舗フィルター
                if (storeFilter && storeFilter !== 'all' && c.store !== storeFilter) return false;
                // スタッフフィルター（担当スタッフがある場合）- 大文字小文字を区別しない
                if (staffFilter && staffFilter !== 'all' && c.staff && c.staff.toLowerCase() !== staffFilter.toLowerCase()) return false;
                // 検索フィルター
                if (searchVal && !c.name?.toLowerCase().includes(searchVal)) return false;
                return true;
            });

            // 日付フィルター
            if (filterVal === 'today') {
                filtered = filtered.filter(c => {
                    if (!c.date) return false;
                    return c.date === todayStr || c.date.replace(/\//g, '/') === todayStr;
                });
            } else if (filterVal === 'week') {
                filtered = filtered.filter(c => {
                    if (!c.timestamp) return true;
                    return c.timestamp >= weekAgo.getTime();
                });
            } else if (filterVal === 'recent') {
                filtered = filtered.slice(-10).reverse();
            }

            // 新しい順にソート
            filtered.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-sleepy-500">
                        <i data-lucide="users" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                        <p class="text-sm">${filterVal === 'today' ? '今日の予約はありません' : '該当するお客様がいません'}</p>
                    </div>
                `;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            container.innerHTML = filtered.map(c => renderCounselingCard(c)).join('');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderCounselingCard(customer) {
            const hasAllergy = customer.allergy && customer.allergy.trim() !== '';
            const hasEyebrowTrouble = customer.eyebrowTrouble && customer.eyebrowTrouble.trim() !== '' && !customer.eyebrowTrouble.includes('特になし');
            const hasLashTrouble = customer.lashTrouble && customer.lashTrouble.trim() !== '' && !customer.lashTrouble.includes('特になし');
            const hasWarning = hasAllergy || hasEyebrowTrouble || hasLashTrouble;
            const alertClass = hasWarning ? 'border-l-4 border-red-400' : '';

            // 眉毛メニュー情報があるかチェック
            const hasEyebrowInfo = customer.eyebrowConcern || customer.eyebrowDesign || customer.eyebrowFrequency || customer.eyebrowImpression;
            // まつ毛メニュー情報があるかチェック
            const hasLashInfo = customer.lashDesign || customer.lashFrequency || customer.lashEyeLook || customer.lashContact;

            return `
                <div class="bg-gradient-to-r from-white to-sleepy-50 rounded-lg border border-sleepy-200 p-4 ${alertClass} hover:shadow-md transition">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <h4 class="font-bold text-sleepy-800 text-lg">${customer.name || '名前未登録'}</h4>
                            ${customer.nameKana ? `<p class="text-xs text-sleepy-400">${customer.nameKana}</p>` : ''}
                            <p class="text-xs text-sleepy-500">${customer.date || ''} ${customer.storeName || ''}</p>
                        </div>
                        <div class="flex gap-1 flex-wrap justify-end">
                            ${hasAllergy ? '<span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded font-bold">アレルギー</span>' : ''}
                            ${hasEyebrowTrouble ? '<span class="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded font-bold">眉肌トラブル</span>' : ''}
                            ${hasLashTrouble ? '<span class="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded font-bold">まつ毛肌トラブル</span>' : ''}
                            ${customer.snsOk && customer.snsOk.includes('OK') ? '<span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded font-bold">SNS OK</span>' : ''}
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm mb-3">
                        ${customer.birthday ? `<div><span class="text-sleepy-500">生年月日:</span> <span class="font-medium">${customer.birthday}</span></div>` : ''}
                        ${customer.phone ? `<div><span class="text-sleepy-500">電話:</span> <span class="font-medium">${customer.phone}</span></div>` : ''}
                        ${customer.address ? `<div class="col-span-2"><span class="text-sleepy-500">住所:</span> <span class="font-medium">${customer.address}</span></div>` : ''}
                        ${customer.job ? `<div><span class="text-sleepy-500">職業:</span> <span class="font-medium">${customer.job}</span></div>` : ''}
                    </div>

                    ${hasEyebrowInfo ? `
                    <div class="bg-amber-50 rounded p-3 mb-3">
                        <p class="text-xs font-bold text-amber-700 mb-2">🪶 眉毛メニュー情報</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                            ${customer.eyebrowConcern ? `<div><span class="text-sleepy-500">お悩み:</span> <span class="text-sleepy-800">${customer.eyebrowConcern}</span></div>` : ''}
                            ${customer.eyebrowDesign ? `<div><span class="text-sleepy-500">ご希望デザイン:</span> <span class="text-sleepy-800">${customer.eyebrowDesign}</span></div>` : ''}
                            ${customer.eyebrowImpression ? `<div><span class="text-sleepy-500">印象:</span> <span class="text-sleepy-800">${customer.eyebrowImpression}</span></div>` : ''}
                            ${customer.eyebrowFrequency ? `<div><span class="text-sleepy-500">利用頻度:</span> <span class="text-sleepy-800">${customer.eyebrowFrequency}</span></div>` : ''}
                            ${customer.eyebrowLastCare ? `<div class="col-span-2"><span class="text-sleepy-500">最後のお手入れ:</span> <span class="text-sleepy-800">${customer.eyebrowLastCare}</span></div>` : ''}
                        </div>
                    </div>
                    ` : ''}

                    ${hasLashInfo ? `
                    <div class="bg-purple-50 rounded p-3 mb-3">
                        <p class="text-xs font-bold text-purple-700 mb-2">👁️ まつ毛メニュー情報</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                            ${customer.lashDesign ? `<div><span class="text-sleepy-500">ご希望デザイン:</span> <span class="text-sleepy-800">${customer.lashDesign}</span></div>` : ''}
                            ${customer.lashFrequency ? `<div><span class="text-sleepy-500">利用頻度:</span> <span class="text-sleepy-800">${customer.lashFrequency}</span></div>` : ''}
                            ${customer.lashEyeLook ? `<div><span class="text-sleepy-500">目の見え方:</span> <span class="text-sleepy-800">${customer.lashEyeLook}</span></div>` : ''}
                            ${customer.lashContact ? `<div><span class="text-sleepy-500">コンタクト:</span> <span class="text-sleepy-800">${customer.lashContact}</span></div>` : ''}
                        </div>
                    </div>
                    ` : ''}

                    ${hasWarning ? `
                    <div class="bg-red-50 rounded p-3 mb-3 border border-red-200">
                        <p class="text-xs font-bold text-red-700 mb-2">⚠️ 注意事項</p>
                        <div class="text-sm space-y-1">
                            ${hasAllergy ? `<div><span class="text-red-600 font-medium">アレルギー:</span> <span class="text-red-800">${customer.allergy}</span></div>` : ''}
                            ${hasEyebrowTrouble ? `<div><span class="text-orange-600 font-medium">眉施術後トラブル:</span> <span class="text-orange-800">${customer.eyebrowTrouble}</span></div>` : ''}
                            ${hasLashTrouble ? `<div><span class="text-orange-600 font-medium">まつ毛施術後トラブル:</span> <span class="text-orange-800">${customer.lashTrouble}</span></div>` : ''}
                        </div>
                    </div>
                    ` : ''}

                    ${customer.visitReason ? `
                    <div class="bg-blue-50 rounded p-3 text-sm mb-3">
                        <span class="text-blue-600 font-medium">来店理由:</span> <span class="text-blue-800">${customer.visitReason}</span>
                        ${customer.fromOtherSalon ? `<div class="mt-1"><span class="text-blue-600 font-medium">他サロンからの理由:</span> <span class="text-blue-800">${customer.fromOtherSalon}</span></div>` : ''}
                        ${customer.dissatisfaction ? `<div class="mt-1"><span class="text-blue-600 font-medium">不満理由:</span> <span class="text-blue-800">${customer.dissatisfaction}</span></div>` : ''}
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // スタッフダッシュボード更新時にカウンセリングデータも読み込む
        function loadCounselingForStaffDashboard() {
            if (lockedStaff || document.getElementById('staff-selector')?.value !== 'all') {
                // 当日分を先に読み込んで高速表示
                loadCustomerDataFast();
            }
        }

        // 管理ページ用カウンセリング表示関数
        async function refreshAdminCounselingResults() {
            const loaded = await loadCustomerDataForCounseling();
            if (loaded) {
                renderAdminCounselingResults();
                showUpdateNotification('カウンセリング回答を更新しました');
            }
        }

        function renderAdminCounselingResults() {
            const container = document.getElementById('admin-counseling-container');
            if (!container) return;

            if (!counselingData || counselingData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-sleepy-400">
                        <i data-lucide="clipboard-list" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                        <p class="text-sm">顧客データがありません</p>
                    </div>
                `;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            const storeFilter = document.getElementById('admin-counseling-store-filter')?.value || 'all';
            const searchTerm = document.getElementById('admin-counseling-search')?.value?.toLowerCase() || '';
            const dateFilter = document.getElementById('admin-counseling-date-filter')?.value || 'month';

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

            let filtered = counselingData.filter(c => {
                // 店舗フィルター
                if (storeFilter !== 'all' && c.store !== storeFilter) return false;

                // 検索フィルター
                if (searchTerm && !c.name?.toLowerCase().includes(searchTerm)) return false;

                // 日付フィルター
                if (dateFilter !== 'all' && c.timestamp) {
                    const recordDate = new Date(c.timestamp);
                    if (dateFilter === 'week' && recordDate < weekAgo) return false;
                    if (dateFilter === 'month' && recordDate < monthStart) return false;
                }

                return true;
            });

            // 新しい順にソート
            filtered.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            // 件数表示
            document.getElementById('admin-counseling-count').textContent = filtered.length;

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-sleepy-400">
                        <i data-lucide="search-x" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                        <p class="text-sm">該当する回答がありません</p>
                    </div>
                `;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            container.innerHTML = filtered.map(c => renderCounselingCard(c)).join('');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- STAFF & STORE MANAGEMENT ---
        function updateSettingsList() {
            // Update store list
            const storeList = document.getElementById('store-list');
            storeList.innerHTML = '';
            Object.keys(STAFF_ROSTER).forEach(storeId => {
                const storeDiv = document.createElement('div');
                storeDiv.className = 'flex items-center justify-between bg-sleepy-50 p-3 rounded';
                storeDiv.innerHTML = `
                    <span class="font-medium">${storeId}</span>
                    <button onclick="deleteStore('${storeId}')" class="text-red-600 hover:text-red-800 text-sm font-bold">削除</button>
                `;
                storeList.appendChild(storeDiv);
            });

            // Update staff list
            const staffList = document.getElementById('staff-list');
            staffList.innerHTML = '';
            const baseUrl = window.location.origin + window.location.pathname;
            Object.keys(STAFF_ROSTER).forEach(storeId => {
                const storeName = storeId === 'ebisu' ? '恵比寿駅前店' : storeId === 'kadomori' ? '大阪KADOMORI店' : storeId === 'fukushima' ? '福島店' : storeId;
                STAFF_ROSTER[storeId].forEach(staffName => {
                    const staffDiv = document.createElement('div');
                    staffDiv.className = 'bg-sleepy-50 p-3 rounded';
                    staffDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-sleepy-800"><strong>${storeName}</strong>: ${staffName}</span>
                                <button onclick="openStaffUrl('${storeId}', '${staffName}')" class="bg-primary-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-primary-600 transition flex items-center gap-1">
                                    <i data-lucide="external-link" class="w-3 h-3"></i>
                                    専用ページ
                                </button>
                            </div>
                            <button onclick="deleteStaff('${storeId}', '${staffName}')" class="text-red-600 hover:text-red-800 text-sm font-bold">削除</button>
                        </div>
                    `;
                    staffList.appendChild(staffDiv);
                });
            });

            // Lucide iconsを更新
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Update staff store selector
            const staffStoreSel = document.getElementById('staff-store-selector');
            staffStoreSel.innerHTML = '<option value="">店舗を選択</option>';
            Object.keys(STAFF_ROSTER).forEach(storeId => {
                const opt = document.createElement('option');
                opt.value = storeId;
                opt.text = storeId;
                staffStoreSel.appendChild(opt);
            });

            // Update password settings UI
            initPasswordSettingsUI();
        }

        function addStore() {
            const storeId = document.getElementById('new-store-id').value.trim();
            const storeName = document.getElementById('new-store-name').value.trim();

            if (!storeId) {
                alert('店舗IDを入力してください');
                return;
            }

            if (STAFF_ROSTER[storeId]) {
                alert('この店舗IDは既に存在します');
                return;
            }

            // Confirmation dialog
            if (!confirm(`店舗「${storeId}」を追加してよろしいですか？\n\n店舗ID: ${storeId}\n店舗名: ${storeName || '(未設定)'}\n\nこの操作は取り消せませんので、内容をご確認ください。`)) {
                return;
            }

            STAFF_ROSTER[storeId] = [];
            document.getElementById('new-store-id').value = '';
            document.getElementById('new-store-name').value = '';

            updateSettingsList();
            saveSettingsToSpreadsheet(); // スプレッドシートに保存
            alert(`店舗「${storeId}」を追加しました`);
        }

        function deleteStore(storeId) {
            if (!confirm(`店舗「${storeId}」を削除しますか？関連するスタッフと目標データも削除されます。`)) {
                return;
            }

            delete STAFF_ROSTER[storeId];

            // Delete related goal data
            const goals = loadGoalsFromStorage();
            if (goals[storeId]) {
                delete goals[storeId];
                saveGoalsToStorage(goals);
            }

            // Delete related salary data
            const salaries = loadBaseSalariesFromStorage();
            if (salaries[storeId]) {
                delete salaries[storeId];
                saveBaseSalariesToStorage(salaries);
            }

            updateSettingsList();
            saveSettingsToSpreadsheet(); // スプレッドシートに保存
            alert(`店舗「${storeId}」を削除しました`);
        }

        function addStaff() {
            const storeId = document.getElementById('staff-store-selector').value;
            const staffName = document.getElementById('new-staff-name').value.trim();

            if (!storeId) {
                alert('店舗を選択してください');
                return;
            }

            if (!staffName) {
                alert('スタッフ名を入力してください');
                return;
            }

            if (!STAFF_ROSTER[storeId]) {
                alert('選択された店舗が存在しません');
                return;
            }

            // 大文字小文字を区別しないで重複チェック
            if (STAFF_ROSTER[storeId].some(s => s.toLowerCase() === staffName.toLowerCase())) {
                alert('このスタッフは既に存在します');
                return;
            }

            // Confirmation dialog
            if (!confirm(`スタッフ「${staffName}」を${storeId}に追加してよろしいですか？\n\nスタッフ名: ${staffName}\n店舗: ${storeId}\n\nこの操作は取り消せませんので、内容をご確認ください。`)) {
                return;
            }

            STAFF_ROSTER[storeId].push(staffName);
            document.getElementById('new-staff-name').value = '';

            updateSettingsList();
            saveSettingsToSpreadsheet(); // スプレッドシートに保存
            alert(`スタッフ「${staffName}」を${storeId}に追加しました`);
        }

        function deleteStaff(storeId, staffName) {
            if (!confirm(`スタッフ「${staffName}」を削除しますか？関連する目標データも削除されます。`)) {
                return;
            }

            const index = STAFF_ROSTER[storeId].indexOf(staffName);
            if (index > -1) {
                STAFF_ROSTER[storeId].splice(index, 1);
            }

            // Delete related goal data
            const goals = loadGoalsFromStorage();
            if (goals[storeId] && goals[storeId][staffName]) {
                delete goals[storeId][staffName];
                saveGoalsToStorage(goals);
            }

            // Delete related salary data
            const salaries = loadBaseSalariesFromStorage();
            if (salaries[storeId] && salaries[storeId][staffName]) {
                delete salaries[storeId][staffName];
                saveBaseSalariesToStorage(salaries);
            }

            updateSettingsList();
            saveSettingsToSpreadsheet(); // スプレッドシートに保存
            alert(`スタッフ「${staffName}」を削除しました`);
        }

        // スタッフ専用URLを別タブで開く
        function openStaffUrl(storeId, staffName) {
            const baseURL = window.location.origin + window.location.pathname;
            // パラメータを小文字に正規化
            const staffURL = `${baseURL}?store=${storeId.toLowerCase()}&staff=${staffName.toLowerCase()}`;
            window.open(staffURL, '_blank');
        }

        // --- STAFF PASSWORD MANAGEMENT FUNCTIONS ---
        function updatePasswordStaffSelector() {
            const storeSel = document.getElementById('password-store-selector');
            const staffSel = document.getElementById('password-staff-selector');
            const selectedStore = storeSel.value;

            staffSel.innerHTML = '<option value="">スタッフを選択</option>';

            if (selectedStore && STAFF_ROSTER[selectedStore]) {
                STAFF_ROSTER[selectedStore].forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.text = name;
                    staffSel.appendChild(opt);
                });
            }
        }

        function saveStaffPasswordSettings() {
            const storeId = document.getElementById('password-store-selector').value;
            const staffName = document.getElementById('password-staff-selector').value;
            const password = document.getElementById('staff-password-input').value;
            const statusEl = document.getElementById('staff-password-status');

            if (!storeId) {
                alert('店舗を選択してください');
                return;
            }

            if (!staffName) {
                alert('スタッフを選択してください');
                return;
            }

            setStaffPassword(storeId, staffName, password);

            // ステータス表示
            statusEl.classList.remove('hidden');
            if (password) {
                statusEl.innerHTML = '<p class="text-green-600 text-sm">✓ パスワードを設定しました</p>';
            } else {
                statusEl.innerHTML = '<p class="text-yellow-600 text-sm">✓ パスワードを無効化しました（ログイン不要）</p>';
            }

            // 入力をクリア
            document.getElementById('staff-password-input').value = '';

            // パスワード設定リストを更新
            updatePasswordList();

            // 3秒後にステータスを非表示
            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 3000);
        }

        function updatePasswordList() {
            const listContainer = document.getElementById('staff-password-list');
            if (!listContainer) return;

            const passwords = staffPasswordsCache || loadStaffPasswordsFromLocalStorage();
            let html = '';

            Object.keys(STAFF_ROSTER).forEach(storeId => {
                const storeName = storeId === 'ebisu' ? '恵比寿駅前店' : storeId === 'kadomori' ? '大阪KADOMORI店' : storeId === 'fukushima' ? '福島店' : storeId;
                const staffList = STAFF_ROSTER[storeId];

                staffList.forEach(staff => {
                    const hasPassword = passwords[storeId] && passwords[storeId][staff] && passwords[storeId][staff] !== '';
                    const statusClass = hasPassword ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-500';
                    const statusText = hasPassword ? '設定済み' : '未設定';
                    const lockIcon = hasPassword ? 'lock' : 'unlock';

                    html += `
                        <div class="flex items-center justify-between p-2 rounded ${hasPassword ? 'bg-green-50' : 'bg-gray-50'} border border-${hasPassword ? 'green' : 'gray'}-200">
                            <div class="flex items-center gap-2">
                                <i data-lucide="${lockIcon}" class="w-4 h-4 ${hasPassword ? 'text-green-600' : 'text-gray-400'}"></i>
                                <span class="text-sm font-medium text-sleepy-800">${storeName} / ${staff}</span>
                            </div>
                            <span class="text-xs px-2 py-1 rounded ${statusClass}">${statusText}</span>
                        </div>
                    `;
                });
            });

            listContainer.innerHTML = html || '<p class="text-sm text-sleepy-500">スタッフが登録されていません</p>';

            // Lucide iconsを更新
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function initPasswordSettingsUI() {
            const storeSel = document.getElementById('password-store-selector');
            if (!storeSel) return;

            // 店舗セレクタを初期化
            storeSel.innerHTML = '<option value="">店舗を選択</option>';
            Object.keys(STAFF_ROSTER).forEach(storeId => {
                const storeName = storeId === 'ebisu' ? '恵比寿駅前店' : storeId === 'kadomori' ? '大阪KADOMORI店' : storeId === 'fukushima' ? '福島店' : storeId;
                const opt = document.createElement('option');
                opt.value = storeId;
                opt.text = storeName;
                storeSel.appendChild(opt);
            });

            // パスワード設定リストを更新
            updatePasswordList();
        }

        // 管理ページパスワードを保存
        async function saveAdminPassword() {
            const password = document.getElementById('admin-password-input').value;
            const statusEl = document.getElementById('admin-password-status');
            const apiUrl = document.getElementById('spreadsheet-api-url')?.value;

            if (!apiUrl) {
                alert('先にスプレッドシートAPIのURLを設定してください');
                return;
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'save_settings',
                        settings: {
                            adminPassword: password
                        }
                    })
                });

                const result = await response.json();

                // ステータス表示
                statusEl.classList.remove('hidden');
                if (result.status === 'success') {
                    if (password) {
                        statusEl.innerHTML = '<p class="text-green-600 text-sm font-bold">✓ 管理パスワードを設定しました</p>';
                    } else {
                        statusEl.innerHTML = '<p class="text-yellow-600 text-sm font-bold">✓ 管理パスワードを無効化しました（ログイン不要）</p>';
                    }
                } else {
                    statusEl.innerHTML = '<p class="text-red-600 text-sm font-bold">✗ 保存に失敗しました</p>';
                }

                // 入力をクリア
                document.getElementById('admin-password-input').value = '';

                // 3秒後にステータスを非表示
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 3000);
            } catch (error) {
                console.error('管理パスワード保存エラー:', error);
                statusEl.classList.remove('hidden');
                statusEl.innerHTML = '<p class="text-red-600 text-sm font-bold">✗ 保存に失敗しました</p>';
            }
        }

        // --- PASSWORD AUTHENTICATION FUNCTIONS ---
        const SESSION_TOKEN_KEY = 'sleepy_session_token';
        const SESSION_PAGE_TYPE_KEY = 'sleepy_session_page_type';
        let authenticationRequired = false;
        let authPageType = '';
        let authStore = '';
        let authStaff = '';

        // パスワードダイアログを表示
        function showPasswordDialog(pageType, store = '', staff = '') {
            authPageType = pageType;
            authStore = store;
            authStaff = staff;

            const dialog = document.getElementById('password-dialog');
            const title = document.getElementById('password-dialog-title');
            const message = document.getElementById('password-dialog-message');

            if (pageType === 'admin') {
                title.textContent = '管理ページ認証';
                message.textContent = '管理ページへのアクセスにはパスワードが必要です';
            } else {
                title.textContent = 'スタッフページ認証';
                message.textContent = `${store === 'ebisu' ? '恵比寿駅前店' : store === 'kadomori' ? '大阪KADOMORI店' : store === 'fukushima' ? '福島店' : store} / ${staff} のページへのアクセスにはパスワードが必要です`;
            }

            dialog.classList.remove('hidden');
            document.getElementById('password-dialog-input').focus();

            // Lucide iconsを更新
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // パスワード送信処理
        async function handlePasswordSubmit() {
            const password = document.getElementById('password-dialog-input').value;
            const errorEl = document.getElementById('password-error');
            const apiUrl = localStorage.getItem(SPREADSHEET_API_KEY);

            if (!password) {
                errorEl.textContent = 'パスワードを入力してください';
                errorEl.classList.remove('hidden');
                return;
            }

            if (!apiUrl) {
                errorEl.textContent = 'APIが設定されていません';
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch(`${apiUrl}?action=verify_password&page_type=${authPageType}&store=${authStore}&staff=${authStaff}&password=${encodeURIComponent(password)}`);
                const result = await response.json();

                if (result.status === 'success') {
                    // セッショントークンを保存
                    localStorage.setItem(SESSION_TOKEN_KEY, result.sessionToken);
                    localStorage.setItem(SESSION_PAGE_TYPE_KEY, authPageType);

                    // ダイアログを閉じてページを初期化
                    document.getElementById('password-dialog').classList.add('hidden');
                    document.getElementById('password-dialog-input').value = '';
                    errorEl.classList.add('hidden');

                    // ページをリロード
                    location.reload();
                } else {
                    errorEl.textContent = result.message || 'パスワードが正しくありません';
                    errorEl.classList.remove('hidden');
                    document.getElementById('password-dialog-input').value = '';
                    document.getElementById('password-dialog-input').focus();
                }
            } catch (error) {
                console.error('認証エラー:', error);
                errorEl.textContent = '認証に失敗しました。ネットワーク接続を確認してください。';
                errorEl.classList.remove('hidden');
            }
        }

        // セッション検証（ページロード時）
        async function checkAuthentication() {
            const urlParams = new URLSearchParams(window.location.search);
            const store = urlParams.get('store');
            const staff = urlParams.get('staff');
            const apiUrl = localStorage.getItem(SPREADSHEET_API_KEY);

            if (!apiUrl) {
                // API未設定の場合は認証不要
                return true;
            }

            // 管理ページか確認（設定タブへのアクセス）
            const isAdminAccess = !store && !staff;

            // セッショントークンを取得
            const sessionToken = localStorage.getItem(SESSION_TOKEN_KEY);
            const sessionPageType = localStorage.getItem(SESSION_PAGE_TYPE_KEY);

            // セッショントークンがある場合は検証
            if (sessionToken && sessionPageType) {
                const pageType = isAdminAccess ? 'admin' : 'staff';
                if (sessionPageType === pageType) {
                    try {
                        const response = await fetch(`${apiUrl}?action=verify_session&session_token=${sessionToken}&page_type=${pageType}`);
                        const result = await response.json();

                        if (result.status === 'success') {
                            // セッション有効
                            return true;
                        }
                    } catch (error) {
                        console.error('セッション検証エラー:', error);
                    }
                }

                // セッション無効の場合はクリア
                localStorage.removeItem(SESSION_TOKEN_KEY);
                localStorage.removeItem(SESSION_PAGE_TYPE_KEY);
            }

            // パスワードが必要かチェック（GASから確認）
            try {
                // 空のパスワードで試行して、パスワード必要かどうか確認
                const response = await fetch(`${apiUrl}?action=verify_password&page_type=${isAdminAccess ? 'admin' : 'staff'}&store=${store || ''}&staff=${staff || ''}&password=`);
                const result = await response.json();

                if (result.status === 'success') {
                    // パスワード不要（空パスワードで成功）
                    localStorage.setItem(SESSION_TOKEN_KEY, result.sessionToken);
                    localStorage.setItem(SESSION_PAGE_TYPE_KEY, isAdminAccess ? 'admin' : 'staff');
                    return true;
                } else {
                    // パスワード必要
                    authenticationRequired = true;
                    showPasswordDialog(isAdminAccess ? 'admin' : 'staff', store || '', staff || '');
                    return false;
                }
            } catch (error) {
                console.error('認証チェックエラー:', error);
                // エラー時は認証不要として処理
                return true;
            }
        }

        // --- GEMINI API FUNCTIONS ---
        const GEMINI_API_KEY_STORAGE = 'sleepy_gemini_api_key';

        function saveGeminiApiKey() {
            const apiKey = document.getElementById('gemini-api-key').value.trim();
            if (!apiKey) {
                alert('APIキーを入力してください');
                return;
            }
            localStorage.setItem(GEMINI_API_KEY_STORAGE, apiKey);
            // スプレッドシートにも保存
            saveSettingsToSpreadsheet();
            alert('Gemini APIキーを保存しました');
        }

        function loadGeminiApiKey() {
            const apiKey = localStorage.getItem(GEMINI_API_KEY_STORAGE);
            if (apiKey) {
                const input = document.getElementById('gemini-api-key');
                if (input) input.value = apiKey;
            }
            return apiKey;
        }

        async function getAIAdvice() {
            const apiKey = loadGeminiApiKey();
            if (!apiKey) {
                alert('先に設定タブでGemini APIキーを登録してください');
                return;
            }

            const btn = document.getElementById('btn-ai-advice');
            const originalText = btn.innerHTML;
            btn.innerHTML = '分析中...';
            btn.disabled = true;

            try {
                // Get current metrics and goals
                const filtered = getFilteredData();
                const metrics = calculateMetrics(filtered);
                const context = getCurrentGoalContext();

                let goalData;
                if (context.type === 'staff') {
                    goalData = getStaffGoal(context.store, context.staff);
                } else if (context.type === 'store') {
                    goalData = getStoreAggregateGoal(context.store);
                } else {
                    goalData = getAllStoresAggregateGoal();
                }

                const salesGoal = goalData.weekdays * goalData.weekdayTarget + goalData.weekends * goalData.weekendTarget;
                const currentSales = metrics.salesTotal;
                const goalAchievementRate = salesGoal > 0 ? ((currentSales / salesGoal) * 100).toFixed(1) : 0;

                // Prepare prompt for Gemini
                const prompt = `あなたは睡眠整体サロンの経営コンサルタントです。以下のデータを分析し、目標達成のための具体的な業務改善アドバイスを日本語で提供してください。

【現在の状況】
- 売上目標: ¥${salesGoal.toLocaleString()}
- 現在の売上: ¥${currentSales.toLocaleString()}
- 達成率: ${goalAchievementRate}%
- 総来店数: ${metrics.customersTotal}名
- 新規客: ${metrics.customersNew}名
- 既存客: ${metrics.customersExisting}名
- 平均客単価: ¥${metrics.customersTotal > 0 ? Math.round(metrics.salesTotal / metrics.customersTotal).toLocaleString() : 0}
- 新規次回予約率: ${metrics.hpbNewCount > 0 ? (((metrics.nextRes.hpbNew + metrics.nextRes.mininaiNew) / metrics.hpbNewCount)*100).toFixed(1) : 0}%

【目標値】
- 新規客目標: ${goalData.newCustomers}名
- 既存客目標: ${goalData.existingCustomers}名
- 目標客単価: ¥${goalData.unitPrice.toLocaleString()}
- 新規次回予約率目標: ${goalData.newReservationRate}%

以下の点について、具体的かつ実行可能なアドバイスを3〜5項目で提供してください：
1. 売上を向上させるための施策
2. 新規・既存客獲得のための具体的なアクション
3. 客単価向上の方法
4. 次回予約率を高めるためのトーク例や施策
5. その他、目標達成に必要な改善点

※アドバイスは箇条書きで、すぐに実行できる具体的な内容にしてください。`;

                // Call Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                const data = await response.json();

                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const advice = data.candidates[0].content.parts[0].text;
                    displayAIAdvice(advice, goalAchievementRate);
                } else {
                    throw new Error('APIからの応答が不正です');
                }

            } catch (error) {
                console.error(error);
                alert(`エラーが発生しました: ${error.message}\n\nAPIキーが正しいか確認してください。`);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function displayAIAdvice(advice, achievementRate) {
            const contentDiv = document.getElementById('ai-advice-content');
            const statusColor = achievementRate >= 100 ? 'green' : achievementRate >= 80 ? 'blue' : achievementRate >= 60 ? 'yellow' : 'red';
            const statusText = achievementRate >= 100 ? '目標達成！' : achievementRate >= 80 ? '順調です' : achievementRate >= 60 ? '要注意' : '改善が必要';

            contentDiv.innerHTML = `
                <div class="mb-4 p-4 bg-${statusColor}-50 border-l-4 border-${statusColor}-500 rounded">
                    <div class="flex items-center gap-2">
                        <span class="text-${statusColor}-800 font-bold">📊 達成率: ${achievementRate}%</span>
                        <span class="text-${statusColor}-600">- ${statusText}</span>
                    </div>
                </div>
                <div class="prose prose-sm max-w-none">
                    <div class="whitespace-pre-wrap text-sleepy-800">${advice}</div>
                </div>
                <div class="mt-4 text-xs text-sleepy-400 text-right">
                    生成日時: ${new Date().toLocaleString('ja-JP')}
                </div>
            `;
        }

        // --- DEVICE MODE TOGGLE ---
        function toggleDeviceMode() {
            const currentMode = localStorage.getItem('deviceMode') || 'mobile';
            const newMode = currentMode === 'mobile' ? 'pc' : 'mobile';

            localStorage.setItem('deviceMode', newMode);
            applyDeviceMode(newMode);
        }

        function applyDeviceMode(mode) {
            const body = document.body;
            const iconEl = document.getElementById('device-icon-lucide');
            const label = document.getElementById('device-label');

            if (mode === 'mobile') {
                body.classList.remove('pc-mode');
                body.classList.add('mobile-mode');
                if (iconEl) iconEl.setAttribute('data-lucide', 'smartphone');
                label.innerText = 'スマホ';
                enableMobileAccordions();
            } else {
                body.classList.remove('mobile-mode');
                body.classList.add('pc-mode');
                if (iconEl) iconEl.setAttribute('data-lucide', 'monitor');
                label.innerText = 'PC';
                disableMobileAccordions();
            }
            // Re-render Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function enableMobileAccordions() {
            // Wrap sections in accordions for mobile
            const overviewSection = document.getElementById('content-overview');
            const staffDashboardSection = document.getElementById('content-staff-dashboard');

            if (overviewSection && !overviewSection.dataset.accordionEnabled) {
                wrapSectionInAccordion(overviewSection, 'サマリー');
                overviewSection.dataset.accordionEnabled = 'true';
            }

            if (staffDashboardSection && !staffDashboardSection.dataset.accordionEnabled) {
                wrapSectionInAccordion(staffDashboardSection, 'マイダッシュボード');
                staffDashboardSection.dataset.accordionEnabled = 'true';
            }
        }

        function disableMobileAccordions() {
            // Remove accordion wrappers for PC mode
            document.querySelectorAll('[data-accordion-enabled]').forEach(section => {
                const accordions = section.querySelectorAll('.mobile-accordion-header');
                accordions.forEach(header => {
                    const content = header.nextElementSibling;
                    if (content && content.classList.contains('mobile-accordion-content')) {
                        content.classList.add('open');
                        content.style.maxHeight = 'none';
                    }
                });
            });
        }

        function wrapSectionInAccordion(section, title) {
            const children = Array.from(section.children);
            // 逆順で処理してDOM操作の影響を避ける
            for (let index = children.length - 1; index >= 0; index--) {
                const child = children[index];
                if (!child.classList.contains('mobile-accordion-header') && !child.classList.contains('mobile-accordion-content')) {
                    const header = document.createElement('div');
                    header.className = 'mobile-accordion-header';
                    // デフォルトで開いた状態にする（矢印は▲）
                    const sectionTitle = child.querySelector('h3')?.textContent || `セクション ${index + 1}`;
                    header.innerHTML = `<span>${sectionTitle}</span><span class="accordion-arrow">▲</span>`;

                    const content = document.createElement('div');
                    // デフォルトで開いた状態にする
                    content.className = 'mobile-accordion-content open';

                    // 元の要素を移動（クローンではなく）してイベントリスナーを保持
                    section.insertBefore(header, child);
                    section.insertBefore(content, child);
                    content.appendChild(child);

                    // クリックハンドラを設定
                    header.addEventListener('click', function() {
                        content.classList.toggle('open');
                        this.querySelector('.accordion-arrow').textContent = content.classList.contains('open') ? '▲' : '▼';
                    });
                }
            }
        }

        function initDeviceMode() {
            // スタッフ専用ページはスマホビューを優先
            if (lockedStaff) {
                applyDeviceMode('mobile');
            } else {
                const savedMode = localStorage.getItem('deviceMode') || 'mobile';
                applyDeviceMode(savedMode);
            }
        }

        // --- CALENDAR VIEW ---
        let currentCalendarDate = new Date();

        function initCalendarSelectors() {
            const storeSel = document.getElementById('calendar-store-selector');
            const staffSel = document.getElementById('calendar-staff-selector');
            if (!storeSel || !staffSel) return;

            // スタッフ専用ページの場合、所属店舗のみ表示
            if (lockedStore) {
                const storeName = lockedStore === 'ebisu' ? '恵比寿駅前店' : lockedStore === 'kadomori' ? '大阪KADOMORI店' : lockedStore === 'fukushima' ? '福島店' : lockedStore;
                storeSel.innerHTML = `<option value="${lockedStore}">${storeName}</option>`;
                storeSel.disabled = true;
                storeSel.parentElement.style.display = 'none';
                handleCalendarStoreChange();
                // スタッフ専用ページ：対象スタッフに固定し、セレクターを非表示
                if (lockedStaff) {
                    staffSel.value = lockedStaff;
                    staffSel.disabled = true;
                    staffSel.parentElement.style.display = 'none';
                }
            } else {
                // 通常ページの場合、全店舗を表示
                storeSel.innerHTML = '<option value="all">全店舗</option>';
                Object.keys(STAFF_ROSTER).forEach(storeId => {
                    const storeName = storeId === 'ebisu' ? '恵比寿駅前店' : storeId === 'kadomori' ? '大阪KADOMORI店' : storeId === 'fukushima' ? '福島店' : storeId;
                    const opt = document.createElement('option');
                    opt.value = storeId;
                    opt.text = storeName;
                    storeSel.appendChild(opt);
                });
            }
        }

        function handleCalendarStoreChange() {
            const storeSel = document.getElementById('calendar-store-selector');
            const staffSel = document.getElementById('calendar-staff-selector');
            if (!storeSel || !staffSel) return;

            const storeValue = storeSel.value;

            // スタッフ専用ページの場合、対象スタッフのみ（全スタッフ選択肢なし）
            if (lockedStaff) {
                staffSel.innerHTML = `<option value="${lockedStaff}">${lockedStaff}</option>`;
                staffSel.value = lockedStaff;
            } else if (storeValue === 'all') {
                staffSel.innerHTML = '<option value="all">全スタッフ</option>';
                // 全店舗の場合、全スタッフを表示
                Object.values(STAFF_ROSTER).flat().forEach(staffName => {
                    const opt = document.createElement('option');
                    opt.value = staffName;
                    opt.text = staffName;
                    staffSel.appendChild(opt);
                });
            } else {
                // 特定店舗の場合、その店舗のスタッフのみ表示
                staffSel.innerHTML = '<option value="all">全スタッフ</option>';
                const staffList = STAFF_ROSTER[storeValue] || [];
                staffList.forEach(staffName => {
                    const opt = document.createElement('option');
                    opt.value = staffName;
                    opt.text = staffName;
                    staffSel.appendChild(opt);
                });
            }

            renderCalendar();
        }

        function getCalendarFilteredData() {
            const storeFilter = document.getElementById('calendar-store-selector')?.value || 'all';
            const staffFilter = document.getElementById('calendar-staff-selector')?.value || 'all';
            const safeRawData = Array.isArray(rawData) ? rawData : [];

            return safeRawData.filter(d => {
                if (!d || !d.date) return false;
                if (storeFilter !== 'all' && d.store !== storeFilter) return false;
                // スタッフ名の比較は大文字小文字を区別しない
                if (staffFilter !== 'all' && d.staff?.toLowerCase() !== staffFilter.toLowerCase()) return false;
                return true;
            });
        }

        function changeCalendarMonth(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            // 月表示を更新
            document.getElementById('calendar-month-display').textContent = `${year}年${month + 1}月`;

            // カレンダーグリッドを生成
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            // 空白セル（月初の曜日まで）
            for (let i = 0; i < startingDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'min-h-20 md:min-h-24';
                grid.appendChild(emptyCell);
            }

            // 日別売上データを取得（カレンダー専用フィルター使用）
            const filteredData = getCalendarFilteredData();
            const dailySalesMap = {};

            filteredData.forEach(record => {
                const recordDate = new Date(record.date);
                if (recordDate.getFullYear() === year && recordDate.getMonth() === month) {
                    const day = recordDate.getDate();
                    if (!dailySalesMap[day]) {
                        dailySalesMap[day] = {
                            sales: 0,
                            customers: 0,
                            newCustomers: 0,
                            existingCustomers: 0,
                            product: 0
                        };
                    }
                    const totalSales = (record.sales?.cash || 0) + (record.sales?.credit || 0) + (record.sales?.qr || 0);
                    const productSales = record.sales?.product || 0;
                    const newCount = (record.customers?.newHPB || 0) + (record.customers?.newMiniNai || 0);
                    const existCount = (record.customers?.existing || 0) + (record.customers?.acquaintance || 0);

                    dailySalesMap[day].sales += totalSales;
                    dailySalesMap[day].product += productSales;
                    dailySalesMap[day].newCustomers += newCount;
                    dailySalesMap[day].existingCustomers += existCount;
                    dailySalesMap[day].customers += newCount + existCount;
                }
            });

            // 日付セルを生成
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                const dayData = dailySalesMap[day];
                const salesAmount = dayData?.sales || 0;
                const colorClass = getSalesColorClass(salesAmount);
                const dayOfWeek = new Date(year, month, day).getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                cell.className = `min-h-20 md:min-h-24 border-2 rounded-lg p-2 cursor-pointer transition-all hover:shadow-md hover:scale-105 ${colorClass}`;
                cell.onclick = () => showDayDetails(year, month, day, dayData);

                const dayNumber = document.createElement('div');
                dayNumber.className = `font-bold text-sm mb-1 ${dayOfWeek === 0 ? 'text-red-500' : dayOfWeek === 6 ? 'text-blue-500' : 'text-sleepy-800'}`;
                dayNumber.textContent = day;
                cell.appendChild(dayNumber);

                if (dayData && salesAmount > 0) {
                    const salesDiv = document.createElement('div');
                    salesDiv.className = 'text-xs text-sleepy-700 font-bold';
                    salesDiv.textContent = `¥${salesAmount.toLocaleString()}`;
                    cell.appendChild(salesDiv);

                    const custDiv = document.createElement('div');
                    custDiv.className = 'text-xs text-sleepy-500 mt-1 hidden md:block';
                    custDiv.textContent = `${dayData.customers}名`;
                    cell.appendChild(custDiv);
                } else {
                    const noData = document.createElement('div');
                    noData.className = 'text-xs text-gray-400';
                    noData.textContent = '-';
                    cell.appendChild(noData);
                }

                grid.appendChild(cell);
            }

            // 月間サマリーを更新
            updateCalendarSummary(dailySalesMap, daysInMonth);
        }

        function getSalesColorClass(sales) {
            if (!sales || sales === 0) return 'bg-gray-50 border-gray-200';
            if (sales < 50000) return 'bg-blue-50 border-blue-200';
            if (sales < 100000) return 'bg-green-50 border-green-200';
            if (sales < 150000) return 'bg-yellow-50 border-yellow-200';
            if (sales < 200000) return 'bg-orange-50 border-orange-200';
            return 'bg-red-50 border-red-200';
        }

        function showDayDetails(year, month, day, dayData) {
            const detailsSection = document.getElementById('calendar-day-details');
            const titleEl = document.getElementById('calendar-day-title');
            const statsEl = document.getElementById('calendar-day-stats');

            if (!dayData || dayData.sales === 0) {
                detailsSection.classList.add('hidden');
                return;
            }

            detailsSection.classList.remove('hidden');
            titleEl.textContent = `${month + 1}月${day}日の詳細`;

            statsEl.innerHTML = `
                <div class="bg-sleepy-50 border border-sleepy-200 rounded-lg p-3">
                    <p class="text-xs text-sleepy-500 mb-1">施術売上</p>
                    <p class="text-lg font-bold text-sleepy-800">¥${dayData.sales.toLocaleString()}</p>
                </div>
                <div class="bg-sleepy-50 border border-sleepy-200 rounded-lg p-3">
                    <p class="text-xs text-sleepy-500 mb-1">物販売上</p>
                    <p class="text-lg font-bold text-sleepy-800">¥${dayData.product.toLocaleString()}</p>
                </div>
                <div class="bg-sleepy-50 border border-sleepy-200 rounded-lg p-3">
                    <p class="text-xs text-sleepy-500 mb-1">総来店数</p>
                    <p class="text-lg font-bold text-sleepy-800">${dayData.customers}名</p>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-xs text-blue-600 mb-1">新規</p>
                    <p class="text-lg font-bold text-blue-800">${dayData.newCustomers}名</p>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                    <p class="text-xs text-green-600 mb-1">既存</p>
                    <p class="text-lg font-bold text-green-800">${dayData.existingCustomers}名</p>
                </div>
                <div class="bg-sleepy-100 border border-sleepy-300 rounded-lg p-3">
                    <p class="text-xs text-sleepy-500 mb-1">客単価</p>
                    <p class="text-lg font-bold text-sleepy-800">¥${dayData.customers > 0 ? Math.round((dayData.sales + dayData.product) / dayData.customers).toLocaleString() : 0}</p>
                </div>
            `;

            // スクロールして詳細を表示
            detailsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function updateCalendarSummary(dailySalesMap, daysInMonth) {
            const days = Object.keys(dailySalesMap).filter(d => dailySalesMap[d].sales > 0).length;
            const totalSales = Object.values(dailySalesMap).reduce((sum, d) => sum + d.sales + d.product, 0);
            const avgSales = days > 0 ? Math.round(totalSales / days) : 0;
            const maxSales = Math.max(...Object.values(dailySalesMap).map(d => d.sales + d.product), 0);

            document.getElementById('calendar-summary-days').innerHTML = `${days}<span class="text-sm font-normal ml-1">日</span>`;
            document.getElementById('calendar-summary-sales').textContent = `¥${totalSales.toLocaleString()}`;
            document.getElementById('calendar-summary-avg').textContent = `¥${avgSales.toLocaleString()}`;
            document.getElementById('calendar-summary-max').textContent = `¥${maxSales.toLocaleString()}`;
        }

        // --- DARK MODE TOGGLE ---
        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');

            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('darkMode', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('darkMode', 'dark');
            }
            updateDarkModeUI();
            updateChartsForDarkMode();
        }

        function updateDarkModeUI() {
            const isDark = document.documentElement.classList.contains('dark');
            const iconEl = document.getElementById('dark-mode-icon-lucide');
            const label = document.getElementById('dark-mode-label');
            const btn = document.getElementById('dark-mode-toggle');

            if (isDark) {
                if (iconEl) iconEl.setAttribute('data-lucide', 'sun');
                if (label) label.innerText = 'ライト';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
            } else {
                if (iconEl) iconEl.setAttribute('data-lucide', 'moon');
                if (label) label.innerText = 'ダーク';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            }
            // Re-render Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function updateChartsForDarkMode() {
            const isDark = document.documentElement.classList.contains('dark');

            // Chart.js グローバルデフォルトを更新 - 新しいカラーパレット
            if (window.Chart) {
                const textColor = isDark ? '#e8e6e1' : '#334e68';
                const gridColor = isDark ? '#3a3e42' : '#e8e6e1';

                Chart.defaults.color = textColor;
                Chart.defaults.borderColor = gridColor;

                // 既存のチャートを更新
                Object.values(charts).forEach(chart => {
                    if (chart && chart.options) {
                        // スケールの色を更新
                        if (chart.options.scales) {
                            Object.values(chart.options.scales).forEach(scale => {
                                if (scale.ticks) scale.ticks.color = textColor;
                                if (scale.grid) scale.grid.color = gridColor;
                            });
                        }
                        // 凡例の色を更新
                        if (chart.options.plugins && chart.options.plugins.legend && chart.options.plugins.legend.labels) {
                            chart.options.plugins.legend.labels.color = textColor;
                        }
                        chart.update();
                    }
                });
            }
        }

        function initDarkMode() {
            const savedMode = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedMode === 'dark' || (!savedMode && prefersDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateDarkModeUI();
        }

        // ページを離れるときに自動保存
        window.addEventListener('beforeunload', (e) => {
            if (autoSaveTimeout) {
                // 保留中の自動保存があれば即座に実行
                clearTimeout(autoSaveTimeout);
                autoSaveToSpreadsheet();
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            let authenticated = true;
            try {
                // パスワード認証チェック
                authenticated = await checkAuthentication();
            } catch (error) {
                console.error('認証チェックエラー:', error);
                // エラーが発生しても処理を継続（認証スキップ）
                authenticated = true;
            }

            if (!authenticated) {
                // 認証が必要な場合は、ローディングを非表示にしてパスワードダイアログを表示
                hideLoading();
                // ユーザーが正しいパスワードを入力するとページがリロードされる
                return;
            }

            initDarkMode(); // Initialize dark mode
            initDeviceMode(); // Initialize device mode
            initCharts();
            try { initCalendarSelectors(); } catch (e) { console.error('initCalendarSelectors エラー:', e); }
            await loadData(); // データ読み込みを待機
            calculateGoal(); // Initialize goal calculation

            // スプレッドシートから設定を読み込み（パスワード、スタッフ名簿、Gemini APIキー等）
            try {
                await loadSettingsFromSpreadsheet();
                await loadStaffPasswordsFromSpreadsheet();
                console.log('設定とパスワードを読み込みました');
                // 設定読み込み後にUIを更新
                updateSettingsList();
            } catch (e) {
                console.error('設定読み込みエラー:', e);
            }

            // スプレッドシートから目標データを自動読み込み
            try {
                await autoLoadFromSpreadsheet();
            } catch (e) {
                console.error('目標データ読み込みエラー:', e);
            }

            // ダークモードでチャートを初期化した後に更新
            setTimeout(() => updateChartsForDarkMode(), 100);

            // サブスク月セレクター初期化
            const subMonthSel = document.getElementById('sub-month-selector');
            if (subMonthSel) {
                const now = new Date();
                subMonthSel.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            }
        });

        // ========================================
        // 会員・回数券管理
        // ========================================

        const SUB_STORAGE_KEY = 'sleepy_subscription_data';
        const TICKET_STORAGE_KEY = 'sleepy_ticket_data';

        // --- サブタブ切り替え ---
        function switchMembershipSubTab(subTabId) {
            document.getElementById('membership-content-subscription').classList.toggle('hidden', subTabId !== 'subscription');
            document.getElementById('membership-content-tickets').classList.toggle('hidden', subTabId !== 'tickets');
            document.querySelectorAll('.membership-subtab-btn').forEach(btn => {
                btn.classList.remove('bg-accent-700', 'text-white');
                btn.classList.add('bg-surface-200', 'text-surface-600');
            });
            const active = document.getElementById(`membership-subtab-${subTabId}`);
            active.classList.remove('bg-surface-200', 'text-surface-600');
            active.classList.add('bg-accent-700', 'text-white');
        }

        // ========================================
        // サブスク会員管理
        // ========================================

        function loadSubscriptionData() {
            try { return JSON.parse(localStorage.getItem(SUB_STORAGE_KEY)) || {}; } catch { return {}; }
        }
        function saveSubscriptionStorage(data) {
            localStorage.setItem(SUB_STORAGE_KEY, JSON.stringify(data));
        }

        function openSubscriptionEditModal(yearMonth, storeId) {
            const modal = document.getElementById('subscription-modal');
            const now = new Date();
            const monthInput = document.getElementById('sub-edit-month');

            if (yearMonth) {
                // 既存データ編集
                const [y, m] = yearMonth.split('/');
                monthInput.value = `${y}-${m.padStart(2, '0')}`;
                const data = loadSubscriptionData();
                const record = data[yearMonth]?.[storeId] || {};
                document.getElementById('sub-edit-store').value = storeId || 'ebisu';
                document.getElementById('sub-edit-start').value = record.startCount || 0;
                document.getElementById('sub-edit-new').value = record.newMembers || 0;
                document.getElementById('sub-edit-cancelled').value = record.cancelled || 0;
                document.getElementById('sub-edit-fee').value = record.monthlyFee || 9800;
            } else {
                monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const selectedStore = document.getElementById('sub-store-selector').value;
                document.getElementById('sub-edit-store').value = selectedStore === 'all' ? 'ebisu' : selectedStore;
                document.getElementById('sub-edit-start').value = 0;
                document.getElementById('sub-edit-new').value = 0;
                document.getElementById('sub-edit-cancelled').value = 0;
                document.getElementById('sub-edit-fee').value = 9800;

                // 前月データから月初会員数を自動セット
                const prevMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const prevKey = `${prevMonth.getFullYear()}/${prevMonth.getMonth() + 1}`;
                const store = document.getElementById('sub-edit-store').value;
                const data = loadSubscriptionData();
                const prev = data[prevKey]?.[store];
                if (prev) {
                    document.getElementById('sub-edit-start').value = (prev.startCount || 0) + (prev.newMembers || 0) - (prev.cancelled || 0);
                }
            }
            modal.classList.remove('hidden');
        }

        function closeSubscriptionModal() {
            document.getElementById('subscription-modal').classList.add('hidden');
        }

        function saveSubscriptionData() {
            const monthVal = document.getElementById('sub-edit-month').value;
            if (!monthVal) { alert('対象月を選択してください'); return; }
            const [y, m] = monthVal.split('-');
            const yearMonth = `${y}/${parseInt(m)}`;
            const store = document.getElementById('sub-edit-store').value;

            const data = loadSubscriptionData();
            if (!data[yearMonth]) data[yearMonth] = {};
            data[yearMonth][store] = {
                startCount: parseInt(document.getElementById('sub-edit-start').value) || 0,
                newMembers: parseInt(document.getElementById('sub-edit-new').value) || 0,
                cancelled: parseInt(document.getElementById('sub-edit-cancelled').value) || 0,
                monthlyFee: parseInt(document.getElementById('sub-edit-fee').value) || 0
            };

            saveSubscriptionStorage(data);
            closeSubscriptionModal();
            renderSubscriptionDashboard();
        }

        function deleteSubscriptionRecord(yearMonth, store) {
            if (!confirm(`${yearMonth} ${getStoreNameById(store)} のデータを削除しますか？`)) return;
            const data = loadSubscriptionData();
            if (data[yearMonth]) {
                delete data[yearMonth][store];
                if (Object.keys(data[yearMonth]).length === 0) delete data[yearMonth];
            }
            saveSubscriptionStorage(data);
            renderSubscriptionDashboard();
        }

        function getStoreNameById(id) {
            const map = { ebisu: '恵比寿駅前店', kadomori: '大阪KADOMORI店', fukushima: '福島店' };
            return map[id] || id;
        }

        function renderSubscriptionDashboard() {
            const data = loadSubscriptionData();
            const storeFilter = document.getElementById('sub-store-selector')?.value || 'all';
            const monthVal = document.getElementById('sub-month-selector')?.value || '';

            // 月別ソートされたキーを取得
            const allMonths = Object.keys(data).sort((a, b) => {
                const [ay, am] = a.split('/').map(Number);
                const [by, bm] = b.split('/').map(Number);
                return (ay * 12 + am) - (by * 12 + bm);
            });

            // 選択月のサマリー計算
            let selectedYM = '';
            if (monthVal) {
                const [y, m] = monthVal.split('-');
                selectedYM = `${y}/${parseInt(m)}`;
            }

            let currentMembers = 0, newMembers = 0, cancelled = 0, revenue = 0;
            const stores = storeFilter === 'all' ? ['ebisu', 'kadomori', 'fukushima'] : [storeFilter];

            if (selectedYM && data[selectedYM]) {
                stores.forEach(s => {
                    const r = data[selectedYM]?.[s];
                    if (r) {
                        const endCount = (r.startCount || 0) + (r.newMembers || 0) - (r.cancelled || 0);
                        currentMembers += endCount;
                        newMembers += r.newMembers || 0;
                        cancelled += r.cancelled || 0;
                        revenue += endCount * (r.monthlyFee || 0);
                    }
                });
            }

            const netChange = newMembers - cancelled;
            document.getElementById('sub-current-members').textContent = currentMembers;
            document.getElementById('sub-new-members').textContent = newMembers;
            document.getElementById('sub-cancelled-members').textContent = cancelled;
            const netEl = document.getElementById('sub-net-change');
            netEl.textContent = (netChange >= 0 ? '+' : '') + netChange;
            netEl.className = `text-3xl font-bold ${netChange >= 0 ? 'text-sage-500' : 'text-rose-500'}`;
            document.getElementById('sub-monthly-revenue').textContent = `¥${revenue.toLocaleString()}`;

            // 平均継続率（直近6ヶ月）
            let retentionRates = [];
            const recentMonths = allMonths.slice(-6);
            recentMonths.forEach(ym => {
                stores.forEach(s => {
                    const r = data[ym]?.[s];
                    if (r && r.startCount > 0) {
                        const retained = r.startCount - (r.cancelled || 0);
                        retentionRates.push(retained / r.startCount);
                    }
                });
            });
            const avgRetention = retentionRates.length > 0 ? (retentionRates.reduce((a, b) => a + b, 0) / retentionRates.length * 100).toFixed(1) : '--';
            document.getElementById('sub-retention-rate').textContent = `${avgRetention}%`;

            // 月別推移テーブル
            const tbody = document.getElementById('sub-trend-table-body');
            let rows = '';
            allMonths.forEach(ym => {
                stores.forEach(s => {
                    const r = data[ym]?.[s];
                    if (!r) return;
                    const endCount = (r.startCount || 0) + (r.newMembers || 0) - (r.cancelled || 0);
                    const change = (r.newMembers || 0) - (r.cancelled || 0);
                    const retention = r.startCount > 0 ? ((r.startCount - (r.cancelled || 0)) / r.startCount * 100).toFixed(1) : '--';
                    const monthRevenue = endCount * (r.monthlyFee || 0);
                    rows += `<tr class="hover:bg-surface-50">
                        <td class="py-2 px-3 text-left font-medium">${ym}</td>
                        <td class="py-2 px-3 text-center">${storeFilter === 'all' ? getStoreNameById(s) + '<br>' : ''}${(r.startCount || 0).toLocaleString()}</td>
                        <td class="py-2 px-3 text-center text-sage-600 font-medium">+${(r.newMembers || 0)}</td>
                        <td class="py-2 px-3 text-center text-rose-600 font-medium">-${(r.cancelled || 0)}</td>
                        <td class="py-2 px-3 text-center font-bold">${endCount.toLocaleString()}</td>
                        <td class="py-2 px-3 text-center font-medium ${change >= 0 ? 'text-sage-600' : 'text-rose-600'}">${change >= 0 ? '+' : ''}${change}</td>
                        <td class="py-2 px-3 text-center">${retention}%</td>
                        <td class="py-2 px-3 text-center">¥${(r.monthlyFee || 0).toLocaleString()}</td>
                        <td class="py-2 px-3 text-center font-bold">¥${monthRevenue.toLocaleString()}</td>
                        <td class="py-2 px-3 text-center">
                            <button onclick="openSubscriptionEditModal('${ym}', '${s}')" class="text-accent-600 hover:text-accent-800 text-xs mr-2">編集</button>
                            <button onclick="deleteSubscriptionRecord('${ym}', '${s}')" class="text-rose-500 hover:text-rose-700 text-xs">削除</button>
                        </td>
                    </tr>`;
                });
            });
            tbody.innerHTML = rows || '<tr><td colspan="10" class="py-8 text-center text-surface-400">データがありません。「月次データ登録」から入力してください。</td></tr>';
        }

        // ========================================
        // 回数券管理
        // ========================================

        function loadTicketData() {
            try { return JSON.parse(localStorage.getItem(TICKET_STORAGE_KEY)) || []; } catch { return []; }
        }
        function saveTicketStorage(data) {
            localStorage.setItem(TICKET_STORAGE_KEY, JSON.stringify(data));
        }

        function openTicketModal(ticketId) {
            const modal = document.getElementById('ticket-modal');
            const titleEl = document.getElementById('ticket-modal-title');
            // デフォルト有効期限: 購入日から6ヶ月後
            const defaultExpiry = new Date();
            defaultExpiry.setMonth(defaultExpiry.getMonth() + 6);

            if (ticketId) {
                titleEl.textContent = '回数券編集';
                const tickets = loadTicketData();
                const ticket = tickets.find(t => t.id === ticketId);
                if (ticket) {
                    document.getElementById('ticket-edit-id').value = ticket.id;
                    document.getElementById('ticket-edit-customer').value = ticket.customerName;
                    document.getElementById('ticket-edit-store').value = ticket.store;
                    document.getElementById('ticket-edit-name').value = ticket.ticketName;
                    document.getElementById('ticket-edit-date').value = ticket.purchaseDate;
                    document.getElementById('ticket-edit-total').value = ticket.totalCount;
                    document.getElementById('ticket-edit-used').value = ticket.usedCount;
                    document.getElementById('ticket-edit-price').value = ticket.price;
                    document.getElementById('ticket-edit-expiry').value = ticket.expiryDate || '';
                }
            } else {
                titleEl.textContent = '回数券登録';
                document.getElementById('ticket-edit-id').value = '';
                document.getElementById('ticket-edit-customer').value = '';
                document.getElementById('ticket-edit-store').value = document.getElementById('ticket-store-selector').value === 'all' ? 'ebisu' : document.getElementById('ticket-store-selector').value;
                document.getElementById('ticket-edit-name').value = '';
                document.getElementById('ticket-edit-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('ticket-edit-total').value = 5;
                document.getElementById('ticket-edit-used').value = 0;
                document.getElementById('ticket-edit-price').value = '';
                document.getElementById('ticket-edit-expiry').value = defaultExpiry.toISOString().split('T')[0];
            }
            modal.classList.remove('hidden');
        }

        function closeTicketModal() {
            document.getElementById('ticket-modal').classList.add('hidden');
        }

        function saveTicket() {
            const customerName = document.getElementById('ticket-edit-customer').value.trim();
            if (!customerName) { alert('顧客名を入力してください'); return; }
            const ticketName = document.getElementById('ticket-edit-name').value.trim();
            if (!ticketName) { alert('券種名を入力してください'); return; }

            const tickets = loadTicketData();
            const editId = document.getElementById('ticket-edit-id').value;
            const totalCount = parseInt(document.getElementById('ticket-edit-total').value) || 1;
            const usedCount = Math.min(parseInt(document.getElementById('ticket-edit-used').value) || 0, totalCount);
            let status = 'active';
            if (usedCount >= totalCount) status = 'completed';

            const expiryDate = document.getElementById('ticket-edit-expiry').value || '';
            // 有効期限切れチェック
            if (expiryDate && new Date(expiryDate) < new Date() && status === 'active') {
                status = 'expired';
            }

            const ticketData = {
                id: editId || `T-${Date.now()}`,
                customerName,
                store: document.getElementById('ticket-edit-store').value,
                ticketName,
                purchaseDate: document.getElementById('ticket-edit-date').value,
                totalCount,
                usedCount,
                price: parseInt(document.getElementById('ticket-edit-price').value) || 0,
                expiryDate,
                status
            };

            if (editId) {
                const idx = tickets.findIndex(t => t.id === editId);
                if (idx >= 0) tickets[idx] = ticketData;
            } else {
                tickets.push(ticketData);
            }

            saveTicketStorage(tickets);
            closeTicketModal();
            renderTicketDashboard();
        }

        function useTicket(ticketId) {
            const tickets = loadTicketData();
            const ticket = tickets.find(t => t.id === ticketId);
            if (ticket && ticket.usedCount < ticket.totalCount) {
                ticket.usedCount++;
                if (ticket.usedCount >= ticket.totalCount) ticket.status = 'completed';
                saveTicketStorage(tickets);
                renderTicketDashboard();
            }
        }

        function deleteTicket(ticketId) {
            if (!confirm('この回数券を削除しますか？')) return;
            let tickets = loadTicketData();
            tickets = tickets.filter(t => t.id !== ticketId);
            saveTicketStorage(tickets);
            renderTicketDashboard();
        }

        function renderTicketDashboard() {
            const tickets = loadTicketData();
            const storeFilter = document.getElementById('ticket-store-selector')?.value || 'all';
            const statusFilter = document.getElementById('ticket-status-filter')?.value || 'active';

            let filtered = tickets;
            if (storeFilter !== 'all') filtered = filtered.filter(t => t.store === storeFilter);
            if (statusFilter !== 'all') filtered = filtered.filter(t => t.status === statusFilter);

            // サマリー計算（有効券のみ）
            const activeTickets = tickets.filter(t => t.status === 'active' && (storeFilter === 'all' || t.store === storeFilter));
            const totalRemaining = activeTickets.reduce((sum, t) => sum + (t.totalCount - t.usedCount), 0);
            const totalUsed = activeTickets.reduce((sum, t) => sum + t.usedCount, 0);
            const totalAll = activeTickets.reduce((sum, t) => sum + t.totalCount, 0);
            const remainingAmount = activeTickets.reduce((sum, t) => {
                const perUse = t.totalCount > 0 ? t.price / t.totalCount : 0;
                return sum + perUse * (t.totalCount - t.usedCount);
            }, 0);
            const usageRate = totalAll > 0 ? (totalUsed / totalAll * 100).toFixed(1) : 0;

            document.getElementById('ticket-active-count').textContent = activeTickets.length;
            document.getElementById('ticket-remaining-count').textContent = totalRemaining;
            document.getElementById('ticket-remaining-amount').textContent = `¥${Math.round(remainingAmount).toLocaleString()}`;
            document.getElementById('ticket-usage-rate').textContent = `${usageRate}%`;

            // テーブルレンダリング
            const tbody = document.getElementById('ticket-table-body');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="py-8 text-center text-surface-400">回数券データがありません。「回数券を登録」から入力してください。</td></tr>';
                return;
            }

            // 購入日降順でソート
            filtered.sort((a, b) => (b.purchaseDate || '').localeCompare(a.purchaseDate || ''));

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let rows = '';
            filtered.forEach(t => {
                const remaining = t.totalCount - t.usedCount;
                const perUse = t.totalCount > 0 ? t.price / t.totalCount : 0;
                const remainAmt = Math.round(perUse * remaining);

                // 有効期限判定
                const expiry = t.expiryDate ? new Date(t.expiryDate) : null;
                const daysUntilExpiry = expiry ? Math.ceil((expiry - today) / (1000 * 60 * 60 * 24)) : null;
                const isExpiringSoon = daysUntilExpiry !== null && daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
                const isExpired = daysUntilExpiry !== null && daysUntilExpiry < 0;

                let effectiveStatus = t.status;
                if (isExpired && t.status === 'active') effectiveStatus = 'expired';

                const statusLabel = effectiveStatus === 'active' ? '<span class="px-2 py-1 bg-sage-500 text-white text-xs rounded-full">利用中</span>'
                    : effectiveStatus === 'completed' ? '<span class="px-2 py-1 bg-surface-400 text-white text-xs rounded-full">消化済</span>'
                    : '<span class="px-2 py-1 bg-rose-500 text-white text-xs rounded-full">期限切れ</span>';
                const progressPct = t.totalCount > 0 ? (t.usedCount / t.totalCount * 100) : 0;

                let expiryDisplay = '-';
                if (t.expiryDate) {
                    if (isExpired) {
                        expiryDisplay = `<span class="text-rose-600 font-bold">${t.expiryDate}<br><span class="text-[10px]">期限切れ</span></span>`;
                    } else if (isExpiringSoon) {
                        expiryDisplay = `<span class="text-orange-600 font-bold">${t.expiryDate}<br><span class="text-[10px]">残${daysUntilExpiry}日</span></span>`;
                    } else {
                        expiryDisplay = `<span class="text-surface-600">${t.expiryDate}</span>`;
                    }
                }

                rows += `<tr class="hover:bg-surface-50 ${isExpiringSoon ? 'bg-orange-50' : ''} ${isExpired && t.status === 'active' ? 'bg-rose-50' : ''}">
                    <td class="py-2 px-3 font-medium">${t.customerName}</td>
                    <td class="py-2 px-3 text-xs text-surface-500">${getStoreNameById(t.store)}</td>
                    <td class="py-2 px-3">${t.ticketName}</td>
                    <td class="py-2 px-3 text-center text-xs">${t.purchaseDate || '-'}</td>
                    <td class="py-2 px-3 text-center">${t.totalCount}</td>
                    <td class="py-2 px-3 text-center">
                        <div class="flex items-center justify-center gap-1">
                            ${t.usedCount}
                            <div class="w-12 h-1.5 bg-surface-200 rounded-full overflow-hidden">
                                <div class="h-full bg-primary-500 rounded-full" style="width:${progressPct}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="py-2 px-3 text-center font-bold ${remaining > 0 ? 'text-accent-700' : 'text-surface-400'}">${remaining}</td>
                    <td class="py-2 px-3 text-right">¥${t.price.toLocaleString()}</td>
                    <td class="py-2 px-3 text-right font-medium ${remaining > 0 ? 'text-rose-600' : 'text-surface-400'}">¥${remainAmt.toLocaleString()}</td>
                    <td class="py-2 px-3 text-center text-xs">${expiryDisplay}</td>
                    <td class="py-2 px-3 text-center">${statusLabel}</td>
                    <td class="py-2 px-3 text-center whitespace-nowrap">
                        ${effectiveStatus === 'active' ? `<button onclick="useTicket('${t.id}')" class="text-sage-600 hover:text-sage-800 text-xs mr-1" title="1回使用">+1使用</button>` : ''}
                        <button onclick="openTicketModal('${t.id}')" class="text-accent-600 hover:text-accent-800 text-xs mr-1">編集</button>
                        <button onclick="deleteTicket('${t.id}')" class="text-rose-500 hover:text-rose-700 text-xs">削除</button>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = rows;
        }

        // ========================================
        // ダミーデータ投入（初回のみ）
        // ========================================

        function initDemoData() {
            // サブスクデータ
            if (Object.keys(loadSubscriptionData()).length === 0) {
                const now = new Date();
                const subData = {};
                for (let i = 5; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const ym = `${d.getFullYear()}/${d.getMonth() + 1}`;
                    subData[ym] = {
                        ebisu: { startCount: 32 + i * 2, newMembers: 5 + Math.floor(Math.random() * 4), cancelled: 1 + Math.floor(Math.random() * 3), monthlyFee: 9800 },
                        kadomori: { startCount: 24 + i, newMembers: 3 + Math.floor(Math.random() * 3), cancelled: 1 + Math.floor(Math.random() * 2), monthlyFee: 9800 },
                        fukushima: { startCount: 15 + Math.floor(i / 2), newMembers: 2 + Math.floor(Math.random() * 3), cancelled: Math.floor(Math.random() * 2), monthlyFee: 8800 }
                    };
                }
                saveSubscriptionStorage(subData);
            }

            // 回数券データ
            if (loadTicketData().length === 0) {
                const today = new Date();
                const fmt = d => d.toISOString().split('T')[0];
                const addDays = (d, n) => { const r = new Date(d); r.setDate(r.getDate() + n); return r; };
                const addMonths = (d, n) => { const r = new Date(d); r.setMonth(r.getMonth() + n); return r; };

                const demoTickets = [
                    { id: 'T-D001', customerName: '佐藤 美咲', store: 'ebisu', ticketName: '整体5回コース', purchaseDate: fmt(addDays(today, -90)), totalCount: 5, usedCount: 3, price: 45000, expiryDate: fmt(addMonths(today, 3)), status: 'active' },
                    { id: 'T-D002', customerName: '鈴木 健太', store: 'ebisu', ticketName: '整体10回コース', purchaseDate: fmt(addDays(today, -150)), totalCount: 10, usedCount: 7, price: 80000, expiryDate: fmt(addDays(today, 15)), status: 'active' },
                    { id: 'T-D003', customerName: '田中 愛', store: 'kadomori', ticketName: '睡眠改善5回コース', purchaseDate: fmt(addDays(today, -60)), totalCount: 5, usedCount: 1, price: 50000, expiryDate: fmt(addMonths(today, 4)), status: 'active' },
                    { id: 'T-D004', customerName: '高橋 翔', store: 'kadomori', ticketName: '整体5回コース', purchaseDate: fmt(addDays(today, -200)), totalCount: 5, usedCount: 5, price: 45000, expiryDate: fmt(addDays(today, -20)), status: 'completed' },
                    { id: 'T-D005', customerName: '渡辺 結衣', store: 'fukushima', ticketName: '整体10回コース', purchaseDate: fmt(addDays(today, -120)), totalCount: 10, usedCount: 4, price: 80000, expiryDate: fmt(addDays(today, 25)), status: 'active' },
                    { id: 'T-D006', customerName: '伊藤 大輝', store: 'ebisu', ticketName: '睡眠改善5回コース', purchaseDate: fmt(addDays(today, -30)), totalCount: 5, usedCount: 0, price: 50000, expiryDate: fmt(addMonths(today, 5)), status: 'active' },
                    { id: 'T-D007', customerName: '山本 さくら', store: 'fukushima', ticketName: '整体5回コース', purchaseDate: fmt(addDays(today, -180)), totalCount: 5, usedCount: 3, price: 45000, expiryDate: fmt(addDays(today, -5)), status: 'active' },
                    { id: 'T-D008', customerName: '中村 蓮', store: 'kadomori', ticketName: '整体10回コース', purchaseDate: fmt(addDays(today, -45)), totalCount: 10, usedCount: 2, price: 80000, expiryDate: fmt(addMonths(today, 5)), status: 'active' },
                ];
                saveTicketStorage(demoTickets);
            }
        }

        // ページ読み込み時にダミーデータを初期化
        initDemoData();

        // ========================================
        // 回数券 有効期限ポップアップ通知
        // ========================================

        function checkTicketExpiryNotifications() {
            const tickets = loadTicketData();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const alerts = [];
            tickets.forEach(t => {
                if (t.status !== 'active' || !t.expiryDate) return;
                const expiry = new Date(t.expiryDate);
                const daysLeft = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                if (daysLeft < 0) {
                    alerts.push({ type: 'expired', ticket: t, days: Math.abs(daysLeft) });
                } else if (daysLeft <= 30) {
                    alerts.push({ type: 'warning', ticket: t, days: daysLeft });
                }
            });

            if (alerts.length === 0) return;

            // ソート: 期限切れ優先、残り日数少ない順
            alerts.sort((a, b) => {
                if (a.type !== b.type) return a.type === 'expired' ? -1 : 1;
                return a.days - b.days;
            });

            // 既存のポップアップがあれば削除
            const existing = document.getElementById('ticket-expiry-popup');
            if (existing) existing.remove();

            // ポップアップHTML
            let itemsHtml = alerts.slice(0, 5).map(a => {
                const icon = a.type === 'expired' ? '🔴' : '🟡';
                const label = a.type === 'expired'
                    ? `<span class="text-rose-600 font-bold">${a.days}日超過</span>`
                    : `<span class="text-orange-600 font-bold">残り${a.days}日</span>`;
                return `<div class="flex items-start gap-2 py-2 border-b border-surface-100 last:border-0">
                    <span class="text-sm mt-0.5">${icon}</span>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-accent-800 truncate">${a.ticket.customerName}</p>
                        <p class="text-xs text-surface-500">${a.ticket.ticketName} / ${getStoreNameById(a.ticket.store)}</p>
                    </div>
                    <div class="text-right shrink-0">${label}</div>
                </div>`;
            }).join('');

            if (alerts.length > 5) {
                itemsHtml += `<p class="text-xs text-surface-400 text-center pt-2">他 ${alerts.length - 5}件</p>`;
            }

            const popup = document.createElement('div');
            popup.id = 'ticket-expiry-popup';
            popup.className = 'fixed bottom-4 right-4 z-[9998] w-80 max-w-[calc(100vw-2rem)]';
            popup.style.animation = 'slideUp 0.4s ease-out';
            popup.innerHTML = `
                <div class="bg-white rounded-2xl shadow-soft-lg border border-surface-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-accent-700 to-accent-800 px-4 py-3 flex items-center justify-between">
                        <div class="flex items-center gap-2 text-white">
                            <i data-lucide="bell-ring" class="w-4 h-4"></i>
                            <span class="text-sm font-bold">回数券 期限アラート</span>
                            <span class="bg-white bg-opacity-20 text-white text-xs px-2 py-0.5 rounded-full">${alerts.length}件</span>
                        </div>
                        <button onclick="document.getElementById('ticket-expiry-popup').remove()" class="text-white hover:text-surface-200 transition-colors">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="px-4 py-2 max-h-64 overflow-y-auto">
                        ${itemsHtml}
                    </div>
                    <div class="px-4 py-2 bg-surface-50 border-t border-surface-100">
                        <button onclick="switchTab('membership'); switchMembershipSubTab('tickets'); document.getElementById('ticket-expiry-popup').remove();" class="text-xs text-accent-700 hover:text-accent-900 font-medium w-full text-center py-1">
                            回数券管理を開く →
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // スプラッシュ画面終了後に通知チェック
        setTimeout(() => checkTicketExpiryNotifications(), 3000);
    </script>
</body>
</html>
